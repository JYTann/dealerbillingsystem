<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Billing Management System</title>
    <!-- Firebase App & Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;
    --bg-color: #f8f9fa;
    --text-color: #333;
    --card-bg: white;
    --sidebar-bg: var(--primary-color);
    --border-color: #ddd;
}

        [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --card-bg: #2d2d2d;
    --primary-color: #1e3a5f;
    --sidebar-bg: #1e3a5f;
    --border-color: #444;
    --light-color: #333;
}
        
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
}

        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
            border-radius: 10px;
        }
        
        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
        }
        
        .sidebar a:hover {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .sidebar a.active {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .content {
            margin-left: 220px;
            padding: 20px;
        }
        
        .page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .page.active {
            display: block;
        }
        
        .bill-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .bill-table th, .bill-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .bill-table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .bill-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .bill-table tr:hover {
            background-color: #ddd;
        }
        
        .action-btn {
            margin: 0 5px;
            cursor: pointer;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .profit {
            color: #27ae60;
        }
        
        .loss {
            color: #e74c3c;
        }
        
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .chart-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    position: relative; /* 添加相对定位 */
    height: 400px; /* 固定高度 */
    width: 100%; /* 确保宽度100% */
}
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        .customer-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .customer-actions {
            margin-top: 10px;
        }
        
        /* Inventory specific styles */
        .low-stock {
            background-color: #ffe6e6;
        }
        
        .out-of-stock {
            background-color: #ffcccc;
        }
        
        .in-stock {
            background-color: #e6ffe6;
        }
        
        .stock-alert {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .alert-low {
            background-color: #ffcccc;
            color: #cc0000;
        }
        
        .alert-out {
            background-color: #ff9999;
            color: #990000;
        }
        
        .inventory-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .inventory-actions {
            margin-top: 10px;
        }
        
        /* Editable breakdown styles */
        .breakdown-table td:last-child {
            text-align: center;
            width: 100px;
        }
        
        .breakdown-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .editable-field {
            border: 1px dashed transparent;
            padding: 3px 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .editable-field:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .editable-field:focus {
            outline: none;
            border: 1px solid #3498db;
            background-color: #fff;
        }
        
        /* Progress tracking styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-recorded {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .progress-filter {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .progress-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .progress-card h5 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-update {
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .progress-update p {
            margin: 0;
            font-size: 14px;
        }
        
        .progress-update .date {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                width: 180px;
            }
            
            .content {
                margin-left: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }
            
            .content {
                margin-left: 0;
            }
            
            .dashboard-stats {
                flex-direction: column;
            }
            
            .progress-summary {
                flex-direction: column;
            }
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: rgba(255, 255, 255, 0.95);
            border-left: 4px solid;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .toast-success {
            border-left-color: #28a745;
        }
        
        .toast-error {
            border-left-color: #dc3545;
        }
        
        .toast-info {
            border-left-color: #17a2b8;
        }

        /* Map link styles */
        .map-link {
            color: #3498db;
            text-decoration: none;
        }
        
        .map-link:hover {
            text-decoration: underline;
        }

        /* 在现有样式末尾添加以下内容 */

/* 登录页面增强样式 */
.auth-container {
    max-width: 440px;
    margin: 80px auto;
    padding: 40px 30px;
    background: linear-gradient(145deg, var(--card-bg), color-mix(in srgb, var(--card-bg) 90%, var(--text-color)));
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.auth-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
}

.welcome-message h3 {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 5px;
}

.welcome-message p {
    color: var(--text-color);
    opacity: 0.8;
}

.social-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.divider-with-text {
    display: flex;
    align-items: center;
    text-align: center;
    color: var(--text-color);
    opacity: 0.6;
}

.divider-with-text::before,
.divider-with-text::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.divider-with-text span {
    padding: 0 15px;
    font-size: 14px;
}

.input-group-text {
    background-color: var(--light-color);
    border-color: var(--border-color);
    color: var(--text-color);
}

.form-control:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    transform: translateY(-2px);
}

/* 注册页面样式 */
#register-section {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 加载状态 */
.loading-spinner {
    display: none;
    text-align: center;
    margin: 20px 0;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
    color: var(--secondary-color);
}

/* 成功/错误消息动画 */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.5s ease-in-out;
}

/* 浮动标签效果 */
.floating-label {
    position: relative;
    margin-bottom: 1.5rem;
}

.floating-label input {
    padding-top: 1.5rem;
    padding-bottom: 0.5rem;
}

.floating-label label {
    position: absolute;
    top: 0;
    left: 12px;
    padding: 0.375rem 0;
    font-size: 0.875rem;
    color: var(--text-color);
    opacity: 0.7;
    transition: all 0.2s ease;
    pointer-events: none;
}

.floating-label input:focus + label,
.floating-label input:not(:placeholder-shown) + label {
    top: -10px;
    left: 8px;
    font-size: 0.75rem;
    opacity: 1;
    color: var(--secondary-color);
}

/* 响应式调整 */
@media (max-width: 576px) {
    .auth-container {
        margin: 40px auto;
        padding: 30px 20px;
        border-radius: 10px;
    }
    
    .social-login .d-flex {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .social-btn {
        margin: 3px;
    }
}

        .summary-card, .stat-card, .form-section, .chart-container, .page, 
.progress-filter, .progress-card, .progress-update, .toast {
    background-color: var(--card-bg);
    transition: background-color 0.3s;
}

.sidebar {
    background-color: var(--sidebar-bg);
}

.bill-table th {
    background-color: var(--primary-color);
}

.bill-table th, .bill-table td {
    border-color: var(--border-color);
}

.bill-table tr:nth-child(even) {
    background-color: color-mix(in srgb, var(--card-bg) 90%, var(--text-color));
}

/* 在现有样式之后添加主题切换按钮样式 */
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.theme-toggle i {
    font-size: 20px;
    color: var(--text-color);
}

/* Customer search results */
.customer-search-results {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.customer-result-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.customer-result-item:hover {
    background-color: #f5f5f5;
}

.customer-result-item:last-child {
    border-bottom: none;
}

/* Manual records table */
.manual-record-row.revenue {
    background-color: rgba(39, 174, 96, 0.1);
}

.manual-record-row.expense {
    background-color: rgba(231, 76, 60, 0.1);
}

/* 在响应式调整之前添加 */
@media (max-width: 768px) {
    .theme-toggle {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
    }
    
    .customer-search-results {
        position: relative;
        margin-top: 5px;
    }
}
        /* Template and Batch Operations Styles */
.template-card, .batch-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.template-card:hover, .batch-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.comment-item {
    transition: all 0.3s ease;
}

.comment-item:hover {
    background-color: var(--light-color);
}

.attachment-thumbnail {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
}

.attachment-thumbnail:hover {
    opacity: 0.8;
}

/* Batch operations checkbox */
.batch-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Comment type badges */
.badge-general {
    background-color: #6c757d;
}

.badge-followup {
    background-color: #17a2b8;
}

.badge-issue {
    background-color: #dc3545;
}

.badge-reminder {
    background-color: #ffc107;
    color: #000;
}

/* Attachment preview modal */
#attachmentPreviewModal .modal-xl {
    max-width: 90%;
}

/* Template actions */
.template-actions {
    opacity: 0;
    transition: opacity 0.3s;
}

tr:hover .template-actions {
    opacity: 1;
}

/* Responsive adjustments for new features */
@media (max-width: 768px) {
    .template-actions {
        opacity: 1;
    }
    
    .attachment-thumbnail {
        height: 120px;
    }
}

        /* Enhanced Registration Styles */
.floating-label-group {
    position: relative;
    margin-bottom: 1.5rem;
}

.floating-label-group label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.floating-label-group .form-text {
    font-size: 0.85rem;
    margin-top: 0.25rem;
    color: #6c757d;
}

.password-strength-meter {
    margin-top: 0.5rem;
}

.password-strength-meter .progress {
    border-radius: 4px;
}

.password-strength-meter small {
    font-size: 0.8rem;
    display: block;
    margin-top: 0.25rem;
}

.form-check-label a {
    color: var(--secondary-color);
    text-decoration: none;
}

.form-check-label a:hover {
    text-decoration: underline;
}

.social-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.terms-link {
    color: var(--secondary-color);
    text-decoration: none;
}

.terms-link:hover {
    text-decoration: underline;
    color: var(--primary-color);
}

.system-status {
    font-size: 0.85rem;
}

/* Form validation styles */
.text-success {
    color: #28a745 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.is-valid {
    border-color: #28a745 !important;
}

.is-invalid {
    border-color: #dc3545 !important;
}

/* Modal styles */
.modal-content {
    background-color: var(--card-bg);
    color: var(--text-color);
}

.modal-header {
    border-bottom-color: var(--border-color);
}

.modal-footer {
    border-top-color: var(--border-color);
}

/* Responsive adjustments for registration */
@media (max-width: 576px) {
    .floating-label-group {
        margin-bottom: 1rem;
    }
    
    .social-login .d-flex {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .social-btn {
        margin: 3px;
    }
}
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
<div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
</div>
    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Login Section -->
    <div id="auth-container" class="auth-container">
        <div class="logo">
            <h1>Dealer<span>BILL</span></h1>
            <p>Billing Management System</p>
        </div>
        
        <!-- 在现有的 login-section 内部，修改如下： -->

<div id="login-section">
    <!-- 添加欢迎信息 -->
    <div class="welcome-message text-center mb-4">
        <h3>Welcome Back!</h3>
        <p class="text-muted">Sign in to manage your billing system</p>
    </div>
    
    <!-- 社交登录选项 -->
    <div class="social-login mb-3">
        <p class="text-center mb-2">Or sign in with</p>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-primary social-btn">
                <i class="fab fa-facebook"></i>
            </button>
            <button class="btn btn-outline-danger social-btn">
                <i class="fab fa-google"></i>
            </button>
            <button class="btn btn-outline-dark social-btn">
                <i class="fab fa-github"></i>
            </button>
        </div>
    </div>
    
    <!-- 分隔线 -->
    <div class="divider-with-text my-4">
        <span>or continue with email</span>
    </div>
    
    <div class="mb-3">
        <label for="email" class="form-label">
            <i class="fas fa-envelope me-2"></i>Email Address
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="email" class="form-control" id="email" placeholder="your.email@example.com">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="password" class="form-label">
            <i class="fas fa-lock me-2"></i>Password
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-key"></i></span>
            <input type="password" class="form-control" id="password" placeholder="Enter your password">
            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>
    
    <!-- 记住我和忘记密码 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="rememberMe">
            <label class="form-check-label" for="rememberMe">
                Remember me
            </label>
        </div>
        <a href="#" id="forgot-password" class="text-decoration-none">Forgot password?</a>
    </div>
    
    <div id="login-error" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
        Invalid email or password. Please try again.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <button id="login-btn" class="btn btn-primary w-100 mb-3 py-2">
        <i class="fas fa-sign-in-alt me-2"></i>Sign In
    </button>
    
    <button id="google-login-btn" class="btn btn-outline-danger w-100 mb-3 py-2">
        <i class="fab fa-google me-2"></i> Continue with Google
    </button>
    
    <div class="text-center mt-3">
        <p>Don't have an account? 
            <a href="#" id="show-register" class="text-decoration-none fw-bold">Sign up now</a>
        </p>
    </div>
    
    <!-- 系统状态 -->
    <div class="system-status mt-4 pt-3 border-top text-center">
        <small class="text-muted">
            <i class="fas fa-shield-alt me-1"></i>Secure login • 
            <i class="fas fa-bolt ms-2 me-1"></i>24/7 Access
        </small>
    </div>
</div>

<!-- 添加忘记密码模态框 -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <div class="mb-3">
                    <label for="reset-email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="reset-email" placeholder="your.email@example.com">
                </div>
                <div id="reset-message" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="send-reset-link">Send Reset Link</button>
            </div>
        </div>
    </div>
</div>
        
        <!-- Enhanced Registration Section -->
<div id="register-section" style="display: none;">
    <div class="welcome-message text-center mb-4">
        <h3>Create Account</h3>
        <p class="text-muted">Join DealerBILL to streamline your billing management</p>
    </div>
    
    <!-- Social Sign-up Options -->
    <div class="social-login mb-3">
        <p class="text-center mb-2">Or sign up with</p>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-primary social-btn" onclick="socialSignUp('facebook')">
                <i class="fab fa-facebook"></i>
            </button>
            <button class="btn btn-outline-danger social-btn" onclick="socialSignUp('google')">
                <i class="fab fa-google"></i>
            </button>
            <button class="btn btn-outline-dark social-btn" onclick="socialSignUp('github')">
                <i class="fab fa-github"></i>
            </button>
        </div>
    </div>
    
    <!-- Divider -->
    <div class="divider-with-text my-4">
        <span>or register with email</span>
    </div>
    
    <!-- Registration Form -->
    <form id="enhanced-register-form">
        <!-- Email -->
        <div class="mb-3 floating-label-group">
            <label for="register-email" class="form-label">
                <i class="fas fa-envelope me-2"></i>Email Address *
            </label>
            <input type="email" class="form-control" id="register-email" 
                   placeholder="your.email@example.com" required>
            <div id="email-feedback" class="form-text">
                We'll send a verification email to this address
            </div>
        </div>
        
        <!-- Password -->
        <div class="mb-3 floating-label-group">
            <label for="register-password" class="form-label">
                <i class="fas fa-lock me-2"></i>Password *
            </label>
            <div class="input-group">
                <input type="password" class="form-control" id="register-password" 
                       placeholder="Create a strong password" required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-register-password">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="password-strength" class="password-strength-meter mt-2"></div>
            <div id="password-feedback" class="form-text">
                Minimum 8 characters with letters, numbers, and symbols
            </div>
        </div>
        
        <!-- Confirm Password -->
        <div class="mb-3 floating-label-group">
            <label for="confirm-password" class="form-label">
                <i class="fas fa-lock me-2"></i>Confirm Password *
            </label>
            <div class="input-group">
                <input type="password" class="form-control" id="confirm-password" 
                       placeholder="Re-enter your password" required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="password-match-feedback" class="form-text"></div>
        </div>
        
        <!-- Company/Business Name -->
        <div class="mb-3 floating-label-group">
            <label for="register-company" class="form-label">
                <i class="fas fa-building me-2"></i>Company/Business Name *
            </label>
            <input type="text" class="form-control" id="register-company" 
                   placeholder="Your company name" required>
            <div id="company-feedback" class="form-text">
                This will appear on your bills and invoices
            </div>
        </div>
        
        <!-- Phone Number -->
        <div class="mb-3 floating-label-group">
            <label for="register-phone" class="form-label">
                <i class="fas fa-phone me-2"></i>Phone Number
            </label>
            <input type="tel" class="form-control" id="register-phone" 
                   placeholder="+60 12-345 6789">
            <div id="phone-feedback" class="form-text">
                Optional - for important notifications
            </div>
        </div>
        
        <!-- Address -->
        <div class="mb-3 floating-label-group">
            <label for="register-address" class="form-label">
                <i class="fas fa-map-marker-alt me-2"></i>Business Address
            </label>
            <textarea class="form-control" id="register-address" 
                      rows="2" placeholder="Your business address"></textarea>
            <div id="address-feedback" class="form-text">
                Optional - for invoices and shipping
            </div>
        </div>
        
        <!-- Business Type -->
        <div class="mb-3 floating-label-group">
            <label for="register-business-type" class="form-label">
                <i class="fas fa-briefcase me-2"></i>Business Type
            </label>
            <select class="form-select" id="register-business-type">
                <option value="">Select business type</option>
                <option value="retail">Retail</option>
                <option value="wholesale">Wholesale</option>
                <option value="manufacturing">Manufacturing</option>
                <option value="services">Services</option>
                <option value="ecommerce">E-commerce</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <!-- Terms and Conditions -->
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="register-terms" required>
                <label class="form-check-label" for="register-terms">
                    I agree to the 
                    <a href="#" class="terms-link" data-bs-toggle="modal" data-bs-target="#termsModal">Terms & Conditions</a> 
                    and 
                    <a href="#" class="terms-link" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a> *
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="register-newsletter" checked>
                <label class="form-check-label" for="register-newsletter">
                    Subscribe to newsletter for updates and tips
                </label>
            </div>
        </div>
        
        <!-- Error/Success Messages -->
        <div id="register-error" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
            <span id="register-error-text"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div id="register-success" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
            <span id="register-success-text"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Submit Button -->
        <button id="register-btn" type="submit" class="btn btn-primary w-100 mb-3 py-2">
            <i class="fas fa-user-plus me-2"></i>Create Account
        </button>
        
        <div class="text-center mt-3">
            <p>Already have an account? 
                <a href="#" id="show-login" class="text-decoration-none fw-bold">Sign in here</a>
            </p>
        </div>
        
        <!-- Security Note -->
        <div class="system-status mt-4 pt-3 border-top text-center">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>Secure registration • 
                <i class="fas fa-lock ms-2 me-1"></i>Encrypted data
            </small>
        </div>
    </form>
</div>

<!-- Terms & Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms & Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <h6>1. Acceptance of Terms</h6>
                <p>By creating an account on DealerBILL, you agree to these Terms and Conditions...</p>
                <!-- Add full terms content here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <h6>1. Information We Collect</h6>
                <p>We collect information you provide when registering, using our services...</p>
                <!-- Add full privacy policy content here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Main Application -->
    <div id="main-container" class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" style="width: 200px;">
            <div class="logo">
                <h4>Dealer<span>BILL</span></h4>
            </div>
            <a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="#" data-page="periodic-bills"><i class="fas fa-calendar-week"></i> Periodic Bills</a>
            <a href="#" data-page="individual-bills"><i class="fas fa-file-invoice"></i> Individual Bills</a>
            <a href="#" data-page="monthly-bills"><i class="fas fa-calendar-alt"></i> Monthly Bills</a>
            <a href="#" data-page="yearly-bills"><i class="fas fa-calendar"></i> Yearly Bills</a>
            <a href="#" data-page="profit-loss"><i class="fas fa-chart-line"></i> Profit & Loss</a>
            <a href="#" data-page="customer-management"><i class="fas fa-users"></i> Customer Management</a>
            <a href="#" data-page="templates"><i class="fas fa-copy"></i> Bill Templates</a>
            <a href="#" data-page="batch-operations"><i class="fas fa-layer-group"></i> Batch Operations</a>
            <a href="#" data-page="inventory-tracking"><i class="fas fa-box"></i> Inventory Tracking</a>
            <!-- Add progress tracking page -->
            <a href="#" data-page="progress-tracking"><i class="fas fa-clipboard-check"></i> Progress Tracking</a>
            <a href="#" data-page="more"><i class="fas fa-ellipsis-h"></i> More</a>
            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <h2>Dashboard</h2>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <p class="stat-value" id="total-revenue">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Total Expenses</h5>
                        <p class="stat-value" id="total-expenses">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Net Profit</h5>
                        <p class="stat-value profit" id="net-profit">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Inventory Value</h5>
                        <p class="stat-value" id="inventory-value">RM 0.00</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Monthly Performance</h5>
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Recent Bills</h5>
                            <table class="bill-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bill No</th>
                                        <th>Amount (RM)</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-bills">
                                    <!-- Recent bills will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Low Stock Alerts</h5>
                            <div id="low-stock-alerts">
                                <!-- Low stock alerts will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Periodic Bills Page -->
            <div id="periodic-bills" class="page">
                <h2>Periodic Bills</h2>
                <div class="form-section">
                    <h5>Add New Bill</h5>
                    <form id="periodic-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="periodic-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="periodic-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodic-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="periodic-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="periodic-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="periodic-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="periodic-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Bill Items</h5>
                        <button class="btn btn-success" id="generate-periodic-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="periodic-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="periodic-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Individual Bills Page -->
            <div id="individual-bills" class="page">
                <h2>Individual Bills</h2>
                <div class="form-section">
                    <h5>Add New Individual Bill</h5>
                    <form id="individual-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="individual-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="individual-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="individual-description" required>
                                </div>
                            </div>
                        </div>
                        <!-- Enhanced customer selection -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-name" class="form-label">Customer Selection</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="individual-customer-name" 
                                               placeholder="Enter customer name or select from existing customers" 
                                               list="customer-suggestions">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-customer">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <datalist id="customer-suggestions">
                                            <!-- Customer options will be populated dynamically -->
                                        </datalist>
                                    </div>
                                    <div id="customer-search-results" class="customer-search-results" style="display: none;">
                                        <!-- Search results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-address" class="form-label">Customer Address</label>
                                    <input type="text" class="form-control" id="individual-customer-address" 
                                           placeholder="Address will auto-fill or enter manually">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="individual-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="individual-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="individual-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Individual Bill Items</h5>
                        <button class="btn btn-success" id="generate-individual-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Customer</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="individual-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="individual-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Monthly Bills Page -->
            <div id="monthly-bills" class="page">
                <h2>Monthly Bills</h2>
                <div class="form-section">
                    <h5>Add New Monthly Bill</h5>
                    <form id="monthly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="monthly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="monthly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="monthly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="monthly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="monthly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="monthly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="monthly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Monthly Bill Items</h5>
                        <button class="btn btn-success" id="generate-monthly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="monthly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Yearly Bills Page -->
            <div id="yearly-bills" class="page">
                <h2>Yearly Bills</h2>
                <div class="form-section">
                    <h5>Add New Yearly Bill</h5>
                    <form id="yearly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="yearly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="yearly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="yearly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="yearly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="yearly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="yearly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="yearly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Yearly Bill Items</h5>
                        <button class="btn btn-success" id="generate-yearly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="yearly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="yearly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Profit & Loss Page -->
            <div id="profit-loss" class="page">
                <h2>Profit & Loss Analysis</h2>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Revenue</h5>
                            <p class="summary-value profit" id="pl-revenue">RM 0.00</p>
                            <p><small id="revenue-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Expenses</h5>
                            <p class="summary-value loss" id="pl-expenses">RM 0.00</p>
                            <p><small id="expenses-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Revenue vs Expenses (Last 6 Months)</h5>
                    <canvas id="profitLossChart"></canvas>
                </div>
                
                <!-- Manual Revenue/Expense Entry Section -->
                <div class="form-section">
                    <h5>Manual Revenue/Expense Entry</h5>
                    <form id="manual-revenue-expense-form">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-type" class="form-label">Type</label>
                                    <select class="form-select" id="manual-type" required>
                                        <option value="revenue">Revenue</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-category" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="manual-category" 
                                           placeholder="e.g., Product Sales, Rent, Salary" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-amount" class="form-label">Amount (RM)</label>
                                    <input type="number" class="form-control" id="manual-amount" 
                                           step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="manual-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="manual-description" 
                                           placeholder="Detailed description">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="manual-date" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Record</button>
                    </form>
                </div>
                
                <!-- Manual Records List -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Manual Revenue & Expenses</h5>
                        <button class="btn btn-success" id="generate-manual-records-pdf">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manual-records-list">
                            <!-- Manual records will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Total Revenue:</td>
                                <td id="manual-revenue-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Total Expenses:</td>
                                <td id="manual-expense-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Net:</td>
                                <td id="manual-net-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Detailed Breakdown</h5>
                        <button class="btn btn-primary" id="add-breakdown-item">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <table class="bill-table breakdown-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount (RM)</th>
                                <th>Percentage</th>
                                <th>Trend</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pl-breakdown">
                            <!-- Profit/Loss breakdown will be populated here -->
                        </tbody>
                    </table>
                    <div class="breakdown-actions">
                        <button class="btn btn-success" id="save-breakdown">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" id="reset-breakdown">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>Calculate Profit/Loss</h5>
                    <form id="profit-loss-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="revenue" class="form-label">Total Revenue (RM)</label>
                                    <input type="number" class="form-control" id="revenue" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenses" class="form-label">Total Expenses (RM)</label>
                                    <input type="number" class="form-control" id="expenses" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary w-100">Calculate</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert" id="profit-loss-result" style="display: none;">
                                    <h5>Result:</h5>
                                    <p id="result-text"></p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customer Management Page -->
            <div id="customer-management" class="page">
                <h2>Customer Management</h2>
                
                <div class="form-section">
                    <h5>Add New Customer</h5>
                    <form id="customer-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-name" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customer-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customer-email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="customer-phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="customer-address">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Customer</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <h5>Customer List</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Search customers..." id="customer-search">
                        <button class="btn btn-outline-secondary" type="button" id="customer-search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div id="customers-list">
                        <!-- Customers will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Inventory Tracking Page -->
            <div id="inventory-tracking" class="page">
                <h2>Inventory Tracking</h2>
                
                <div class="form-section">
                    <h5>Add New Product</h5>
                    <form id="inventory-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-category" class="form-label">Category</label>
                                    <select class="form-select" id="product-category">
                                        <option value="">Select Category</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Food">Food</option>
                                        <option value="Books">Books</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="product-quantity" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-low-stock" class="form-label">Low Stock Threshold</label>
                                    <input type="number" class="form-control" id="product-low-stock" required min="1" value="10">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-cost" class="form-label">Cost Price (RM)</label>
                                    <input type="number" class="form-control" id="product-cost" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">Selling Price (RM)</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-supplier" class="form-label">Supplier</label>
                                    <input type="text" class="form-control" id="product-supplier">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="product-description" class="form-label">Description</label>
                                    <textarea class="form-control" id="product-description" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Product</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Inventory List</h5>
                        <div>
                            <button class="btn btn-success" id="generate-inventory-pdf">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button class="btn btn-info" id="export-inventory-csv">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn btn-warning" id="add-bill-address">
                                <i class="fas fa-map-marker-alt"></i> Add Bill Address
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search products..." id="inventory-search">
                                <button class="btn btn-outline-secondary" type="button" id="inventory-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-category-filter">
                                <option value="">All Categories</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Food">Food</option>
                                <option value="Books">Books</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-stock-filter">
                                <option value="">All Stock Status</option>
                                <option value="low">Low Stock</option>
                                <option value="out">Out of Stock</option>
                                <option value="in">In Stock</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Cost Price (RM)</th>
                                    <th>Selling Price (RM)</th>
                                    <th>Stock Value (RM)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list">
                                <!-- Inventory items will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" style="text-align: right; font-weight: bold;">Total Inventory Value:</td>
                                    <td id="inventory-total-value" style="font-weight: bold;">RM 0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking Page -->
            <div id="progress-tracking" class="page">
                <h2>Progress Tracking</h2>
                
                <div class="progress-summary">
                    <div class="progress-card">
                        <h5>Total Bills</h5>
                        <p class="value" id="total-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Recorded</h5>
                        <p class="value" id="recorded-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Paid</h5>
                        <p class="value" id="paid-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Overdue</h5>
                        <p class="value" id="overdue-bills-count">0</p>
                    </div>
                </div>
                
                <div class="progress-filter">
                    <h5>Filter Bills</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-status-filter" class="form-label">Status</label>
                                <select class="form-select" id="progress-status-filter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="recorded">Recorded</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-from" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="progress-date-from">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-to" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="progress-date-to">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" id="apply-progress-filter">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Bill Progress</h5>
                        <div>
                            <button class="btn btn-success" id="generate-progress-report">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </button>
                            <button class="btn btn-info" id="add-progress-update">
                                <i class="fas fa-plus"></i> Add Daily Update
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill No</th>
                                    <th>Description</th>
                                    <th>Customer</th>
                                    <th>Amount (RM)</th>
                                    <th>Status</th>
                                    <th>Address Map</th>
                                    <th>Last Updated</th>
                                    <th>Progress Updates</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="progress-bills-list">
                                <!-- Progress bills will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Progress Update Modal -->
                <div class="modal fade" id="progressUpdateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Progress Update</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="progress-update-form">
                                    <input type="hidden" id="progress-bill-id">
                                    <div class="mb-3">
                                        <label for="progress-status" class="form-label">Status</label>
                                        <select class="form-select" id="progress-status" required>
                                            <option value="pending">Pending</option>
                                            <option value="recorded">Recorded</option>
                                            <option value="paid">Paid</option>
                                            <option value="overdue">Overdue</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="progress-notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="progress-notes" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-progress-update">Save Update</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill Address Modal -->
                <div class="modal fade" id="billAddressModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Bill Address</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="bill-address-form">
                                    <input type="hidden" id="address-bill-id">
                                    <div class="mb-3">
                                        <label for="bill-address" class="form-label">Bill Address</label>
                                        <input type="text" class="form-control" id="bill-address" placeholder="Enter full address">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Google Maps Preview</label>
                                        <div id="map-preview" style="height: 200px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                            <p class="text-muted">Enter an address to see a preview</p>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-bill-address">Save Address</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill Templates Page -->
<div id="templates" class="page">
    <h2>Bill Templates</h2>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Save Current Bill as Template</h5>
            <button class="btn btn-primary" id="save-current-template">
                <i class="fas fa-save"></i> Save Current Bill
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="template-name" class="form-label">Template Name</label>
                    <input type="text" class="form-control" id="template-name" placeholder="e.g., Monthly Service Bill">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="template-type" class="form-label">Bill Type</label>
                    <select class="form-select" id="template-type">
                        <option value="individual">Individual Bill</option>
                        <option value="periodic">Periodic Bill</option>
                        <option value="monthly">Monthly Bill</option>
                        <option value="yearly">Yearly Bill</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="template-description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="template-description" rows="2" placeholder="Describe this template..."></textarea>
        </div>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Saved Templates</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" id="refresh-templates">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-danger" id="delete-selected-templates">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="bill-table">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="select-all-templates">
                        </th>
                        <th>Template Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Items Count</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="templates-list">
                    <!-- Templates will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Batch Operations Page -->
<div id="batch-operations" class="page">
    <h2>Batch Operations</h2>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-copy fa-3x mb-3 text-primary"></i>
                    <h5>Quick Copy Bills</h5>
                    <p class="text-muted">Duplicate existing bills with one click</p>
                    <button class="btn btn-primary mt-2" onclick="showQuickCopyModal()">
                        <i class="fas fa-clone"></i> Copy Bills
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-trash-alt fa-3x mb-3 text-primary"></i>
                    <h5>Bulk Delete</h5>
                    <p class="text-muted">Delete multiple bills at once</p>
                    <button class="btn btn-danger mt-2" onclick="showBulkDeleteModal()">
                        <i class="fas fa-trash"></i> Delete Bills
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-file-export fa-3x mb-3 text-primary"></i>
                    <h5>Bulk Export</h5>
                    <p class="text-muted">Export multiple bills to PDF/CSV</p>
                    <button class="btn btn-success mt-2" onclick="showBulkExportModal()">
                        <i class="fas fa-download"></i> Export Bills
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-section">
        <h5>Batch Operations Panel</h5>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="batch-bill-type" class="form-label">Bill Type</label>
                <select class="form-select" id="batch-bill-type">
                    <option value="all">All Types</option>
                    <option value="individual">Individual Bills</option>
                    <option value="periodic">Periodic Bills</option>
                    <option value="monthly">Monthly Bills</option>
                    <option value="yearly">Yearly Bills</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="batch-date-from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="batch-date-from">
            </div>
            <div class="col-md-4">
                <label for="batch-date-to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="batch-date-to">
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all-batch">
                <label class="form-check-label" for="select-all-batch">
                    Select all bills
                </label>
            </div>
            <div>
                <span id="selected-count" class="badge bg-primary me-2">0 selected</span>
                <button class="btn btn-outline-secondary" id="apply-batch-filter">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="bill-table">
                <thead>
                    <tr>
                        <th width="50">Select</th>
                        <th>Date</th>
                        <th>Bill No</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount (RM)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="batch-bills-list">
                    <!-- Bills for batch operations -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-success" id="batch-copy">
                <i class="fas fa-copy"></i> Copy Selected
            </button>
            <button class="btn btn-primary" id="batch-export-pdf">
                <i class="fas fa-file-pdf"></i> Export as PDF
            </button>
            <button class="btn btn-info" id="batch-export-csv">
                <i class="fas fa-file-csv"></i> Export as CSV
            </button>
            <button class="btn btn-danger" id="batch-delete">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>
</div>

<!-- Attachments Page -->
<div id="attachments" class="page">
    <h2>Bill Attachments</h2>
    
    <div class="form-section">
        <h5>Upload Attachment</h5>
        <form id="attachment-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="attachment-bill" class="form-label">Select Bill</label>
                        <select class="form-select" id="attachment-bill" required>
                            <option value="">-- Select a bill --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="attachment-type" class="form-label">Attachment Type</label>
                        <select class="form-select" id="attachment-type">
                            <option value="receipt">Receipt</option>
                            <option value="invoice">Invoice</option>
                            <option value="contract">Contract</option>
                            <option value="photo">Photo</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="attachment-file" class="form-label">File</label>
                <input type="file" class="form-control" id="attachment-file" 
                       accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx" required>
                <div class="form-text">Supported files: Images (JPG, PNG), PDF, Word, Excel</div>
            </div>
            
            <div class="mb-3">
                <label for="attachment-description" class="form-label">Description (Optional)</label>
                <input type="text" class="form-control" id="attachment-description" 
                       placeholder="e.g., Customer signature, Delivery proof">
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload Attachment
            </button>
        </form>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Attachments</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" id="filter-all-attachments">
                    All
                </button>
                <button class="btn btn-outline-secondary" id="filter-images">
                    <i class="fas fa-image"></i> Images
                </button>
                <button class="btn btn-outline-secondary" id="filter-documents">
                    <i class="fas fa-file"></i> Documents
                </button>
            </div>
        </div>
        
        <div class="row" id="attachments-grid">
            <!-- Attachments will be displayed here -->
        </div>
    </div>
</div>

<!-- Comments Page -->
<div id="comments" class="page">
    <h2>Bill Comments</h2>
    
    <div class="form-section">
        <h5>Add Comment</h5>
        <form id="comment-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="comment-bill" class="form-label">Select Bill</label>
                        <select class="form-select" id="comment-bill" required>
                            <option value="">-- Select a bill --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="comment-type" class="form-label">Comment Type</label>
                        <select class="form-select" id="comment-type">
                            <option value="general">General Note</option>
                            <option value="followup">Follow-up</option>
                            <option value="issue">Issue</option>
                            <option value="reminder">Reminder</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="comment-text" class="form-label">Comment</label>
                <textarea class="form-control" id="comment-text" rows="3" 
                          placeholder="Enter your comment here..." required></textarea>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="comment-important">
                    <label class="form-check-label" for="comment-important">
                        Mark as important
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-comment"></i> Add Comment
                </button>
            </div>
        </form>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Recent Comments</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary active" id="filter-all-comments">
                    All Comments
                </button>
                <button class="btn btn-outline-secondary" id="filter-important-comments">
                    Important Only
                </button>
                <button class="btn btn-outline-secondary" id="filter-my-comments">
                    My Comments
                </button>
            </div>
        </div>
        
        <div id="comments-list">
            <!-- Comments will be loaded here -->
        </div>
    </div>
</div>

<!-- Modals for new features -->
<div class="modal fade" id="quickCopyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Copy Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="copy-source-bill" class="form-label">Select Bill to Copy</label>
                    <select class="form-select" id="copy-source-bill">
                        <option value="">-- Select a bill --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="copy-changes" class="form-label">Make Changes (Optional)</label>
                    <textarea class="form-control" id="copy-changes" rows="3" 
                              placeholder="Enter any changes you want to make to the copied bill..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This will create an exact copy of the selected bill with a new bill number.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-copy-bill">Copy Bill</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachment-preview-title">Attachment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="attachment-preview-content">
                    <!-- Preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="download-attachment" download>
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

            <!-- More Page -->
            <div id="more" class="page">
                <h2>Additional Features</h2>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-3x mb-3 text-primary"></i>
                                <h5>Customer Management</h5>
                                <p>Manage your customer database and track interactions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-box fa-3x mb-3 text-primary"></i>
                                <h5>Inventory Tracking</h5>
                                <p>Monitor stock levels and receive low inventory alerts</p>
                                <button class="btn btn-outline-primary" data-page="inventory-tracking">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3 text-primary"></i>
                                <h5>Advanced Reports</h5>
                                <p>Generate detailed reports and analytics</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cog fa-3x mb-3 text-primary"></i>
                                <h5>Settings</h5>
                                <p>Customize system preferences and user permissions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <!-- 添加到 More 页面中 -->
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-copy fa-3x mb-3 text-primary"></i>
            <h5>Bill Templates</h5>
            <p>Save and manage frequently used bill formats</p>
            <button class="btn btn-outline-primary" data-page="templates">Manage Templates</button>
        </div>
    </div>
</div>
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-file-upload fa-3x mb-3 text-primary"></i>
            <h5>Attachments</h5>
            <p>Upload images and documents to bills</p>
            <button class="btn btn-outline-primary" data-page="attachments">Manage Attachments</button>
        </div>
    </div>
</div>
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-comments fa-3x mb-3 text-primary"></i>
            <h5>Comments</h5>
            <p>Add notes and comments to bills</p>
            <button class="btn btn-outline-primary" data-page="comments">View Comments</button>
        </div>
    </div>
</div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-bell fa-3x mb-3 text-primary"></i>
                                <h5>Notifications</h5>
                                <p>Set up alerts for important events and deadlines</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Data Backup</h5>
                                <p>Automatically backup your data to the cloud</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>System Settings</h5>
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currency" class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option selected>RM (Malaysian Ringgit)</option>
                                        <option>USD (US Dollar)</option>
                                        <option>EUR (Euro)</option>
                                        <option>GBP (British Pound)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language">
                                        <option selected>English</option>
                                        <option>Malay</option>
                                        <option>Chinese</option>
                                        <option>Tamil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date-format" class="form-label">Date Format</label>
                                    <select class="form-select" id="date-format">
                                        <option selected>DD/MM/YYYY</option>
                                        <option>MM/DD/YYYY</option>
                                        <option>YYYY-MM-DD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax-rate" class="form-label">Tax Rate (%)</label>
                                    <input type="number" class="form-control" id="tax-rate" value="6.0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    <label class="form-check-label" for="email-notifications">Enable Email Notifications</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and App Initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-q5IfxsoF-Ud7YTw2jwHwrzXQuDmxey8",
            authDomain: "dealer-billing-system.firebaseapp.com",
            projectId: "dealer-billing-system",
            storageBucket: "dealer-billing-system.firebasestorage.app",
            messagingSenderId: "646495235869",
            appId: "1:646495235869:web:8a495e5f34e04b8cc0fbf4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        let performanceChartInstance = null;
        let profitLossChartInstance = null;
        
        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const mainContainer = document.getElementById('main-container');
        const loginBtn = document.getElementById('login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const registerSection = document.getElementById('register-section');
        const loginSection = document.getElementById('login-section');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const togglePassword = document.getElementById('togglePassword');
const forgotPassword = document.getElementById('forgot-password');
const rememberMe = document.getElementById('rememberMe');
const sendResetLink = document.getElementById('send-reset-link');
const resetEmail = document.getElementById('reset-email');
const resetMessage = document.getElementById('reset-message');
        
        // Navigation
        let navLinks = document.querySelectorAll('.sidebar a[data-page]');
        let pages = document.querySelectorAll('.page');
        
        // Bill Forms
        const periodicForm = document.getElementById('periodic-bill-form');
        const individualForm = document.getElementById('individual-bill-form');
        const monthlyForm = document.getElementById('monthly-bill-form');
        const yearlyForm = document.getElementById('yearly-bill-form');
        const profitLossForm = document.getElementById('profit-loss-form');
        const customerForm = document.getElementById('customer-form');
        const inventoryForm = document.getElementById('inventory-form');
        const manualRevenueExpenseForm = document.getElementById('manual-revenue-expense-form');
        
        // Bill Lists
        const periodicBillsList = document.getElementById('periodic-bills-list');
        const individualBillsList = document.getElementById('individual-bills-list');
        const monthlyBillsList = document.getElementById('monthly-bills-list');
        const yearlyBillsList = document.getElementById('yearly-bills-list');
        const customersList = document.getElementById('customers-list');
        const inventoryList = document.getElementById('inventory-list');
        const progressBillsList = document.getElementById('progress-bills-list');
        const manualRecordsList = document.getElementById('manual-records-list');
        
        // Grand Totals
        const periodicGrandTotal = document.getElementById('periodic-grand-total');
        const individualGrandTotal = document.getElementById('individual-grand-total');
        const monthlyGrandTotal = document.getElementById('monthly-grand-total');
        const yearlyGrandTotal = document.getElementById('yearly-grand-total');
        const inventoryTotalValue = document.getElementById('inventory-total-value');
        const manualRevenueTotal = document.getElementById('manual-revenue-total');
        const manualExpenseTotal = document.getElementById('manual-expense-total');
        const manualNetTotal = document.getElementById('manual-net-total');
        
        // PDF Generation Buttons
        const generatePeriodicPdf = document.getElementById('generate-periodic-pdf');
        const generateIndividualPdf = document.getElementById('generate-individual-pdf');
        const generateMonthlyPdf = document.getElementById('generate-monthly-pdf');
        const generateYearlyPdf = document.getElementById('generate-yearly-pdf');
        const generateInventoryPdf = document.getElementById('generate-inventory-pdf');
        const exportInventoryCsv = document.getElementById('export-inventory-csv');
        const generateProgressReport = document.getElementById('generate-progress-report');
        const generateManualRecordsPdf = document.getElementById('generate-manual-records-pdf');
        
        // Progress Tracking Elements
        const totalBillsCount = document.getElementById('total-bills-count');
        const recordedBillsCount = document.getElementById('recorded-bills-count');
        const paidBillsCount = document.getElementById('paid-bills-count');
        const overdueBillsCount = document.getElementById('overdue-bills-count');
        const applyProgressFilter = document.getElementById('apply-progress-filter');
        const addProgressUpdate = document.getElementById('add-progress-update');
        const saveProgressUpdate = document.getElementById('save-progress-update');
        const progressStatusFilter = document.getElementById('progress-status-filter');
        const progressDateFrom = document.getElementById('progress-date-from');
        const progressDateTo = document.getElementById('progress-date-to');
        
        // Profit/Loss Calculation
        const profitLossResult = document.getElementById('profit-loss-result');
        const resultText = document.getElementById('result-text');
        
        // Dashboard elements
        const totalRevenue = document.getElementById('total-revenue');
        const totalExpenses = document.getElementById('total-expenses');
        const netProfit = document.getElementById('net-profit');
        const inventoryValue = document.getElementById('inventory-value');
        const recentBills = document.getElementById('recent-bills');
        const lowStockAlerts = document.getElementById('low-stock-alerts');
        const plRevenue = document.getElementById('pl-revenue');
        const plExpenses = document.getElementById('pl-expenses');
        const revenueComparison = document.getElementById('revenue-comparison');
        const expensesComparison = document.getElementById('expenses-comparison');
        const plBreakdown = document.getElementById('pl-breakdown');
        
        // Inventory elements
        const inventorySearch = document.getElementById('inventory-search');
        const inventorySearchBtn = document.getElementById('inventory-search-btn');
        const inventoryCategoryFilter = document.getElementById('inventory-category-filter');
        const inventoryStockFilter = document.getElementById('inventory-stock-filter');
        
        // Breakdown elements
        const addBreakdownItemBtn = document.getElementById('add-breakdown-item');
        const saveBreakdownBtn = document.getElementById('save-breakdown');
        const resetBreakdownBtn = document.getElementById('reset-breakdown');
        
        // Customer search elements
        const customerNameInput = document.getElementById('individual-customer-name');
        const customerAddressInput = document.getElementById('individual-customer-address');
        const customerSuggestions = document.getElementById('customer-suggestions');
        const customerSearchResults = document.getElementById('customer-search-results');
        const clearCustomerBtn = document.getElementById('clear-customer');
        
        // Manual records elements
        const manualTypeSelect = document.getElementById('manual-type');
        const manualCategoryInput = document.getElementById('manual-category');
        const manualAmountInput = document.getElementById('manual-amount');
        const manualDescriptionInput = document.getElementById('manual-description');
        const manualDateInput = document.getElementById('manual-date');
        
        // Sample data for charts
        const monthlyData = {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            revenue: [12000, 19000, 15000, 21000, 22000, 24500],
            expenses: [9000, 12000, 11000, 15000, 16700, 18300]
        };
        // 在脚本开头添加这个
window.onerror = function(message, source, lineno, colno, error) {
    console.log("Global error caught:", message, "at", source, "line", lineno);
    
    // 如果是classList错误，忽略它
    if (message.includes('classList')) {
        console.log("Ignoring classList error");
        return true; // 阻止默认错误处理
    }
    
    return false; // 继续默认错误处理
};

// 或者更精确地捕获特定错误
window.addEventListener('error', function(e) {
    if (e.message && e.message.includes('classList')) {
        e.preventDefault();
        console.log("Suppressed classList error");
    }
});
        // Store bills data
        let bills = {
            periodic: [],
            individual: [],
            monthly: [],
            yearly: []
        };
        
        // Store customers data
        let customers = [];
        
        // Store inventory data
        let inventory = [];
        
        // Store breakdown data
        let breakdownData = [];
        
        // Store progress data
        let progressUpdates = {};
        
        // Store bill addresses
        let billAddresses = {};
        
        // Store manual records
        let manualRecords = [];
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.innerHTML = `
                <div class="toast-body">
                    <button type="button" class="btn-close float-end" data-bs-dismiss="toast"></button>
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // ============== ENHANCED CUSTOMER SELECTION ==============
        
        // Initialize smart customer selection
        function initSmartCustomerSelection() {
            if (!customerNameInput) return;
            
            // Listen to customer name input
            customerNameInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                if (searchTerm.length < 2) {
                    customerSearchResults.style.display = 'none';
                    return;
                }
                
                // Search customers
                searchCustomers(searchTerm);
            });
            
            // Clear customer button
            if (clearCustomerBtn) {
                clearCustomerBtn.addEventListener('click', function() {
                    customerNameInput.value = '';
                    customerAddressInput.value = '';
                    customerSearchResults.style.display = 'none';
                });
            }
            
            // Update datalist with customer names
            updateCustomerDatalist();
        }
        
        // Search customers function
        function searchCustomers(searchTerm) {
            if (!customerSearchResults) return;
            
            const results = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (customer.phone && customer.phone.includes(searchTerm))
            );
            
            displayCustomerSearchResults(results);
        }
        
        // Display customer search results
        function displayCustomerSearchResults(results) {
            if (!customerSearchResults) return;
            
            customerSearchResults.innerHTML = '';
            
            if (results.length === 0) {
                customerSearchResults.innerHTML = `
                    <div class="customer-result-item">
                        <p class="mb-0 text-muted">No customers found. You can enter a new customer.</p>
                    </div>
                `;
                customerSearchResults.style.display = 'block';
                return;
            }
            
            results.forEach(customer => {
                const resultItem = document.createElement('div');
                resultItem.className = 'customer-result-item';
                resultItem.innerHTML = `
                    <h6 class="mb-1">${customer.name}</h6>
                    <p class="mb-1 text-muted small">
                        ${customer.phone ? 'Phone: ' + customer.phone + ' • ' : ''}
                        ${customer.email ? 'Email: ' + customer.email : ''}
                    </p>
                    <p class="mb-1 text-muted small">${customer.address || 'No address provided'}</p>
                `;
                
                resultItem.addEventListener('click', function() {
                    customerNameInput.value = customer.name;
                    customerAddressInput.value = customer.address || '';
                    customerSearchResults.style.display = 'none';
                    
                    // Show success message
                    showToast(`Customer "${customer.name}" selected`, 'success');
                });
                
                customerSearchResults.appendChild(resultItem);
            });
            
            customerSearchResults.style.display = 'block';
        }
        
        // Update customer datalist
        function updateCustomerDatalist() {
            if (!customerSuggestions) return;
            
            customerSuggestions.innerHTML = '';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.name;
                customerSuggestions.appendChild(option);
            });
        }
        
        // ============== MANUAL REVENUE/EXPENSE SYSTEM ==============
        
        // Initialize manual revenue/expense system
        function initManualRevenueExpenseSystem() {
            if (!manualRevenueExpenseForm) return;
            
            // Set default date
            const today = new Date();
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();
            
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            manualDateInput.value = formattedToday;
            
            // Form submit handler
            manualRevenueExpenseForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const type = manualTypeSelect.value;
                const category = manualCategoryInput.value.trim();
                const amount = parseFloat(manualAmountInput.value);
                const description = manualDescriptionInput.value.trim();
                const date = manualDateInput.value;
                
                if (!category || isNaN(amount) || amount <= 0) {
                    showToast('Please enter valid category and amount', 'error');
                    return;
                }
                
                const record = {
                    id: Date.now().toString(),
                    type: type,
                    category: category,
                    amount: amount,
                    description: description,
                    date: date,
                    createdAt: new Date().toISOString()
                };
                
                // Add to manual records
                manualRecords.push(record);
                
                // Add to UI
                addManualRecordToUI(record);
                
                // Save to Firebase
                saveManualRecordToFirebase(record);
                
                // Update totals
                updateManualRecordsTotals();
                
                // Update charts
                updateChartsWithManualData();
                
                // Show success message
                showToast(`${type === 'revenue' ? 'Revenue' : 'Expense'} record added successfully`, 'success');
                
                // Reset form
                manualCategoryInput.value = '';
                manualAmountInput.value = '';
                manualDescriptionInput.value = '';
            });
            
            // Initialize PDF generation
            if (generateManualRecordsPdf) {
                generateManualRecordsPdf.addEventListener('click', generateManualRecordsPdfReport);
            }
            
            // Load existing manual records
            loadManualRecords();
        }
        
        // Add manual record to UI
        function addManualRecordToUI(record) {
            if (!manualRecordsList) return;
            
            const row = document.createElement('tr');
            row.className = `manual-record-row ${record.type}`;
            row.innerHTML = `
                <td>${record.date}</td>
                <td>
                    <span class="badge ${record.type === 'revenue' ? 'bg-success' : 'bg-danger'}">
                        ${record.type === 'revenue' ? 'Revenue' : 'Expense'}
                    </span>
                </td>
                <td>${record.category}</td>
                <td>${record.description || '-'}</td>
                <td>${record.amount.toFixed(2)}</td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editManualRecord('${record.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteManualRecord('${record.id}')"></i>
                </td>
            `;
            
            manualRecordsList.appendChild(row);
        }
        
        // Update manual records totals
        function updateManualRecordsTotals() {
            if (!manualRevenueTotal || !manualExpenseTotal || !manualNetTotal) return;
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            manualRecords.forEach(record => {
                if (record.type === 'revenue') {
                    totalRevenue += record.amount;
                } else if (record.type === 'expense') {
                    totalExpenses += record.amount;
                }
            });
            
            const netTotal = totalRevenue - totalExpenses;
            
            manualRevenueTotal.textContent = `RM ${totalRevenue.toFixed(2)}`;
            manualExpenseTotal.textContent = `RM ${totalExpenses.toFixed(2)}`;
            manualNetTotal.textContent = `RM ${netTotal.toFixed(2)}`;
            
            // Update profit/loss page totals
            if (plRevenue && plExpenses) {
                // Combine with bill data for total calculation
                let billRevenue = 0;
                for (const type in bills) {
                    bills[type].forEach(bill => {
                        billRevenue += bill.total;
                    });
                }
                
                const totalCombinedRevenue = billRevenue + totalRevenue;
                const totalCombinedExpenses = totalExpenses;
                
                plRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
                plExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
            }
        }
        
        // Edit manual record
        window.editManualRecord = function(recordId) {
            const recordIndex = manualRecords.findIndex(r => r.id === recordId);
            if (recordIndex === -1) return;
            
            const record = manualRecords[recordIndex];
            
            // Populate form
            manualTypeSelect.value = record.type;
            manualCategoryInput.value = record.category;
            manualAmountInput.value = record.amount;
            manualDescriptionInput.value = record.description || '';
            manualDateInput.value = record.date;
            
            // Remove from array
            manualRecords.splice(recordIndex, 1);
            
            // Remove from UI
            const rows = manualRecordsList.querySelectorAll('tr');
            for (let row of rows) {
                const editBtn = row.querySelector('.fa-edit');
                if (editBtn && editBtn.onclick.toString().includes(recordId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update totals
            updateManualRecordsTotals();
            
            // Delete from Firebase
            deleteManualRecordFromFirebase(recordId);
            
            showToast('Record loaded for editing', 'info');
        };
        
        // Delete manual record
        window.deleteManualRecord = function(recordId) {
            if (!confirm('Are you sure you want to delete this record?')) return;
            
            const recordIndex = manualRecords.findIndex(r => r.id === recordId);
            if (recordIndex === -1) return;
            
            // Remove from array
            manualRecords.splice(recordIndex, 1);
            
            // Remove from UI
            const rows = manualRecordsList.querySelectorAll('tr');
            for (let row of rows) {
                const deleteBtn = row.querySelector('.fa-trash');
                if (deleteBtn && deleteBtn.onclick.toString().includes(recordId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update totals
            updateManualRecordsTotals();
            
            // Delete from Firebase
            deleteManualRecordFromFirebase(recordId);
            
            showToast('Record deleted successfully', 'success');
        };
        
        // Generate manual records PDF report
        function generateManualRecordsPdfReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Manual Revenue & Expenses Report', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add summary
            doc.setFontSize(14);
            doc.text('Summary', 14, 40);
            doc.setFontSize(12);
            doc.text(`Total Revenue: ${manualRevenueTotal.textContent}`, 14, 48);
            doc.text(`Total Expenses: ${manualExpenseTotal.textContent}`, 14, 56);
            doc.text(`Net: ${manualNetTotal.textContent}`, 14, 64);
            
            // Add table
            const tableColumn = ["Date", "Type", "Category", "Description", "Amount (RM)"];
            const tableRows = [];
            
            manualRecords.forEach(record => {
                tableRows.push([
                    record.date,
                    record.type === 'revenue' ? 'Revenue' : 'Expense',
                    record.category,
                    record.description || '-',
                    record.amount.toFixed(2)
                ]);
            });
            
            doc.autoTable({
                startY: 80,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid'
            });
            
            // Save the PDF
            doc.save('manual-records-report.pdf');
            
            showToast('Manual records report generated successfully', 'success');
        }
        
        // Load manual records from Firebase
        function loadManualRecords() {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('manualRecords').get()
                .then(querySnapshot => {
                    manualRecords = [];
                    if (manualRecordsList) manualRecordsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const record = doc.data();
                        manualRecords.push(record);
                        
                        if (manualRecordsList) {
                            addManualRecordToUI(record);
                        }
                    });
                    
                    updateManualRecordsTotals();
                    updateChartsWithManualData();
                })
                .catch(error => {
                    console.error("Error loading manual records: ", error);
                });
        }
        
        // Save manual record to Firebase
        function saveManualRecordToFirebase(record) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('manualRecords').doc(record.id).set(record)
                .catch(error => {
                    console.error("Error saving manual record: ", error);
                    showToast('Error saving record. Please try again.', 'error');
                });
        }
        
        // Delete manual record from Firebase
        function deleteManualRecordFromFirebase(recordId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('manualRecords').doc(recordId).delete()
                .catch(error => {
                    console.error("Error deleting manual record: ", error);
                });
        }
        
        // Update charts with manual data
        function updateChartsWithManualData() {
            // Destroy old chart instances
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
                performanceChartInstance = null;
            }
            
            if (profitLossChartInstance) {
                profitLossChartInstance.destroy();
                profitLossChartInstance = null;
            }
            
            // Reinitialize charts
            initCharts();
        }
        
        // Get enhanced chart data including manual records
        function getEnhancedChartData() {
            const enhancedData = {
                labels: monthlyData.labels,
                revenue: [...monthlyData.revenue],
                expenses: [...monthlyData.expenses]
            };
            
            // Add manual records to chart data (simplified - in real app you'd aggregate by month)
            let manualRevenueTotal = 0;
            let manualExpenseTotal = 0;
            
            manualRecords.forEach(record => {
                if (record.type === 'revenue') {
                    manualRevenueTotal += record.amount;
                } else if (record.type === 'expense') {
                    manualExpenseTotal += record.amount;
                }
            });
            
            // Distribute manual totals across months (simplified)
            const months = enhancedData.labels.length;
            const monthlyManualRevenue = manualRevenueTotal / months;
            const monthlyManualExpense = manualExpenseTotal / months;
            
            for (let i = 0; i < months; i++) {
                enhancedData.revenue[i] += monthlyManualRevenue;
                enhancedData.expenses[i] += monthlyManualExpense;
            }
            
            return enhancedData;
        }
        
        // ============== EXISTING CODE CONTINUES ==============
        
        // Initialize progress tracking
        function initProgressTracking() {
            setDefaultProgressDates();
            
            // Add event listeners
            if (applyProgressFilter) applyProgressFilter.addEventListener('click', filterProgressBills);
            if (generateProgressReport) generateProgressReport.addEventListener('click', generateProgressPdf);
            if (addProgressUpdate) addProgressUpdate.addEventListener('click', showProgressUpdateModal);
            if (saveProgressUpdate) saveProgressUpdate.addEventListener('click', saveProgressUpdateHandler);
            
            // Load progress data
            loadProgressData();
        }
        
        // Set default dates for progress filter
        function setDefaultProgressDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();
            
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            
            const yyyy2 = firstDay.getFullYear();
            let mm2 = firstDay.getMonth() + 1;
            let dd2 = firstDay.getDate();
            
            if (dd2 < 10) dd2 = '0' + dd2;
            if (mm2 < 10) mm2 = '0' + mm2;
            
            const formattedFirstDay = `${yyyy2}-${mm2}-${dd2}`;
            
            if (progressDateFrom) progressDateFrom.value = formattedFirstDay;
            if (progressDateTo) progressDateTo.value = formattedToday;
        }
        
        // Load progress data from Firebase
        function loadProgressData() {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('progress').get()
                .then(querySnapshot => {
                    progressUpdates = {};
                    
                    querySnapshot.forEach(doc => {
                        const progress = doc.data();
                        if (!progressUpdates[progress.billId]) {
                            progressUpdates[progress.billId] = [];
                        }
                        progressUpdates[progress.billId].push(progress);
                    });
                    
                    // Load bill addresses
                    db.collection('users').doc(auth.currentUser.uid).collection('billAddresses').get()
                        .then(querySnapshot => {
                            billAddresses = {};
                            querySnapshot.forEach(doc => {
                                const addressData = doc.data();
                                billAddresses[addressData.billId] = addressData.address;
                            });
                            
                            // Update progress view
                            updateProgressView();
                        })
                        .catch(error => {
                            console.error("Error loading bill addresses: ", error);
                        });
                })
                .catch(error => {
                    console.error("Error loading progress: ", error);
                });
        }
        
        function updateProgressView() {
            if (!progressBillsList) return;

            // Clear table
            progressBillsList.innerHTML = '';

            // Combine all bills
            const allBills = [];
            for (const type in bills) {
                if (Array.isArray(bills[type])) {
                    bills[type].forEach(bill => {
                        if (bill && bill.id) {
                            allBills.push(bill);
                        }
                    });
                }
            }

            // Show message if no bills
            if (allBills.length === 0) {
                progressBillsList.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            No bills yet
                        </td>
                    </tr>
                `;

                if (totalBillsCount) totalBillsCount.textContent = 0;
                if (recordedBillsCount) recordedBillsCount.textContent = 0;
                if (paidBillsCount) paidBillsCount.textContent = 0;
                if (overdueBillsCount) overdueBillsCount.textContent = 0;
                return;
            }

            // Counters
            let total = 0;
            let recorded = 0;
            let paid = 0;
            let overdue = 0;

            // Render table
            allBills.forEach(bill => {
                const billProgress = progressUpdates[bill.id] || [];
                const latestUpdate = billProgress.length
                    ? billProgress[billProgress.length - 1]
                    : { status: 'pending' };

                total++;
                if (latestUpdate.status === 'recorded') recorded++;
                if (latestUpdate.status === 'paid') paid++;
                if (latestUpdate.status === 'overdue') overdue++;

                const customerName = bill.customerName || 'N/A';

                // Map link
                let mapLink = 'No address';
                const address = billAddresses[bill.id] || bill.customerAddress;
                if (address) {
                    const encoded = encodeURIComponent(address);
                    mapLink = `
                        <a href="https://www.google.com/maps/search/?api=1&query=${encoded}" 
                           target="_blank" class="map-link">
                            <i class="fas fa-map-marker-alt"></i> View
                        </a>
                    `;
                }

                const totalAmount = Number(bill.total) || 0;
                const lastUpdateDate = billProgress.length
                    ? new Date(billProgress[billProgress.length - 1].date).toLocaleDateString()
                    : 'Never';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.date || '-'}</td>
                    <td>${bill.billNo || '-'}</td>
                    <td>${bill.description || '-'}</td>
                    <td>${customerName}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td>
                        <span class="status-badge status-${latestUpdate.status}">
                            ${latestUpdate.status.charAt(0).toUpperCase() + latestUpdate.status.slice(1)}
                        </span>
                    </td>
                    <td>${mapLink}</td>
                    <td>${lastUpdateDate}</td>
                    <td>
                        ${
                            billProgress.length
                                ? `<button class="btn btn-sm btn-info" onclick="viewProgressUpdates('${bill.id}')">
                                    <i class="fas fa-eye"></i> View (${billProgress.length})
                                   </button>`
                                : 'No updates'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="updateBillProgress('${bill.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="addBillAddress('${bill.id}')">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                `;

                progressBillsList.appendChild(row);
            });

            // Update statistics
            if (totalBillsCount) totalBillsCount.textContent = total;
            if (recordedBillsCount) recordedBillsCount.textContent = recorded;
            if (paidBillsCount) paidBillsCount.textContent = paid;
            if (overdueBillsCount) overdueBillsCount.textContent = overdue;
        }
        
       function filterProgressBills() {
            if (!progressBillsList) return;

            const statusFilter = progressStatusFilter.value;
            const dateFrom = progressDateFrom.value ? new Date(progressDateFrom.value) : null;
            const dateTo = progressDateTo.value ? new Date(progressDateTo.value) : null;

            if (dateTo) dateTo.setDate(dateTo.getDate() + 1);

            // Clear table
            progressBillsList.innerHTML = '';

            // Combine bills (safely)
            const allBills = [];
            for (const type in bills) {
                if (Array.isArray(bills[type])) {
                    bills[type].forEach(bill => {
                        if (bill && bill.id) allBills.push(bill);
                    });
                }
            }

            // Counters
            let total = 0;
            let recorded = 0;
            let paid = 0;
            let overdue = 0;

            let hasResult = false;

            allBills.forEach(bill => {
                // Date filtering (safely)
                if (dateFrom || dateTo) {
                    if (!bill.date) return;
                    const billDate = new Date(bill.date);
                    if (isNaN(billDate)) return;
                    if (dateFrom && billDate < dateFrom) return;
                    if (dateTo && billDate >= dateTo) return;
                }

                const billProgress = progressUpdates[bill.id] || [];
                const latestUpdate = billProgress.length
                    ? billProgress[billProgress.length - 1]
                    : { status: 'pending' };

                if (statusFilter !== 'all' && latestUpdate.status !== statusFilter) return;

                hasResult = true;
                total++;

                if (latestUpdate.status === 'recorded') recorded++;
                if (latestUpdate.status === 'paid') paid++;
                if (latestUpdate.status === 'overdue') overdue++;

                const customerName = bill.customerName || 'N/A';

                // Address
                let mapLink = 'No address';
                const address = billAddresses[bill.id] || bill.customerAddress;
                if (address) {
                    const encoded = encodeURIComponent(address);
                    mapLink = `
                        <a href="https://www.google.com/maps/search/?api=1&query=${encoded}" 
                           target="_blank" class="map-link">
                            <i class="fas fa-map-marker-alt"></i> View
                        </a>
                    `;
                }

                const totalAmount = Number(bill.total) || 0;
                const lastUpdateDate = billProgress.length
                    ? new Date(billProgress[billProgress.length - 1].date).toLocaleDateString()
                    : 'Never';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.date || '-'}</td>
                    <td>${bill.billNo || '-'}</td>
                    <td>${bill.description || '-'}</td>
                    <td>${customerName}</td>
                    <td>${totalAmount.toFixed(2)}</td>
                    <td>
                        <span class="status-badge status-${latestUpdate.status}">
                            ${latestUpdate.status.charAt(0).toUpperCase() + latestUpdate.status.slice(1)}
                        </span>
                    </td>
                    <td>${mapLink}</td>
                    <td>${lastUpdateDate}</td>
                    <td>
                        ${
                            billProgress.length
                                ? `<button class="btn btn-sm btn-info" onclick="viewProgressUpdates('${bill.id}')">
                                    <i class="fas fa-eye"></i> View (${billProgress.length})
                                   </button>`
                                : 'No updates'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="updateBillProgress('${bill.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="addBillAddress('${bill.id}')">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                `;

                progressBillsList.appendChild(row);
            });

            // Show message if no results
            if (!hasResult) {
                progressBillsList.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            No bills match the selected filter
                        </td>
                    </tr>
                `;
            }

            // Update statistics
            if (totalBillsCount) totalBillsCount.textContent = total;
            if (recordedBillsCount) recordedBillsCount.textContent = recorded;
            if (paidBillsCount) paidBillsCount.textContent = paid;
            if (overdueBillsCount) overdueBillsCount.textContent = overdue;
        }
        
        // Show progress update modal
        function showProgressUpdateModal() {
            showToast('Use the Update button next to each bill to add progress updates', 'info');
        }
        
        // Update bill progress
        window.updateBillProgress = function(billId) {
            let bill = null;
            for (const type in bills) {
                bill = bills[type].find(b => b.id === billId);
                if (bill) break;
            }
            
            if (!bill) return;
            
            // Set bill ID in modal
            document.getElementById('progress-bill-id').value = billId;
            
            // Set current status if exists
            const billProgress = progressUpdates[billId] || [];
            if (billProgress.length > 0) {
                document.getElementById('progress-status').value = billProgress[billProgress.length - 1].status;
            } else {
                document.getElementById('progress-status').value = 'pending';
            }
            
            // Clear notes
            document.getElementById('progress-notes').value = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('progressUpdateModal'));
            modal.show();
        };
        
        // Add bill address
        window.addBillAddress = function(billId) {
            let bill = null;
            for (const type in bills) {
                bill = bills[type].find(b => b.id === billId);
                if (bill) break;
            }
            
            if (!bill) return;
            
            // Set bill ID in modal
            document.getElementById('address-bill-id').value = billId;
            
            // Set current address if exists
            const address = billAddresses[billId] || bill.customerAddress || '';
            document.getElementById('bill-address').value = address;
            
            // Update map preview
            updateMapPreview(address);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('billAddressModal'));
            modal.show();
        };
        
        // Update map preview
        function updateMapPreview(address) {
            const mapPreview = document.getElementById('map-preview');
            if (!mapPreview) return;
            
            if (address) {
                const encodedAddress = encodeURIComponent(address);
                mapPreview.innerHTML = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        style="border:0; border-radius: 5px;" 
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyB-q5IfxsoF-Ud7YTw2jwHwrzXQuDmxey8&q=${encodedAddress}" 
                        allowfullscreen>
                    </iframe>
                `;
            } else {
                mapPreview.innerHTML = '<p class="text-muted">Enter an address to see a preview</p>';
            }
        }
        
        // Save progress update
        function saveProgressUpdateHandler() {
            const billId = document.getElementById('progress-bill-id').value;
            const status = document.getElementById('progress-status').value;
            const notes = document.getElementById('progress-notes').value;
            
            if (!billId) return;
            
            // Create progress update
            const progressUpdate = {
                id: Date.now().toString(),
                billId: billId,
                status: status,
                notes: notes,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            // Add to progress updates
            if (!progressUpdates[billId]) {
                progressUpdates[billId] = [];
            }
            progressUpdates[billId].push(progressUpdate);
            
            // Save to Firebase
            saveProgressUpdateToFirebase(progressUpdate);
            
            // Update view
            updateProgressView();
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressUpdateModal'));
            if (modal) modal.hide();
            
            // Show success message
            showToast('Progress update saved successfully', 'success');
        }
        
        // Save bill address
        const saveBillAddressBtn = document.getElementById('save-bill-address');
        if (saveBillAddressBtn) {
            saveBillAddressBtn.addEventListener('click', function() {
                const billId = document.getElementById('address-bill-id').value;
                const address = document.getElementById('bill-address').value;
                
                if (!billId) return;
                
                // Save address
                billAddresses[billId] = address;
                
                // Save to Firebase
                saveBillAddressToFirebase(billId, address);
                
                // Update view
                updateProgressView();
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('billAddressModal'));
                if (modal) modal.hide();
                
                // Show success message
                showToast('Bill address saved successfully', 'success');
            });
        }
        
        // Update map preview when address changes
        const billAddressInput = document.getElementById('bill-address');
        if (billAddressInput) {
            billAddressInput.addEventListener('input', function() {
                updateMapPreview(this.value);
            });
        }
        
        // View progress updates
        window.viewProgressUpdates = function(billId) {
            const billProgress = progressUpdates[billId] || [];
            
            if (billProgress.length === 0) {
                showToast('No progress updates for this bill', 'info');
                return;
            }
            
            // Remove existing modal
            const existingModal = document.querySelector('.progress-updates-modal');
            if (existingModal) existingModal.remove();
            
            // Create modal content
            let content = '<div class="progress-updates" style="max-height: 400px; overflow-y: auto;">';
            billProgress.forEach(update => {
                content += `
                    <div class="progress-update mb-3 p-3 rounded" style="background-color: var(--card-bg); border-left: 4px solid ${getStatusColor(update.status)}">
                        <p class="mb-1"><strong>${update.status.charAt(0).toUpperCase() + update.status.slice(1)}</strong> - ${new Date(update.date).toLocaleDateString()}</p>
                        <p class="mb-1">${update.notes || 'No notes'}</p>
                        <small class="text-muted">Updated: ${new Date(update.createdAt).toLocaleString()}</small>
                    </div>
                `;
            });
            content += '</div>';
            
            // Create modal
            const modalHTML = `
                <div class="modal fade progress-updates-modal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Progress Updates</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${content}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Show modal
            const modalElement = document.querySelector('.progress-updates-modal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Cleanup
            modalElement.addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        };

        // Add status color helper function
        function getStatusColor(status) {
            const colors = {
                'pending': '#ffc107',
                'recorded': '#17a2b8',
                'paid': '#28a745',
                'overdue': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        // Generate progress PDF report
        function generateProgressPdf() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Progress Tracking Report', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add filter info
            doc.text(`Status: ${progressStatusFilter.value === 'all' ? 'All' : progressStatusFilter.options[progressStatusFilter.selectedIndex].text}`, 14, 40);
            doc.text(`Date Range: ${progressDateFrom.value} to ${progressDateTo.value}`, 14, 48);
            
            // Add summary
            doc.setFontSize(14);
            doc.text('Summary', 14, 60);
            doc.setFontSize(12);
            doc.text(`Total Bills: ${totalBillsCount.textContent}`, 14, 70);
            doc.text(`Recorded: ${recordedBillsCount.textContent}`, 14, 78);
            doc.text(`Paid: ${paidBillsCount.textContent}`, 14, 86);
            doc.text(`Overdue: ${overdueBillsCount.textContent}`, 14, 94);
            
            // Add table
            const tableColumn = ["Date", "Bill No", "Description", "Customer", "Amount", "Status"];
            const tableRows = [];
            
            const rows = progressBillsList.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent
                ];
                tableRows.push(rowData);
            });
            
            doc.autoTable({
                startY: 110,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid'
            });
            
            // Save the PDF
            doc.save('progress-report.pdf');
            
            showToast('Progress report generated successfully', 'success');
        }
        
        // Save progress update to Firebase
        function saveProgressUpdateToFirebase(progressUpdate) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('progress').doc(progressUpdate.id).set(progressUpdate)
                .catch(error => {
                    console.error("Error saving progress update: ", error);
                    showToast('Error saving progress update. Please try again.', 'error');
                });
        }
        
        // Save bill address to Firebase
        function saveBillAddressToFirebase(billId, address) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('billAddresses').doc(billId).set({
                billId: billId,
                address: address,
                updatedAt: new Date().toISOString()
            })
            .catch(error => {
                console.error("Error saving bill address: ", error);
                showToast('Error saving bill address. Please try again.', 'error');
            });
        }
        
        // Initialize breakdown functionality
        function initBreakdown() {
            // Load breakdown data from Firebase
            loadBreakdownData();
            
            // Add event listeners
            if (addBreakdownItemBtn) addBreakdownItemBtn.addEventListener('click', addBreakdownItem);
            if (saveBreakdownBtn) saveBreakdownBtn.addEventListener('click', saveBreakdownData);
            if (resetBreakdownBtn) resetBreakdownBtn.addEventListener('click', resetBreakdownData);
        }
        
        // Add new breakdown item
        function addBreakdownItem() {
            const newItem = {
                id: Date.now().toString(),
                category: 'New Category',
                amount: 0,
                percentage: 0,
                trend: 'up'
            };
            
            breakdownData.push(newItem);
            renderBreakdownItem(newItem);
            showToast('New breakdown item added', 'success');
        }
        
        function renderBreakdownItem(item) {
            if (!item || !item.id) return;

            let row = plBreakdown.querySelector(`tr[data-id="${item.id}"]`);

            if (!row) {
                row = document.createElement('tr');
                row.setAttribute('data-id', item.id);
                plBreakdown.appendChild(row);
            }

            const amount = Number(item.amount) || 0;
            const percentage = Number(item.percentage) || 0;

            row.innerHTML = `
                <td>
                    <span class="editable-field" contenteditable="true" data-field="category">
                        ${item.category || ''}
                    </span>
                </td>
                <td>
                    <span class="editable-field" contenteditable="true" data-field="amount">
                        ${amount}
                    </span>
                </td>
                <td>
                    <span class="editable-field" contenteditable="true" data-field="percentage">
                        ${percentage}
                    </span>%
                </td>
                <td>
                    <select class="form-select form-select-sm trend-select" data-field="trend">
                        <option value="up" ${item.trend === 'up' ? 'selected' : ''}>↑ Increase</option>
                        <option value="down" ${item.trend === 'down' ? 'selected' : ''}>↓ Decrease</option>
                        <option value="stable" ${item.trend === 'stable' ? 'selected' : ''}>→ Stable</option>
                    </select>
                </td>
                <td>
                    <i class="fas fa-trash action-btn text-danger"
                       onclick="deleteBreakdownItem('${item.id}')"></i>
                </td>
            `;

            // Rebind events
            row.querySelectorAll('.editable-field').forEach(field => {
                field.onblur = function () {
                    const fieldName = this.dataset.field;
                    let value = this.textContent.trim();

                    if (fieldName !== 'category') {
                        value = Number(value) || 0;
                    }

                    updateBreakdownItem(item.id, fieldName, value);
                };
            });

            row.querySelector('.trend-select').onchange = function () {
                updateBreakdownItem(item.id, 'trend', this.value);
            };
        }
        
        // Update breakdown item
        function updateBreakdownItem(id, field, value) {
            const itemIndex = breakdownData.findIndex(item => item.id === id);
            if (itemIndex === -1) return;
            
            if (field === 'amount' || field === 'percentage') {
                value = parseFloat(value) || 0;
            }
            
            breakdownData[itemIndex][field] = value;
        }
        
        // Delete breakdown item
        window.deleteBreakdownItem = function(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            // Remove from data array
            breakdownData = breakdownData.filter(item => item.id !== id);
            
            // Remove from UI
            const row = document.querySelector(`#pl-breakdown tr[data-id="${id}"]`);
            if (row) row.remove();
            
            // Delete from Firebase
            deleteBreakdownFromFirebase(id);
            
            showToast('Breakdown item deleted', 'success');
        };
        
        // Save breakdown data
        function saveBreakdownData() {
            if (!auth.currentUser) return;
            
            // Update all editable fields in case any are still focused
            document.querySelectorAll('.editable-field').forEach(field => {
                field.dispatchEvent(new Event('blur'));
            });
            
            // Save to Firebase
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            
            userRef.set({
                breakdown: breakdownData
            }, { merge: true })
            .then(() => {
                showToast('Breakdown data saved successfully!', 'success');
            })
            .catch(error => {
                console.error("Error saving breakdown: ", error);
                showToast('Error saving data. Please try again.', 'error');
            });
        }
        
        // Reset breakdown data
        function resetBreakdownData() {
            if (!confirm('Are you sure you want to reset all breakdown data? This cannot be undone.')) return;
            
            breakdownData = [];
            plBreakdown.innerHTML = '';
            
            // Reset in Firebase
            if (auth.currentUser) {
                const userRef = db.collection('users').doc(auth.currentUser.uid);
                
                userRef.update({
                    breakdown: []
                })
                .then(() => {
                    showToast('Breakdown data reset successfully!', 'success');
                })
                .catch(error => {
                    console.error("Error resetting breakdown: ", error);
                    showToast('Error resetting data. Please try again.', 'error');
                });
            }
        }
        
        // Load breakdown data from Firebase
        function loadBreakdownData() {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().breakdown) {
                        breakdownData = doc.data().breakdown;
                        
                        // Render all items
                        plBreakdown.innerHTML = '';
                        breakdownData.forEach(item => {
                            renderBreakdownItem(item);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading breakdown: ", error);
                });
        }
        
        // Delete breakdown from Firebase
        function deleteBreakdownFromFirebase(id) {
            if (!auth.currentUser) return;
            
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            
            userRef.get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.breakdown) {
                            const updatedBreakdown = data.breakdown.filter(item => item.id !== id);
                            
                            return userRef.update({
                                breakdown: updatedBreakdown
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error("Error deleting breakdown item: ", error);
                });
        }
        
        // Event Listeners
        showRegister.addEventListener('click', function(e) {
            e.preventDefault();
            registerSection.style.display = 'block';
            loginSection.style.display = 'none';
        });
        
        showLogin.addEventListener('click', function(e) {
            e.preventDefault();
            registerSection.style.display = 'none';
            loginSection.style.display = 'block';
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetPage = this.getAttribute('data-page');
                
                // Update active navigation link
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                this.classList.add('active');
                
                // Show target page
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(targetPage).classList.add('active');
                
                // Reinitialize charts
                setTimeout(() => {
                    initCharts();
                }, 100);
                
                // If navigating to dashboard, update it
                if (targetPage === 'dashboard') {
                    updateDashboard();
                }
                
                // If navigating to profit-loss, update it
                if (targetPage === 'profit-loss') {
                    updateProfitLoss();
                }
                
                // If navigating to inventory-tracking, update it
                if (targetPage === 'inventory-tracking') {
                    updateInventoryList();
                }
                
                // If navigating to progress-tracking, update it
                if (targetPage === 'progress-tracking') {
                    updateProgressView();
                }
            });
        });
        // 密码显示/隐藏切换
if (togglePassword) {
    togglePassword.addEventListener('click', function() {
        const passwordInput = document.getElementById('password');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
}

// 忘记密码功能
if (forgotPassword) {
    forgotPassword.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        modal.show();
    });
}

// 发送重置链接
if (sendResetLink) {
    sendResetLink.addEventListener('click', function() {
        const email = resetEmail.value.trim();
        
        if (!email) {
            showResetMessage('Please enter your email address', 'danger');
            return;
        }
        
        // 发送密码重置邮件
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showResetMessage('Password reset link has been sent to your email', 'success');
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                    if (modal) modal.hide();
                }, 3000);
            })
            .catch(error => {
                console.error("Reset password error: ", error);
                showResetMessage('Error sending reset link. Please try again.', 'danger');
            });
    });
}

function showResetMessage(message, type) {
    if (!resetMessage) return;
    resetMessage.textContent = message;
    resetMessage.className = `alert alert-${type}`;
    resetMessage.style.display = 'block';
}

// 记住我功能
if (rememberMe) {
    // 检查本地存储中是否有保存的登录信息
    const savedEmail = localStorage.getItem('savedEmail');
    if (savedEmail) {
        document.getElementById('email').value = savedEmail;
        rememberMe.checked = true;
    }
    
    // 注意：这里我们稍后会修改现有的loginBtn事件监听器来配合记住我功能
}
        // Setup bill form handlers
        function setupBillForm(form, quantityId, priceId, totalId, listId, grandTotalId, billType) {
            const quantityInput = document.getElementById(quantityId);
            const priceInput = document.getElementById(priceId);
            const totalInput = document.getElementById(totalId);
            const billList = document.getElementById(listId);
            const grandTotal = document.getElementById(grandTotalId);
            
            // Calculate total
            if (quantityInput && priceInput && totalInput) {
                quantityInput.addEventListener('input', calculateTotal);
                priceInput.addEventListener('input', calculateTotal);
                
                function calculateTotal() {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = quantity * price;
                    totalInput.value = total.toFixed(2);
                }
            }
            
            // Form submit handler
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dateInput = document.getElementById(`${billType}-date`);
                const billNoInput = document.getElementById(`${billType}-billno`);
                const descriptionInput = document.getElementById(`${billType}-description`);
                
                const date = dateInput.value;
                const billNo = billNoInput.value;
                const description = descriptionInput.value;
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                
                // For individual bills, get customer info
                let customerName = '';
                let customerAddress = '';
                
                if (billType === 'individual') {
                    customerName = document.getElementById('individual-customer-name').value;
                    customerAddress = document.getElementById('individual-customer-address').value;
                }
                
                const bill = {
                    id: Date.now().toString(),
                    date,
                    billNo,
                    description,
                    quantity,
                    price,
                    total,
                    type: billType,
                    customerName,
                    customerAddress
                };
                
                // Add to bills array
                bills[billType].push(bill);
                
                // Re-render entire table
                renderBillsByType(billType);
                
                // Update grand total
                updateGrandTotal();
                
                // Save to Firebase
                saveBillToFirebase(bill);
                
                // Show success message
                showToast('Bill item added successfully', 'success');
                
                // Reset form
                form.reset();
                totalInput.value = '0.00';
                
                // Set today's date
                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();
                
                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;
                
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                dateInput.value = formattedToday;
                
                // Update progress view if on progress page
                updateProgressView();
            });
                   
            function updateGrandTotal() {
                let total = 0;
                const rows = billList.querySelectorAll('tr');
                
                rows.forEach(row => {
                    // Safety check: ensure row has enough cells
                    if (row.cells && row.cells.length > (billType === 'individual' ? 6 : 5)) {
                        const totalCell = billType === 'individual' ? row.cells[6] : row.cells[5];
                        if (totalCell && totalCell.textContent) {
                            total += parseFloat(totalCell.textContent) || 0;
                        }
                    }
                });
                
                if (grandTotal) {
                    grandTotal.textContent = `RM ${total.toFixed(2)}`;
                }
            }
            
            // Return updateGrandTotal function for external calls
            return updateGrandTotal;
        }
        
        // Setup all bill forms
        const updatePeriodicTotal = setupBillForm(
            periodicForm, 
            'periodic-quantity', 
            'periodic-price', 
            'periodic-total', 
            'periodic-bills-list', 
            'periodic-grand-total',
            'periodic'
        );
        
        const updateIndividualTotal = setupBillForm(
            individualForm, 
            'individual-quantity', 
            'individual-price', 
            'individual-total', 
            'individual-bills-list', 
            'individual-grand-total',
            'individual'
        );
        
        const updateMonthlyTotal = setupBillForm(
            monthlyForm, 
            'monthly-quantity', 
            'monthly-price', 
            'monthly-total', 
            'monthly-bills-list', 
            'monthly-grand-total',
            'monthly'
        );
        
        const updateYearlyTotal = setupBillForm(
            yearlyForm, 
            'yearly-quantity', 
            'yearly-price', 
            'yearly-total', 
            'yearly-bills-list', 
            'yearly-grand-total',
            'yearly'
        );
        
        // Inventory Form Handling
        if (inventoryForm) {
            inventoryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('product-name').value;
                const sku = document.getElementById('product-sku').value;
                const category = document.getElementById('product-category').value;
                const quantity = parseInt(document.getElementById('product-quantity').value);
                const lowStockThreshold = parseInt(document.getElementById('product-low-stock').value);
                const costPrice = parseFloat(document.getElementById('product-cost').value);
                const sellingPrice = parseFloat(document.getElementById('product-price').value);
                const supplier = document.getElementById('product-supplier').value;
                const description = document.getElementById('product-description').value;
                
                const product = {
                    id: Date.now().toString(),
                    name,
                    sku,
                    category,
                    quantity,
                    lowStockThreshold,
                    costPrice,
                    sellingPrice,
                    supplier,
                    description,
                    stockValue: costPrice * quantity,
                    createdAt: new Date().toISOString()
                };
                
                // Add to inventory array
                inventory.push(product);
                
                // Add to UI
                addProductToUI(product);
                
                // Save to Firebase
                saveProductToFirebase(product);
                
                // Show success message
                showToast('Product added successfully', 'success');
                
                // Reset form
                inventoryForm.reset();
                document.getElementById('product-low-stock').value = '10';
                
                // Update inventory total value
                updateInventoryTotalValue();
                
                // Update dashboard
                updateDashboard();
            });
        }
        
        function addProductToUI(product) {
            const status = getStockStatus(product.quantity, product.lowStockThreshold);
            const statusClass = status === 'Out of Stock' ? 'out-of-stock' : 
                               status === 'Low Stock' ? 'low-stock' : 'in-stock';
            
            const newRow = document.createElement('tr');
            newRow.className = statusClass;
            newRow.innerHTML = `
                <td>${product.name}</td>
                <td>${product.sku}</td>
                <td>${product.category}</td>
                <td>${product.quantity}</td>
                <td>${product.costPrice.toFixed(2)}</td>
                <td>${product.sellingPrice.toFixed(2)}</td>
                <td>${product.stockValue.toFixed(2)}</td>
                <td><span class="stock-alert ${status === 'Out of Stock' ? 'alert-out' : status === 'Low Stock' ? 'alert-low' : ''}">${status}</span></td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editProduct('${product.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteProduct('${product.id}')"></i>
                </td>
            `;
            if (inventoryList) inventoryList.appendChild(newRow);
        }
        
        function getStockStatus(quantity, threshold) {
            if (quantity === 0) {
                return 'Out of Stock';
            } else if (quantity <= threshold) {
                return 'Low Stock';
            } else {
                return 'In Stock';
            }
        }
        
        function updateInventoryTotalValue() {
            if (!inventoryList) return;
            
            let totalValue = 0;
            const rows = inventoryList.querySelectorAll('tr');
            
            rows.forEach(row => {
                const valueCell = row.cells[6];
                totalValue += parseFloat(valueCell.textContent);
            });
            
            if (inventoryTotalValue) {
                inventoryTotalValue.textContent = `RM ${totalValue.toFixed(2)}`;
            }
            if (inventoryValue) {
                inventoryValue.textContent = `RM ${totalValue.toFixed(2)}`;
            }
        }
        
        function updateInventoryList() {
            if (!inventoryList) return;
            
            inventoryList.innerHTML = '';
            inventory.forEach(product => {
                addProductToUI(product);
            });
            updateInventoryTotalValue();
        }
        
        // Inventory search and filter
        if (inventorySearchBtn) inventorySearchBtn.addEventListener('click', filterInventory);
        if (inventorySearch) inventorySearch.addEventListener('keyup', filterInventory);
        if (inventoryCategoryFilter) inventoryCategoryFilter.addEventListener('change', filterInventory);
        if (inventoryStockFilter) inventoryStockFilter.addEventListener('change', filterInventory);
        
        function filterInventory() {
            if (!inventoryList) return;
            
            const searchTerm = inventorySearch.value.toLowerCase();
            const categoryFilter = inventoryCategoryFilter.value;
            const stockFilter = inventoryStockFilter.value;
            
            inventoryList.innerHTML = '';
            
            inventory.forEach(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                     product.sku.toLowerCase().includes(searchTerm) ||
                                     (product.description && product.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                let matchesStock = true;
                if (stockFilter) {
                    if (stockFilter === 'low') {
                        matchesStock = product.quantity > 0 && product.quantity <= product.lowStockThreshold;
                    } else if (stockFilter === 'out') {
                        matchesStock = product.quantity === 0;
                    } else if (stockFilter === 'in') {
                        matchesStock = product.quantity > product.lowStockThreshold;
                    }
                }
                
                if (matchesSearch && matchesCategory && matchesStock) {
                    addProductToUI(product);
                }
            });
            
            updateInventoryTotalValue();
        }
        
        // Product editing and deletion
        window.editProduct = function(productId) {
            const productIndex = inventory.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            const product = inventory[productIndex];
            
            // Populate form with product data
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-sku').value = product.sku;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-quantity').value = product.quantity;
            document.getElementById('product-low-stock').value = product.lowStockThreshold;
            document.getElementById('product-cost').value = product.costPrice;
            document.getElementById('product-price').value = product.sellingPrice;
            document.getElementById('product-supplier').value = product.supplier || '';
            document.getElementById('product-description').value = product.description || '';
            
            // Remove the product from array
            inventory.splice(productIndex, 1);
            
            // Remove from UI
            const productRows = inventoryList.querySelectorAll('tr');
            
            for (let row of productRows) {
                const editBtn = row.querySelector('.fa-edit');
                if (editBtn && editBtn.onclick.toString().includes(productId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update inventory total value
            updateInventoryTotalValue();
            
            // Delete from Firebase
            deleteProductFromFirebase(productId);
            
            showToast('Product loaded for editing', 'info');
        };
        
        window.deleteProduct = function(productId) {
            const productIndex = inventory.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            // Remove the product from array
            inventory.splice(productIndex, 1);
            
            // Remove from UI
            const productRows = inventoryList.querySelectorAll('tr');
            
            for (let row of productRows) {
                const deleteBtn = row.querySelector('.fa-trash');
                if (deleteBtn && deleteBtn.onclick.toString().includes(productId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update inventory total value
            updateInventoryTotalValue();
            
            // Delete from Firebase
            deleteProductFromFirebase(productId);
            
            showToast('Product deleted successfully', 'success');
        };
        
        // PDF Generation
        function setupPdfGeneration(button, listId, title) {
            if (!button) return;
            
            button.addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Check if autoTable is available
                if (!doc.autoTable) {
                    showToast('PDF library not properly loaded. Please refresh the page.', 'error');
                    console.error('autoTable is not available:', doc);
                    return;
                }
                
                // Add title
                doc.setFontSize(18);
                doc.text(`${title} Report`, 14, 22);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Add table
                doc.autoTable({
                    startY: 40,
                    head: [['Date', 'Bill No', 'Description', 'Quantity', 'Unit Price (RM)', 'Total (RM)']],
                    body: getTableData(listId)
                });
                        
                // Add grand total
                const rows = document.querySelectorAll(`#${listId} tr`);
                let grandTotal = 0;
                
                rows.forEach(row => {
                    const totalCell = row.cells[5];
                    grandTotal += parseFloat(totalCell.textContent);
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.text(`Grand Total: RM ${grandTotal.toFixed(2)}`, 14, finalY);
                
                // Save the PDF
                doc.save(`${title.toLowerCase()}-report.pdf`);
                
                showToast('PDF generated successfully', 'success');
            });
        }
        
        // Individual PDF Generation (with customer info)
        if (generateIndividualPdf) {
            generateIndividualPdf.addEventListener('click', function() {
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text('Individual Bills Report', 14, 22);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Add table
                doc.autoTable({
                    startY: 40,
                    head: [['Date', 'Bill No', 'Description', 'Customer', 'Quantity', 'Unit Price (RM)', 'Total (RM)']],
                    body: getIndividualTableData()
                });
                
                // Add grand total
                const rows = document.querySelectorAll('#individual-bills-list tr');
                let grandTotal = 0;
                
                rows.forEach(row => {
                    const totalCell = row.cells[6];
                    grandTotal += parseFloat(totalCell.textContent);
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.text(`Grand Total: RM ${grandTotal.toFixed(2)}`, 14, finalY);
                
                // Save the PDF
                doc.save('individual-bills-report.pdf');
                
                showToast('PDF generated successfully', 'success');
            });
        }
        
        function getIndividualTableData() {
            const data = [];
            const rows = document.querySelectorAll('#individual-bills-list tr');
            
            rows.forEach(row => {
                // Safety check: ensure row has enough cells
                if (row.cells && row.cells.length >= 7) {
                    const rowData = [];
                    for (let i = 0; i < 7; i++) {
                        rowData.push(row.cells[i].textContent || '');
                    }
                    data.push(rowData);
                }
            });
            
            return data;
        }
        
        // Inventory PDF Generation
        if (generateInventoryPdf) {
            generateInventoryPdf.addEventListener('click', function() {
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text('Inventory Report', 14, 22);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Add table
                doc.autoTable({
                    startY: 40,
                    head: [['Product Name', 'SKU', 'Category', 'Quantity', 'Cost Price (RM)', 'Selling Price (RM)', 'Stock Value (RM)', 'Status']],
                    body: getInventoryTableData()
                });
                
                // Add total value
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.text(`Total Inventory Value: RM ${inventoryTotalValue.textContent.replace('RM ', '')}`, 14, finalY);
                
                // Save the PDF
                doc.save('inventory-report.pdf');
                
                showToast('Inventory PDF generated successfully', 'success');
            });
        }
        
        function getInventoryTableData() {
            const data = [];
            const rows = inventoryList.querySelectorAll('tr');
            
            rows.forEach(row => {
                const rowData = [];
                for (let i = 0; i < 8; i++) {
                    if (i === 7) {
                        // Get status from span text
                        const statusSpan = row.cells[i].querySelector('.stock-alert');
                        rowData.push(statusSpan ? statusSpan.textContent : '');
                    } else {
                        rowData.push(row.cells[i].textContent);
                    }
                }
                data.push(rowData);
            });
            
            return data;
        }
            
        function getTableData(listId) {
            const data = [];
            const rows = document.querySelectorAll(`#${listId} tr`);
            
            rows.forEach(row => {
                // Safety check: ensure row has enough cells
                if (row.cells && row.cells.length >= 6) {
                    const rowData = [];
                    for (let i = 0; i < 6; i++) {
                        rowData.push(row.cells[i].textContent || '');
                    }
                    data.push(rowData);
                }
            });
            
            return data;
        }
        
        // Setup PDF generation for all bill types
        setupPdfGeneration(generatePeriodicPdf, 'periodic-bills-list', 'Periodic Bills');
        setupPdfGeneration(generateMonthlyPdf, 'monthly-bills-list', 'Monthly Bills');
        setupPdfGeneration(generateYearlyPdf, 'yearly-bills-list', 'Yearly Bills');
        
        // CSV Export for Inventory
        if (exportInventoryCsv) {
            exportInventoryCsv.addEventListener('click', function() {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Add headers
                csvContent += "Product Name,SKU,Category,Quantity,Cost Price (RM),Selling Price (RM),Stock Value (RM),Status\n";
                
                // Add data
                const rows = inventoryList.querySelectorAll('tr');
                rows.forEach(row => {
                    const rowData = [];
                    for (let i = 0; i < 8; i++) {
                        if (i === 7) {
                            // Get status from span text
                            const statusSpan = row.cells[i].querySelector('.stock-alert');
                            rowData.push(statusSpan ? `"${statusSpan.textContent}"` : '');
                        } else {
                            rowData.push(`"${row.cells[i].textContent}"`);
                        }
                    }
                    csvContent += rowData.join(',') + '\n';
                });
                
                // Add total value
                csvContent += `\nTotal Inventory Value,${inventoryTotalValue.textContent.replace('RM ', '')}`;
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "inventory_report.csv");
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                document.body.removeChild(link);
                
                showToast('CSV exported successfully', 'success');
            });
        }
        
        // Profit/Loss Calculation
        if (profitLossForm) {
            profitLossForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const revenue = parseFloat(document.getElementById('revenue').value);
                const expenses = parseFloat(document.getElementById('expenses').value);
                
                if (isNaN(revenue) || isNaN(expenses)) {
                    resultText.textContent = 'Please enter valid numbers for revenue and expenses.';
                    profitLossResult.className = 'alert alert-danger';
                    profitLossResult.style.display = 'block';
                    return;
                }
                
                const profitLoss = revenue - expenses;
                
                if (profitLoss > 0) {
                    resultText.textContent = `Net Profit: RM ${profitLoss.toFixed(2)}`;
                    profitLossResult.className = 'alert alert-success';
                } else if (profitLoss < 0) {
                    resultText.textContent = `Net Loss: RM ${Math.abs(profitLoss).toFixed(2)}`;
                    profitLossResult.className = 'alert alert-danger';
                } else {
                    resultText.textContent = 'Break Even: No profit or loss';
                    profitLossResult.className = 'alert alert-info';
                }
                
                profitLossResult.style.display = 'block';
            });
        }
        
        // Customer Form Handling
        if (customerForm) {
            customerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('customer-name').value;
                const email = document.getElementById('customer-email').value;
                const phone = document.getElementById('customer-phone').value;
                const address = document.getElementById('customer-address').value;
                
                const customer = {
                    id: Date.now().toString(),
                    name,
                    email,
                    phone,
                    address,
                    createdAt: new Date().toISOString()
                };
                
                // Add to customers array
                customers.push(customer);
                
                // Add to UI
                addCustomerToUI(customer);
                
                // Save to Firebase
                saveCustomerToFirebase(customer);
                
                // Update customer datalist
                updateCustomerDatalist();
                
                // Show success message
                showToast('Customer added successfully', 'success');
                
                // Reset form
                customerForm.reset();
            });
        }
        
        function addCustomerToUI(customer) {
            const customerCard = document.createElement('div');
            customerCard.className = 'customer-card';
            customerCard.innerHTML = `
                <h5>${customer.name}</h5>
                <p>Email: ${customer.email || 'N/A'}</p>
                <p>Phone: ${customer.phone || 'N/A'}</p>
                <p>Address: ${customer.address || 'N/A'}</p>
                <div class="customer-actions">
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${customer.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')">Delete</button>
                </div>
            `;
            
            if (customersList) customersList.appendChild(customerCard);
        }
        
        // Bill editing and deletion
        window.editBill = function(billType, billId) {
            const billIndex = bills[billType].findIndex(bill => bill.id === billId);
            if (billIndex === -1) return;
            
            const bill = bills[billType][billIndex];
            
            // Populate form with bill data
            document.getElementById(`${billType}-date`).value = bill.date;
            document.getElementById(`${billType}-billno`).value = bill.billNo;
            document.getElementById(`${billType}-description`).value = bill.description;
            document.getElementById(`${billType}-quantity`).value = bill.quantity;
            document.getElementById(`${billType}-price`).value = bill.price;
            
            // For individual bills, populate customer info
            if (billType === 'individual') {
                document.getElementById('individual-customer-name').value = bill.customerName || '';
                document.getElementById('individual-customer-address').value = bill.customerAddress || '';
            }
            
            // Remove the bill from array
            bills[billType].splice(billIndex, 1);
            
            // Use unified rendering function to re-render
            renderBillsByType(billType);
            
            // Update grand total
            if (billType === 'periodic') updatePeriodicTotal();
            if (billType === 'individual') updateIndividualTotal();
            if (billType === 'monthly') updateMonthlyTotal();
            if (billType === 'yearly') updateYearlyTotal();
            
            // Delete from Firebase
            deleteBillFromFirebase(billId);
            
            showToast('Bill loaded for editing', 'info');
        };

        window.deleteBill = function(billType, billId) {
            const billIndex = bills[billType].findIndex(bill => bill.id === billId);
            if (billIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this bill?')) return;
            
            // Remove the bill from array
            bills[billType].splice(billIndex, 1);
            
            // Use unified rendering function to re-render
            renderBillsByType(billType);
            
            // Safely update totals
            try {
                if (billType === 'periodic') updatePeriodicTotal();
                if (billType === 'individual') updateIndividualTotal();
                if (billType === 'monthly') updateMonthlyTotal();
                if (billType === 'yearly') updateYearlyTotal();
            } catch (error) {
                console.warn('Error updating total:', error);
                updateGrandTotalFromArray(billType);
            }
            
            // Delete from Firebase
            deleteBillFromFirebase(billId);
            
            showToast('Bill deleted successfully', 'success');
        };
        
        // Customer management functions
        window.editCustomer = function(customerId) {
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            const customer = customers[customerIndex];
            
            // Populate form with customer data
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-email').value = customer.email || '';
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-address').value = customer.address || '';
            
            // Remove the customer from array
            customers.splice(customerIndex, 1);
            
            // Remove from UI
            const customerCards = customersList.querySelectorAll('.customer-card');
            
            for (let card of customerCards) {
                const editBtn = card.querySelector('button.btn-primary');
                if (editBtn && editBtn.onclick.toString().includes(customerId)) {
                    card.remove();
                    break;
                }
            }
            
            // Update customer datalist
            updateCustomerDatalist();
            
            // Delete from Firebase
            deleteCustomerFromFirebase(customerId);
            
            showToast('Customer loaded for editing', 'info');
        };
        
        window.deleteCustomer = function(customerId) {
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            // Remove the customer from array
            customers.splice(customerIndex, 1);
            
            // Remove from UI
            const customerCards = customersList.querySelectorAll('.customer-card');
            
            for (let card of customerCards) {
                const deleteBtn = card.querySelector('button.btn-danger');
                if (deleteBtn && deleteBtn.onclick.toString().includes(customerId)) {
                    card.remove();
                    break;
                }
            }
            
            // Update customer datalist
            updateCustomerDatalist();
            
            // Delete from Firebase
            deleteCustomerFromFirebase(customerId);
            
            showToast('Customer deleted successfully', 'success');
        };
        
        // Firebase functions
        function saveBillToFirebase(bill) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('bills').doc(bill.id).set(bill)
                .catch(error => {
                    console.error("Error saving bill: ", error);
                    showToast('Error saving bill. Please try again.', 'error');
                });
        }
        
        function deleteBillFromFirebase(billId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('bills').doc(billId).delete()
                .catch(error => {
                    console.error("Error deleting bill: ", error);
                    showToast('Error deleting bill. Please try again.', 'error');
                });
        }
        
        function saveCustomerToFirebase(customer) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('customers').doc(customer.id).set(customer)
                .catch(error => {
                    console.error("Error saving customer: ", error);
                    showToast('Error saving customer. Please try again.', 'error');
                });
        }
        
        function deleteCustomerFromFirebase(customerId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('customers').doc(customerId).delete()
                .catch(error => {
                    console.error("Error deleting customer: ", error);
                    showToast('Error deleting customer. Please try again.', 'error');
                });
        }
        
        function saveProductToFirebase(product) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('inventory').doc(product.id).set(product)
                .catch(error => {
                    console.error("Error saving product: ", error);
                    showToast('Error saving product. Please try again.', 'error');
                });
        }
        
        function deleteProductFromFirebase(productId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('inventory').doc(productId).delete()
                .catch(error => {
                    console.error("Error deleting product: ", error);
                    showToast('Error deleting product. Please try again.', 'error');
                });
        }
        
        // Unified rendering function
        function renderBillsByType(type) {
            const billList = document.getElementById(`${type}-bills-list`);
            if (!billList) return;
            
            // Clear table
            billList.innerHTML = '';
            
            // Check if there is data
            if (!bills[type] || bills[type].length === 0) {
                const colSpan = type === 'individual' ? 8 : 7;
                billList.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="text-center text-muted">
                            No bills yet. Add your first bill above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Re-render all bills
            bills[type].forEach(bill => {
                let newRow;
                if (type === 'individual') {
                    newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${bill.date || ''}</td>
                        <td>${bill.billNo || ''}</td>
                        <td>${bill.description || ''}</td>
                        <td>${bill.customerName || 'N/A'}</td>
                        <td>${bill.quantity || 0}</td>
                        <td>${(bill.price || 0).toFixed(2)}</td>
                        <td>${(bill.total || 0).toFixed(2)}</td>
                        <td>
                            <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                            <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                        </td>
                    `;
                } else {
                    newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${bill.date || ''}</td>
                        <td>${bill.billNo || ''}</td>
                        <td>${bill.description || ''}</td>
                        <td>${bill.quantity || 0}</td>
                        <td>${(bill.price || 0).toFixed(2)}</td>
                        <td>${(bill.total || 0).toFixed(2)}</td>
                        <td>
                            <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                            <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                        </td>
                    `;
                }
                
                billList.appendChild(newRow);
            });
        }
                
        function loadUserData() {
            if (!auth.currentUser) return;
            
            // Load bills
            db.collection('users').doc(auth.currentUser.uid).collection('bills').get()
                .then(querySnapshot => {
                    bills = {
                        periodic: [],
                        individual: [],
                        monthly: [],
                        yearly: []
                    };
                    
                    querySnapshot.forEach(doc => {
                        try {
                            const bill = doc.data();
                            if (bill && bill.type && bill.id) {
                                bills[bill.type].push(bill);
                            }
                        } catch (error) {
                            console.warn('Error processing bill:', error);
                        }
                    });
                    
                    // Use unified rendering function
                    ['periodic', 'individual', 'monthly', 'yearly'].forEach(type => {
                        renderBillsByType(type);
                    });
                    
                    // Safely update totals
                    setTimeout(() => {
                        try {
                            if (typeof updatePeriodicTotal === 'function') updatePeriodicTotal();
                            if (typeof updateIndividualTotal === 'function') updateIndividualTotal();
                            if (typeof updateMonthlyTotal === 'function') updateMonthlyTotal();
                            if (typeof updateYearlyTotal === 'function') updateYearlyTotal();
                        } catch (error) {
                            console.warn('Error updating totals:', error);
                        }
                    }, 100);
                    
                    // Update dashboard
                    updateDashboard();
                    updateProgressView();
                })
                .catch(error => {
                    console.error("Error loading bills: ", error);
                    showToast('Error loading bills data.', 'error');
                });
                
                // Load customers
                db.collection('users').doc(auth.currentUser.uid).collection('customers').get()
                    .then(querySnapshot => {
                        customers = [];
                        if (customersList) customersList.innerHTML = '';
                        
                        querySnapshot.forEach(doc => {
                            const customer = doc.data();
                            customers.push(customer);
                            
                            // Add to UI
                            addCustomerToUI(customer);
                        });
                        
                        // Update customer datalist
                        updateCustomerDatalist();
                    })
                    .catch(error => {
                        console.error("Error loading customers: ", error);
                        showToast('Error loading customers data.', 'error');
                    });
                    
                // Load inventory
                db.collection('users').doc(auth.currentUser.uid).collection('inventory').get()
                    .then(querySnapshot => {
                        inventory = [];
                        if (inventoryList) inventoryList.innerHTML = '';
                        
                        querySnapshot.forEach(doc => {
                            const product = doc.data();
                            inventory.push(product);
                            
                            // Add to UI
                            addProductToUI(product);
                        });
                        
                        // Update inventory total value
                        updateInventoryTotalValue();
                        
                        // Update dashboard
                        updateDashboard();
                    })
                    .catch(error => {
                        console.error("Error loading inventory: ", error);
                        showToast('Error loading inventory data.', 'error');
                    });
                    
                // Load breakdown data
                loadBreakdownData();
                
                // Load progress data
                loadProgressData();
                
                // Load manual records
                loadManualRecords();
// Load new data types
loadTemplates();
loadAttachments();
loadComments();

// Populate dropdowns after loading
setTimeout(populateBillDropdowns, 1000);
            }

            function updateGrandTotalFromArray(type) {
                let total = 0;
                
                if (bills[type] && bills[type].length > 0) {
                    bills[type].forEach(bill => {
                        total += bill.total || 0;
                    });
                }
                
                const grandTotalElement = document.getElementById(`${type}-grand-total`);
                if (grandTotalElement) {
                    grandTotalElement.textContent = `RM ${total.toFixed(2)}`;
                }
            }
        
        // Dashboard functions
        function updateDashboard() {
            // Calculate totals from all bills
            let billRevenue = 0;
            for (const type in bills) {
                bills[type].forEach(bill => {
                    billRevenue += bill.total;
                });
            }
            
            // Calculate totals from manual records
            let manualRevenueTotal = 0;
            let manualExpenseTotal = 0;
            
            manualRecords.forEach(record => {
                if (record.type === 'revenue') {
                    manualRevenueTotal += record.amount;
                } else if (record.type === 'expense') {
                    manualExpenseTotal += record.amount;
                }
            });
            
            // Calculate combined totals
            const totalCombinedRevenue = billRevenue + manualRevenueTotal;
            const totalCombinedExpenses = manualExpenseTotal; // Can add other expenses if needed
            const profit = totalCombinedRevenue - totalCombinedExpenses;
            
            // Update UI
            if (totalRevenue) totalRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
            if (totalExpenses) totalExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
            if (netProfit) {
                netProfit.textContent = `RM ${profit.toFixed(2)}`;
                // Update profit/loss style
                if (profit > 0) {
                    netProfit.className = 'stat-value profit';
                } else if (profit < 0) {
                    netProfit.className = 'stat-value loss';
                } else {
                    netProfit.className = 'stat-value';
                }
            }
            
            // Update inventory value
            updateInventoryTotalValue();
            
            // Update recent bills
            updateRecentBills();
            
            // Update low stock alerts
            updateLowStockAlerts();
            
            // Update profit/loss page if needed
            if (plRevenue && plExpenses) {
                plRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
                plExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
            }
        }
        
        function updateRecentBills() {
            if (!recentBills) return;
            
            recentBills.innerHTML = '';
            
            // Get all bills and sort by date (newest first)
            const allBills = [];
            for (const type in bills) {
                allBills.push(...bills[type]);
            }
            
            allBills.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only the 5 most recent bills
            const recent = allBills.slice(0, 5);
            
            recent.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.date}</td>
                    <td>${bill.billNo}</td>
                    <td>${bill.total.toFixed(2)}</td>
                `;
                recentBills.appendChild(row);
            });
        }
        
        function updateLowStockAlerts() {
            if (!lowStockAlerts) return;
            
            lowStockAlerts.innerHTML = '';
            
            // Get low stock and out of stock items
            const lowStockItems = inventory.filter(product => 
                product.quantity > 0 && product.quantity <= product.lowStockThreshold
            );
            
            const outOfStockItems = inventory.filter(product => 
                product.quantity === 0
            );
            
            // Show alerts
            if (outOfStockItems.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.innerHTML = `<strong>${outOfStockItems.length} products are out of stock!</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            if (lowStockItems.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning';
                alert.innerHTML = `<strong>${lowStockItems.length} products are low on stock!</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `<strong>All products are in stock.</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            // Show detailed list
            const detailList = document.createElement('ul');
            detailList.className = 'list-group mt-3';
            
            outOfStockItems.forEach(product => {
                const item = document.createElement('li');
                item.className = 'list-group-item list-group-item-danger';
                item.textContent = `${product.name} - Out of Stock`;
                detailList.appendChild(item);
            });
            
            lowStockItems.forEach(product => {
                const item = document.createElement('li');
                item.className = 'list-group-item list-group-item-warning';
                item.textContent = `${product.name} - Low Stock (${product.quantity} left)`;
                detailList.appendChild(item);
            });
            
            if (outOfStockItems.length > 0 || lowStockItems.length > 0) {
                lowStockAlerts.appendChild(detailList);
            }
        }
        
        function updateProfitLoss() {
            // Calculate totals from all bills
            let billRevenue = 0;
            for (const type in bills) {
                bills[type].forEach(bill => {
                    billRevenue += bill.total;
                });
            }
            
            // Calculate totals from manual records
            let manualRevenueTotal = 0;
            let manualExpenseTotal = 0;
            
            manualRecords.forEach(record => {
                if (record.type === 'revenue') {
                    manualRevenueTotal += record.amount;
                } else if (record.type === 'expense') {
                    manualExpenseTotal += record.amount;
                }
            });
            
            // Calculate combined totals
            const totalCombinedRevenue = billRevenue + manualRevenueTotal;
            const totalCombinedExpenses = manualExpenseTotal;
            const profit = totalCombinedRevenue - totalCombinedExpenses;
            
            // Update UI
            if (plRevenue) plRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
            if (plExpenses) plExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
            if (revenueComparison) revenueComparison.textContent = `Last month: RM ${(totalCombinedRevenue * 0.9).toFixed(2)}`;
            if (expensesComparison) expensesComparison.textContent = `Last month: RM ${(totalCombinedExpenses * 0.9).toFixed(2)}`;
            
            // Update breakdown
            updatePLBreakdown(totalCombinedRevenue, totalCombinedExpenses);
        }
        
        function updatePLBreakdown(revenue, expenses) {
            // This function is now handled by the editable breakdown system
        }
        
        // Authentication functions
        // 替换现有的登录按钮事件监听器：
loginBtn.addEventListener('click', function() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (email && password) {
        // 显示加载状态
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing in...';
        this.disabled = true;
        
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // 登录成功
                this.innerHTML = '<i class="fas fa-check me-2"></i>Success!';
                setTimeout(() => {
                    authContainer.style.opacity = '0';
                    authContainer.style.transform = 'translateY(-20px)';
                    
                    setTimeout(() => {
                        authContainer.style.display = 'none';
                        mainContainer.style.display = 'block';
                        mainContainer.style.opacity = '0';
                        mainContainer.style.transform = 'translateY(20px)';
                        
                        setTimeout(() => {
                            mainContainer.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                            mainContainer.style.opacity = '1';
                            mainContainer.style.transform = 'translateY(0)';
                            loadUserData();
                        }, 100);
                        
                        showToast('Welcome back! Login successful!', 'success');
                    }, 300);
                }, 500);
            })
            .catch((error) => {
                // 恢复按钮状态
                this.innerHTML = originalText;
                this.disabled = false;
                
                // 显示错误
                handleLoginError(error);
                console.error("Login error: ", error);
            });
    } else {
        // 添加表单验证效果
        if (!email) {
            document.getElementById('email').classList.add('is-invalid');
            document.getElementById('email').focus();
        }
        if (!password) {
            document.getElementById('password').classList.add('is-invalid');
            if (email) document.getElementById('password').focus();
        }
        
        loginError.textContent = 'Please fill in all required fields.';
        loginError.style.display = 'block';
    }
});
        
        googleLoginBtn.addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Signed in
                    authContainer.style.display = 'none';
                    mainContainer.style.display = 'block';
                    loadUserData();
                    showToast('Google login successful!', 'success');
                })
                .catch((error) => {
                    console.error("Google sign-in error: ", error);
                    showToast('Google sign-in failed. Please try again.', 'error');
                });
        });
        
        // Register functionality
        registerBtn.addEventListener('click', function() {
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (password !== confirmPassword) {
        registerError.style.display = 'block';
        registerError.textContent = 'Passwords do not match.';
        showToast('Passwords do not match.', 'error');
        return;
    }
    
    if (password.length < 6) {
        registerError.style.display = 'block';
        registerError.textContent = 'Password must be at least 6 characters.';
        showToast('Password must be at least 6 characters.', 'error');
        return;
    }
    
    if (email && password) {
        // 显示加载状态
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        this.disabled = true;
        
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // 注册成功
                registerError.style.display = 'none';
                
                // 初始化用户数据结构
                const userRef = db.collection('users').doc(userCredential.user.uid);
                userRef.set({
                    email: email,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                }, { merge: true });
                
                showToast('Registration successful! You are now logged in.', 'success');
                
                // 自动登录
                authContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                loadUserData();
            })
            .catch((error) => {
                // 恢复按钮状态
                this.innerHTML = 'Register';
                this.disabled = false;
                
                // 显示具体错误
                let errorMessage = 'Registration failed. ';
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already in use.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Registration is currently disabled.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak.';
                        break;
                }
                
                registerError.style.display = 'block';
                registerError.textContent = errorMessage;
                showToast(errorMessage, 'error');
                console.error("Registration error: ", error);
            });
    } else {
        registerError.style.display = 'block';
        registerError.textContent = 'Please fill all required fields.';
        showToast('Please fill all required fields.', 'error');
    }
});;
        
        // Logout
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                
                // Clear all data from UI
                if (periodicBillsList) periodicBillsList.innerHTML = '';
                if (individualBillsList) individualBillsList.innerHTML = '';
                if (monthlyBillsList) monthlyBillsList.innerHTML = '';
                if (yearlyBillsList) yearlyBillsList.innerHTML = '';
                if (customersList) customersList.innerHTML = '';
                if (inventoryList) inventoryList.innerHTML = '';
                if (plBreakdown) plBreakdown.innerHTML = '';
                if (progressBillsList) progressBillsList.innerHTML = '';
                if (manualRecordsList) manualRecordsList.innerHTML = '';
                
                // Reset data
                bills = {
                    periodic: [],
                    individual: [],
                    monthly: [],
                    yearly: []
                };
                
                // Reset customers data
                customers = [];
                
                // Reset inventory data
                inventory = [];
                
                // Reset breakdown data
                breakdownData = [];
                
                // Reset progress data
                progressUpdates = {};
                
                // Reset bill addresses
                billAddresses = {};
                
                // Reset manual records
                manualRecords = [];
                
                showToast('Logged out successfully', 'info');
            });
        });
        
        function initCharts() {
            // Destroy old chart instances
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
                performanceChartInstance = null;
            }
            
            if (profitLossChartInstance) {
                profitLossChartInstance.destroy();
                profitLossChartInstance = null;
            }
            
            // Performance chart
            const perfCtx = document.getElementById('performanceChart');
            if (perfCtx) {
                // Set canvas dimensions to match container
                perfCtx.style.width = '100%';
                perfCtx.style.height = '100%';
                
                // Get enhanced data including manual records
                const chartData = getEnhancedChartData();
                
                performanceChartInstance = new Chart(perfCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: chartData.revenue,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Key: don't maintain aspect ratio
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                    display: true
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                    display: true
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    callback: function(value) {
                                        return 'RM ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Profit/loss chart
            const plCtx = document.getElementById('profitLossChart');
            if (plCtx) {
                // Set canvas dimensions to match container
                plCtx.style.width = '100%';
                plCtx.style.height = '100%';
                
                // Get enhanced data including manual records
                const chartData = getEnhancedChartData();
                
                profitLossChartInstance = new Chart(plCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Revenue',
                                data: chartData.revenue,
                                backgroundColor: '#27ae60',
                                borderColor: '#27ae60',
                                borderWidth: 1
                            },
                            {
                                label: 'Expenses',
                                data: chartData.expenses,
                                backgroundColor: '#e74c3c',
                                borderColor: '#e74c3c',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Key: don't maintain aspect ratio
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                    display: true
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                                    display: true
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                    callback: function(value) {
                                        return 'RM ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Add chart theme update function
        function updateChartsTheme() {
            // Reinitialize charts to apply new theme
            if (performanceChartInstance) performanceChartInstance.destroy();
            if (profitLossChartInstance) profitLossChartInstance.destroy();
            initCharts();
        }

        // Call on theme toggle
        document.getElementById('theme-toggle').addEventListener('click', function() {
            setTimeout(updateChartsTheme, 300);
        });
        
        // Set today's date as default for all date inputs
        function setDefaultDates() {
            document.querySelectorAll('input[type="date"]').forEach(input => {
                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();
                
                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;
                
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                input.value = formattedToday;
            });
        }
        
        auth.onAuthStateChanged((user) => {
    console.log("Auth state changed, user:", user ? user.email : "No user");
    
    if (user) {
        // 检查邮箱是否已验证
        if (!user.emailVerified) {
            console.log("User email not verified:", user.email);
            
            // 如果用户试图进入主界面，强制登出并显示提示
            if (mainContainer.style.display === 'block') {
                showToast('Please verify your email before accessing the system', 'warning');
                
                // 短暂延迟后登出
                setTimeout(() => {
                    auth.signOut();
                }, 2000);
                
                // 显示验证提醒
                const reminderHTML = `
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-envelope"></i> Email Verification Required</h6>
                        <p>Please check your email (${user.email}) for the verification link.</p>
                        <button class="btn btn-sm btn-primary" id="resend-verification">
                            <i class="fas fa-paper-plane"></i> Resend Verification Email
                        </button>
                    </div>
                `;
                
                // 添加到登录页面
                const authContainer = document.getElementById('auth-container');
                if (authContainer && !document.getElementById('verification-reminder')) {
                    authContainer.insertAdjacentHTML('beforeend', reminderHTML);
                    
                    // 添加重新发送验证邮件的功能
                    document.getElementById('resend-verification').addEventListener('click', function() {
    // ✅ 正确：使用 firebase.auth().currentUser
    const currentUser = auth.currentUser;
    if (currentUser) {
        currentUser.sendEmailVerification()
            .then(() => {
                showToast('Verification email resent. Please check your inbox.', 'success');
            })
            .catch(error => {
                console.error("Error resending verification:", error);
                showToast('Error resending verification email', 'error');
            });
    }
});
                }
            }
            
            // 保持显示登录页面
            if (authContainer && mainContainer) {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
            }
            return;
        }
        
        // 用户已登录且邮箱已验证
        console.log("User is logged in and verified:", user.email);
        
        if (authContainer && mainContainer) {
            authContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            loadUserData();
            
            // 移除验证提醒（如果存在）
            const reminder = document.getElementById('verification-reminder');
            if (reminder) reminder.remove();
        }
    } else {
        // 用户未登录
        console.log("No user logged in, showing auth container");
        
        if (authContainer && mainContainer) {
            authContainer.style.display = 'block';
            mainContainer.style.display = 'none';
            
            // 确保登录页面可见
            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            if (loginSection) loginSection.style.display = 'block';
            if (registerSection) registerSection.style.display = 'none';
        }
    }
});
        
        document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded, initializing app...");
    
    // 检查关键元素
    const elements = {
        'auth-container': document.getElementById('auth-container'),
        'main-container': document.getElementById('main-container'),
        'login-section': document.getElementById('login-section'),
        'register-section': document.getElementById('register-section')
    };
    
    // 记录元素状态
    Object.entries(elements).forEach(([id, element]) => {
        console.log(`${id}:`, element ? "Found" : "Not found");
    });
    
    // 设置默认日期
    setDefaultDates();
    
    // 初始化各个模块
    try {
        initCharts();
        initBreakdown();
        initProgressTracking();
        initThemeToggle();
        initResponsiveDesign();
        initSmartCustomerSelection();
        initManualRevenueExpenseSystem();
        initEnhancedRegistration();
        console.log("All modules initialized successfully");
    } catch (error) {
        console.error("Error initializing modules:", error);
    }
    
    // 检查用户是否已经登录
    const currentUser = auth.currentUser;
    console.log("Current user on load:", currentUser ? currentUser.email : "No user");
});

        // Responsive design function
        function initResponsiveDesign() {
            // Detect device type and adjust layout
            const isMobile = window.innerWidth <= 768;
            const isTablet = window.innerWidth <= 992;
            
            if (isMobile) {
                // Mobile optimization
                optimizeForMobile();
            } else if (isTablet) {
                // Tablet optimization
                optimizeForTablet();
            } else {
                // Desktop optimization
                optimizeForDesktop();
            }
            
            // Listen for window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(initResponsiveDesign, 250);
            });
        }

        function optimizeForMobile() {
            // Adjust tables for scroll view
            document.querySelectorAll('.bill-table').forEach(table => {
                table.parentElement.classList.add('table-responsive');
            });
            
            // Adjust form layout
            document.querySelectorAll('.row .col-md-3, .row .col-md-4, .row .col-md-6').forEach(col => {
                col.classList.add('col-12');
                col.classList.remove('col-md-3', 'col-md-4', 'col-md-6');
            });
            
            // Adjust button size
            document.querySelectorAll('button, .btn').forEach(btn => {
                if (!btn.classList.contains('btn-sm')) {
                    btn.classList.add('btn-sm');
                }
            });
            
            // Adjust font size
            document.querySelectorAll('h1, h2, h3, h4, h5').forEach(heading => {
                const currentSize = parseInt(window.getComputedStyle(heading).fontSize);
                heading.style.fontSize = (currentSize * 0.9) + 'px';
            });
        }

        function optimizeForTablet() {
            // Tablet adjustments
            document.querySelectorAll('.row .col-md-3').forEach(col => {
                col.classList.add('col-6');
            });
            
            document.querySelectorAll('.row .col-md-4').forEach(col => {
                col.classList.add('col-6');
            });
            
            document.querySelectorAll('.row .col-md-6').forEach(col => {
                col.classList.add('col-12');
            });
        }

        function optimizeForDesktop() {
            // Restore original layout for desktop
            document.querySelectorAll('.table-responsive').forEach(table => {
                table.parentElement.classList.remove('table-responsive');
            });
        }

        // Theme toggle function
        function initThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            
            // Check local storage for theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                showToast(`Switched to ${newTheme === 'dark' ? 'dark' : 'light'} mode`, 'success');
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-sun';
                } else {
                    themeIcon.className = 'fas fa-moon';
                }
            }
        }
    // ============== BILL TEMPLATES SYSTEM ==============
let templates = [];

// Initialize templates system
function initTemplatesSystem() {
    if (!auth.currentUser) return;
    
    // Load templates
    loadTemplates();
    
    // Save current bill as template
    const saveTemplateBtn = document.getElementById('save-current-template');
    if (saveTemplateBtn) {
        saveTemplateBtn.addEventListener('click', saveCurrentBillAsTemplate);
    }
    
    // Template checkbox handling
    const selectAllCheckbox = document.getElementById('select-all-templates');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#templates-list input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // Delete selected templates
    const deleteSelectedBtn = document.getElementById('delete-selected-templates');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', deleteSelectedTemplates);
    }
    
    // Refresh templates
    const refreshBtn = document.getElementById('refresh-templates');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadTemplates);
    }
}

function saveCurrentBillAsTemplate() {
    const templateName = document.getElementById('template-name').value.trim();
    const templateType = document.getElementById('template-type').value;
    const description = document.getElementById('template-description').value.trim();
    
    if (!templateName) {
        showToast('Please enter a template name', 'error');
        return;
    }
    
    // Get current bill data based on active page
    let billData = null;
    const activePage = document.querySelector('.page.active').id;
    
    switch (activePage) {
        case 'individual-bills':
            billData = getCurrentIndividualBillData();
            break;
        case 'periodic-bills':
            billData = getCurrentPeriodicBillData();
            break;
        case 'monthly-bills':
            billData = getCurrentMonthlyBillData();
            break;
        case 'yearly-bills':
            billData = getCurrentYearlyBillData();
            break;
        default:
            showToast('Please navigate to a bill page to save as template', 'error');
            return;
    }
    
    if (!billData || billData.items.length === 0) {
        showToast('No bill items to save as template', 'error');
        return;
    }
    
    const template = {
        id: Date.now().toString(),
        name: templateName,
        type: templateType,
        description: description,
        data: billData,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    // Save to local array
    templates.push(template);
    
    // Save to Firebase
    saveTemplateToFirebase(template);
    
    // Update UI
    addTemplateToUI(template);
    
    // Clear form
    document.getElementById('template-name').value = '';
    document.getElementById('template-description').value = '';
    
    showToast('Template saved successfully!', 'success');
}

function getCurrentIndividualBillData() {
    return {
        type: 'individual',
        items: bills.individual.map(bill => ({
            description: bill.description,
            quantity: bill.quantity,
            price: bill.price,
            customerName: bill.customerName,
            customerAddress: bill.customerAddress
        }))
    };
}

// Similar functions for other bill types...

function addTemplateToUI(template) {
    const templatesList = document.getElementById('templates-list');
    if (!templatesList) return;
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <input type="checkbox" class="template-select" value="${template.id}">
        </td>
        <td>
            <strong>${template.name}</strong>
            ${template.description ? `<br><small class="text-muted">${template.description}</small>` : ''}
        </td>
        <td>
            <span class="badge bg-info">${template.type}</span>
        </td>
        <td>${template.description || '-'}</td>
        <td>${template.data.items.length}</td>
        <td>${new Date(template.createdAt).toLocaleDateString()}</td>
        <td>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('${template.id}')">
                <i class="fas fa-play"></i> Use
            </button>
            <button class="btn btn-sm btn-success" onclick="duplicateTemplate('${template.id}')">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template.id}')">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    templatesList.appendChild(row);
}

function useTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    // Navigate to the appropriate bill page
    const pageMap = {
        'individual': 'individual-bills',
        'periodic': 'periodic-bills',
        'monthly': 'monthly-bills',
        'yearly': 'yearly-bills'
    };
    
    const targetPage = pageMap[template.type];
    if (targetPage) {
        // Trigger navigation
        document.querySelector(`.sidebar a[data-page="${targetPage}"]`).click();
        
        // Populate form with template data after a short delay
        setTimeout(() => {
            populateFormWithTemplate(template);
        }, 500);
    }
    
    showToast(`Template "${template.name}" loaded`, 'success');
}

function duplicateTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;
    
    const newTemplate = {
        ...template,
        id: Date.now().toString(),
        name: `${template.name} (Copy)`,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    templates.push(newTemplate);
    saveTemplateToFirebase(newTemplate);
    addTemplateToUI(newTemplate);
    
    showToast('Template duplicated successfully', 'success');
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    const index = templates.findIndex(t => t.id === templateId);
    if (index !== -1) {
        templates.splice(index, 1);
        
        // Remove from UI
        const row = document.querySelector(`#templates-list tr:has(input[value="${templateId}"])`);
        if (row) row.remove();
        
        // Delete from Firebase
        deleteTemplateFromFirebase(templateId);
        
        showToast('Template deleted successfully', 'success');
    }
}

function deleteSelectedTemplates() {
    const selectedCheckboxes = document.querySelectorAll('#templates-list .template-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select templates to delete', 'error');
        return;
    }
    
    if (!confirm(`Delete ${selectedCheckboxes.length} selected template(s)?`)) return;
    
    selectedCheckboxes.forEach(checkbox => {
        deleteTemplate(checkbox.value);
    });
}

// Firebase operations for templates
function saveTemplateToFirebase(template) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('templates').doc(template.id).set(template)
        .catch(error => {
            console.error("Error saving template: ", error);
            showToast('Error saving template', 'error');
        });
}

function loadTemplates() {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('templates').get()
        .then(querySnapshot => {
            templates = [];
            const templatesList = document.getElementById('templates-list');
            if (templatesList) templatesList.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const template = doc.data();
                templates.push(template);
                
                if (templatesList) {
                    addTemplateToUI(template);
                }
            });
        })
        .catch(error => {
            console.error("Error loading templates: ", error);
        });
}

function deleteTemplateFromFirebase(templateId) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('templates').doc(templateId).delete()
        .catch(error => {
            console.error("Error deleting template: ", error);
        });
}

// ============== QUICK COPY BILL SYSTEM ==============
function initQuickCopySystem() {
    // Quick copy button in bill rows
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('fa-clone') || e.target.parentElement.classList.contains('fa-clone')) {
            const billRow = e.target.closest('tr');
            if (billRow) {
                const billId = billRow.dataset.billId || billRow.dataset.id;
                const billType = billRow.dataset.billType;
                
                if (billId && billType) {
                    quickCopyBill(billId, billType);
                }
            }
        }
    });
    
    // Quick copy modal
    if (document.getElementById('confirm-copy-bill')) {
        document.getElementById('confirm-copy-bill').addEventListener('click', function() {
            const sourceBillId = document.getElementById('copy-source-bill').value;
            if (!sourceBillId) return;
            
            const sourceBill = getBillById(sourceBillId);
            if (sourceBill) {
                duplicateBill(sourceBill);
                const modal = bootstrap.Modal.getInstance(document.getElementById('quickCopyModal'));
                if (modal) modal.hide();
            }
        });
    }
}

function quickCopyBill(billId, billType) {
    let bill = null;
    
    // Find the bill
    if (bills[billType]) {
        bill = bills[billType].find(b => b.id === billId);
    }
    
    if (!bill) {
        // Try to find in all bills
        for (const type in bills) {
            bill = bills[type].find(b => b.id === billId);
            if (bill) {
                billType = type;
                break;
            }
        }
    }
    
    if (bill) {
        duplicateBill(bill, billType);
    }
}

function duplicateBill(originalBill, billType) {
    const newBill = {
        ...originalBill,
        id: Date.now().toString(),
        billNo: `${originalBill.billNo}-COPY-${Date.now().toString().slice(-4)}`,
        date: new Date().toISOString().split('T')[0]
    };
    
    // Add to appropriate array
    if (billType && bills[billType]) {
        bills[billType].push(newBill);
    } else if (newBill.type && bills[newBill.type]) {
        bills[newBill.type].push(newBill);
    }
    
    // Save to Firebase
    saveBillToFirebase(newBill);
    
    // Update UI
    renderBillsByType(billType || newBill.type);
    
    showToast('Bill copied successfully!', 'success');
}

// ============== BATCH OPERATIONS SYSTEM ==============
function initBatchOperations() {
    // Load bills for batch operations
    loadBatchBills();
    
    // Event listeners
    const applyFilterBtn = document.getElementById('apply-batch-filter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', loadBatchBills);
    }
    
    const selectAllBatch = document.getElementById('select-all-batch');
    if (selectAllBatch) {
        selectAllBatch.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#batch-bills-list .bill-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // Batch operations buttons
    const batchCopyBtn = document.getElementById('batch-copy');
    if (batchCopyBtn) {
        batchCopyBtn.addEventListener('click', batchCopyBills);
    }
    
    const batchDeleteBtn = document.getElementById('batch-delete');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', batchDeleteBills);
    }
    
    const batchExportPdfBtn = document.getElementById('batch-export-pdf');
    if (batchExportPdfBtn) {
        batchExportPdfBtn.addEventListener('click', batchExportAsPDF);
    }
    
    const batchExportCsvBtn = document.getElementById('batch-export-csv');
    if (batchExportCsvBtn) {
        batchExportCsvBtn.addEventListener('click', batchExportAsCSV);
    }
}

function loadBatchBills() {
    const billType = document.getElementById('batch-bill-type').value;
    const dateFrom = document.getElementById('batch-date-from').value;
    const dateTo = document.getElementById('batch-date-to').value;
    
    const batchBillsList = document.getElementById('batch-bills-list');
    if (!batchBillsList) return;
    
    batchBillsList.innerHTML = '';
    
    // Collect all bills
    const allBills = [];
    for (const type in bills) {
        if (billType === 'all' || billType === type) {
            bills[type].forEach(bill => {
                // Apply date filter
                if (dateFrom && bill.date < dateFrom) return;
                if (dateTo && bill.date > dateTo) return;
                
                allBills.push({
                    ...bill,
                    originalType: type
                });
            });
        }
    }
    
    // Display bills
    allBills.forEach(bill => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="bill-select" value="${bill.id}">
            </td>
            <td>${bill.date}</td>
            <td>${bill.billNo}</td>
            <td>
                <span class="badge bg-secondary">${bill.originalType}</span>
            </td>
            <td>${bill.description}</td>
            <td>${bill.total.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="quickCopyBill('${bill.id}', '${bill.originalType}')">
                    <i class="fas fa-clone"></i>
                </button>
            </td>
        `;
        
        // Add event listener to checkbox
        const checkbox = row.querySelector('.bill-select');
        checkbox.addEventListener('change', updateSelectedCount);
        
        batchBillsList.appendChild(row);
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('#batch-bills-list .bill-select:checked').length;
    const selectedCountElement = document.getElementById('selected-count');
    if (selectedCountElement) {
        selectedCountElement.textContent = `${selectedCount} selected`;
    }
}

function batchCopyBills() {
    const selectedCheckboxes = document.querySelectorAll('#batch-bills-list .bill-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select bills to copy', 'error');
        return;
    }
    
    if (!confirm(`Copy ${selectedCheckboxes.length} selected bill(s)?`)) return;
    
    let copiedCount = 0;
    selectedCheckboxes.forEach(checkbox => {
        const billId = checkbox.value;
        const row = checkbox.closest('tr');
        const billType = row.querySelector('.badge').textContent.toLowerCase();
        
        quickCopyBill(billId, billType);
        copiedCount++;
    });
    
    showToast(`${copiedCount} bill(s) copied successfully`, 'success');
}

function batchDeleteBills() {
    const selectedCheckboxes = document.querySelectorAll('#batch-bills-list .bill-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select bills to delete', 'error');
        return;
    }
    
    if (!confirm(`Delete ${selectedCheckboxes.length} selected bill(s)? This action cannot be undone.`)) return;
    
    selectedCheckboxes.forEach(checkbox => {
        const billId = checkbox.value;
        const row = checkbox.closest('tr');
        const billType = row.querySelector('.badge').textContent.toLowerCase();
        
        // Find and delete bill
        const billIndex = bills[billType].findIndex(b => b.id === billId);
        if (billIndex !== -1) {
            bills[billType].splice(billIndex, 1);
            deleteBillFromFirebase(billId);
        }
        
        // Remove row
        row.remove();
    });
    
    updateSelectedCount();
    showToast(`${selectedCheckboxes.length} bill(s) deleted successfully`, 'success');
}

function batchExportAsPDF() {
    const selectedCheckboxes = document.querySelectorAll('#batch-bills-list .bill-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select bills to export', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.text('Batch Bill Export Report', 14, 22);
    
    // Add export info
    doc.setFontSize(12);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Total Bills: ${selectedCheckboxes.length}`, 14, 38);
    
    let yPos = 50;
    
    selectedCheckboxes.forEach((checkbox, index) => {
        const billId = checkbox.value;
        const row = checkbox.closest('tr');
        const cells = row.querySelectorAll('td');
        
        // Add bill header
        doc.setFontSize(14);
        doc.text(`Bill ${index + 1}: ${cells[1].textContent} - ${cells[2].textContent}`, 14, yPos);
        
        yPos += 10;
        
        // Add bill details
        doc.setFontSize(12);
        doc.text(`Type: ${cells[3].textContent}`, 14, yPos);
        yPos += 7;
        doc.text(`Description: ${cells[4].textContent}`, 14, yPos);
        yPos += 7;
        doc.text(`Amount: ${cells[5].textContent}`, 14, yPos);
        yPos += 10;
        
        // Add page break if needed
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
    });
    
    // Save PDF
    doc.save(`batch-export-${new Date().toISOString().slice(0, 10)}.pdf`);
    showToast(`Exported ${selectedCheckboxes.length} bill(s) as PDF`, 'success');
}

// ============== ATTACHMENTS SYSTEM ==============
let attachments = [];

function initAttachmentsSystem() {
    // Load attachments
    loadAttachments();
    
    // Setup file upload
    const attachmentForm = document.getElementById('attachment-form');
    if (attachmentForm) {
        attachmentForm.addEventListener('submit', handleAttachmentUpload);
    }
    
    // Populate bill dropdown
    populateBillDropdowns();
    
    // Filter buttons
    const filterImagesBtn = document.getElementById('filter-images');
    const filterDocumentsBtn = document.getElementById('filter-documents');
    const filterAllBtn = document.getElementById('filter-all-attachments');
    
    if (filterImagesBtn) {
        filterImagesBtn.addEventListener('click', () => filterAttachments('image'));
    }
    
    if (filterDocumentsBtn) {
        filterDocumentsBtn.addEventListener('click', () => filterAttachments('document'));
    }
    
    if (filterAllBtn) {
        filterAllBtn.addEventListener('click', () => filterAttachments('all'));
    }
}

function handleAttachmentUpload(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('attachment-file');
    const billId = document.getElementById('attachment-bill').value;
    const attachmentType = document.getElementById('attachment-type').value;
    const description = document.getElementById('attachment-description').value.trim();
    
    if (!billId || !fileInput.files.length) {
        showToast('Please select a bill and file', 'error');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const attachment = {
            id: Date.now().toString(),
            billId: billId,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            fileData: e.target.result,
            attachmentType: attachmentType,
            description: description,
            uploadedAt: new Date().toISOString(),
            uploadedBy: auth.currentUser ? auth.currentUser.email : 'Anonymous'
        };
        
        // Save to local array
        attachments.push(attachment);
        
        // Save to Firebase
        saveAttachmentToFirebase(attachment);
        
        // Add to UI
        addAttachmentToUI(attachment);
        
        // Reset form
        document.getElementById('attachment-form').reset();
        
        showToast('Attachment uploaded successfully', 'success');
    };
    
    reader.readAsDataURL(file);
}

function addAttachmentToUI(attachment) {
    const attachmentsGrid = document.getElementById('attachments-grid');
    if (!attachmentsGrid) return;
    
    // Get bill info
    const bill = getBillById(attachment.billId);
    const billInfo = bill ? `${bill.billNo} - ${bill.description}` : 'Unknown Bill';
    
    const isImage = attachment.fileType.startsWith('image/');
    
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-4';
    col.innerHTML = `
        <div class="card h-100">
            <div class="card-body">
                ${isImage ? 
                    `<img src="${attachment.fileData}" class="img-fluid mb-2" style="max-height: 150px; object-fit: cover; cursor: pointer;" 
                          onclick="previewAttachment('${attachment.id}')">` :
                    `<div class="text-center py-4" onclick="previewAttachment('${attachment.id}')" style="cursor: pointer;">
                        <i class="fas fa-file fa-3x text-secondary"></i>
                        <p class="mt-2">${attachment.fileName}</p>
                    </div>`
                }
                <h6 class="card-title">${attachment.description || attachment.fileName}</h6>
                <p class="card-text small">
                    <strong>Bill:</strong> ${billInfo}<br>
                    <strong>Type:</strong> ${attachment.attachmentType}<br>
                    <strong>Size:</strong> ${formatFileSize(attachment.fileSize)}<br>
                    <strong>Uploaded:</strong> ${new Date(attachment.uploadedAt).toLocaleDateString()}
                </p>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-primary" onclick="previewAttachment('${attachment.id}')">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn btn-sm btn-success" onclick="downloadAttachment('${attachment.id}')">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-sm btn-danger float-end" onclick="deleteAttachment('${attachment.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    attachmentsGrid.appendChild(col);
}

function previewAttachment(attachmentId) {
    const attachment = attachments.find(a => a.id === attachmentId);
    if (!attachment) return;
    
    const modalTitle = document.getElementById('attachment-preview-title');
    const modalContent = document.getElementById('attachment-preview-content');
    const downloadLink = document.getElementById('download-attachment');
    
    if (modalTitle) modalTitle.textContent = attachment.fileName;
    
    if (modalContent) {
        if (attachment.fileType.startsWith('image/')) {
            modalContent.innerHTML = `<img src="${attachment.fileData}" class="img-fluid" style="max-height: 70vh;">`;
        } else if (attachment.fileType === 'application/pdf') {
            modalContent.innerHTML = `
                <iframe src="${attachment.fileData}" width="100%" height="600px"></iframe>
            `;
        } else {
            modalContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Preview not available for this file type.
                    Please download the file to view it.
                </div>
            `;
        }
    }
    
    if (downloadLink) {
        downloadLink.href = attachment.fileData;
        downloadLink.download = attachment.fileName;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('attachmentPreviewModal'));
    modal.show();
}

function downloadAttachment(attachmentId) {
    const attachment = attachments.find(a => a.id === attachmentId);
    if (!attachment) return;
    
    const link = document.createElement('a');
    link.href = attachment.fileData;
    link.download = attachment.fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function deleteAttachment(attachmentId) {
    if (!confirm('Are you sure you want to delete this attachment?')) return;
    
    const index = attachments.findIndex(a => a.id === attachmentId);
    if (index !== -1) {
        attachments.splice(index, 1);
        
        // Remove from UI
        const attachmentElement = document.querySelector(`[onclick*="${attachmentId}"]`).closest('.col-md-4');
        if (attachmentElement) attachmentElement.remove();
        
        // Delete from Firebase
        deleteAttachmentFromFirebase(attachmentId);
        
        showToast('Attachment deleted successfully', 'success');
    }
}

function filterAttachments(filterType) {
    const attachmentsGrid = document.getElementById('attachments-grid');
    if (!attachmentsGrid) return;
    
    attachmentsGrid.innerHTML = '';
    
    let filteredAttachments = attachments;
    
    if (filterType === 'image') {
        filteredAttachments = attachments.filter(a => a.fileType.startsWith('image/'));
    } else if (filterType === 'document') {
        filteredAttachments = attachments.filter(a => !a.fileType.startsWith('image/'));
    }
    
    filteredAttachments.forEach(attachment => {
        addAttachmentToUI(attachment);
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Firebase operations for attachments
function saveAttachmentToFirebase(attachment) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('attachments').doc(attachment.id).set(attachment)
        .catch(error => {
            console.error("Error saving attachment: ", error);
            showToast('Error saving attachment', 'error');
        });
}

function loadAttachments() {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('attachments').get()
        .then(querySnapshot => {
            attachments = [];
            const attachmentsGrid = document.getElementById('attachments-grid');
            if (attachmentsGrid) attachmentsGrid.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const attachment = doc.data();
                attachments.push(attachment);
                
                if (attachmentsGrid) {
                    addAttachmentToUI(attachment);
                }
            });
        })
        .catch(error => {
            console.error("Error loading attachments: ", error);
        });
}

function deleteAttachmentFromFirebase(attachmentId) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('attachments').doc(attachmentId).delete()
        .catch(error => {
            console.error("Error deleting attachment: ", error);
        });
}

// ============== COMMENTS SYSTEM ==============
let comments = [];

function initCommentsSystem() {
    // Load comments
    loadComments();
    
    // Setup comment form
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', handleCommentSubmit);
    }
    
    // Populate bill dropdowns
    populateBillDropdowns();
    
    // Filter buttons
    const filterAllBtn = document.getElementById('filter-all-comments');
    const filterImportantBtn = document.getElementById('filter-important-comments');
    const filterMyBtn = document.getElementById('filter-my-comments');
    
    if (filterAllBtn) {
        filterAllBtn.addEventListener('click', () => filterComments('all'));
    }
    
    if (filterImportantBtn) {
        filterImportantBtn.addEventListener('click', () => filterComments('important'));
    }
    
    if (filterMyBtn) {
        filterMyBtn.addEventListener('click', () => filterComments('mine'));
    }
}

function handleCommentSubmit(e) {
    e.preventDefault();
    
    const billId = document.getElementById('comment-bill').value;
    const commentType = document.getElementById('comment-type').value;
    const commentText = document.getElementById('comment-text').value.trim();
    const isImportant = document.getElementById('comment-important').checked;
    
    if (!billId || !commentText) {
        showToast('Please select a bill and enter a comment', 'error');
        return;
    }
    
    const comment = {
        id: Date.now().toString(),
        billId: billId,
        commentType: commentType,
        text: commentText,
        isImportant: isImportant,
        createdBy: auth.currentUser ? auth.currentUser.email : 'Anonymous',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    // Save to local array
    comments.push(comment);
    
    // Save to Firebase
    saveCommentToFirebase(comment);
    
    // Add to UI
    addCommentToUI(comment);
    
    // Reset form
    document.getElementById('comment-form').reset();
    
    showToast('Comment added successfully', 'success');
}

function addCommentToUI(comment) {
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    
    // Get bill info
    const bill = getBillById(comment.billId);
    const billInfo = bill ? `${bill.billNo} - ${bill.description}` : 'Unknown Bill';
    
    const commentDiv = document.createElement('div');
    commentDiv.className = `comment-item mb-3 p-3 rounded ${comment.isImportant ? 'border border-warning bg-warning bg-opacity-10' : 'border'}`;
    commentDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="mb-1">
                    <span class="badge bg-${getCommentTypeColor(comment.commentType)} me-2">
                        ${comment.commentType}
                    </span>
                    ${comment.isImportant ? '<i class="fas fa-exclamation-circle text-warning"></i> ' : ''}
                    ${billInfo}
                </h6>
                <p class="mb-1">${comment.text}</p>
                <small class="text-muted">
                    <i class="fas fa-user"></i> ${comment.createdBy} 
                    • <i class="fas fa-clock"></i> ${new Date(comment.createdAt).toLocaleString()}
                </small>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="editComment('${comment.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteComment('${comment.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    commentsList.appendChild(commentDiv);
}

function editComment(commentId) {
    const comment = comments.find(c => c.id === commentId);
    if (!comment) return;
    
    // Populate form
    document.getElementById('comment-bill').value = comment.billId;
    document.getElementById('comment-type').value = comment.commentType;
    document.getElementById('comment-text').value = comment.text;
    document.getElementById('comment-important').checked = comment.isImportant;
    
    // Remove from array
    const index = comments.findIndex(c => c.id === commentId);
    if (index !== -1) {
        comments.splice(index, 1);
        
        // Remove from UI
        const commentElements = document.querySelectorAll('.comment-item');
        for (let element of commentElements) {
            const editBtn = element.querySelector('[onclick*="editComment"]');
            if (editBtn && editBtn.onclick.toString().includes(commentId)) {
                element.remove();
                break;
            }
        }
        
        // Delete from Firebase
        deleteCommentFromFirebase(commentId);
        
        showToast('Comment loaded for editing', 'info');
    }
}

function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) return;
    
    const index = comments.findIndex(c => c.id === commentId);
    if (index !== -1) {
        comments.splice(index, 1);
        
        // Remove from UI
        const commentElements = document.querySelectorAll('.comment-item');
        for (let element of commentElements) {
            const deleteBtn = element.querySelector('[onclick*="deleteComment"]');
            if (deleteBtn && deleteBtn.onclick.toString().includes(commentId)) {
                element.remove();
                break;
            }
        }
        
        // Delete from Firebase
        deleteCommentFromFirebase(commentId);
        
        showToast('Comment deleted successfully', 'success');
    }
}

function filterComments(filterType) {
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    
    commentsList.innerHTML = '';
    
    let filteredComments = comments;
    
    if (filterType === 'important') {
        filteredComments = comments.filter(c => c.isImportant);
    } else if (filterType === 'mine') {
        const currentUser = auth.currentUser ? auth.currentUser.email : '';
        filteredComments = comments.filter(c => c.createdBy === currentUser);
    }
    
    filteredComments.forEach(comment => {
        addCommentToUI(comment);
    });
}

function getCommentTypeColor(type) {
    const colors = {
        'general': 'secondary',
        'followup': 'info',
        'issue': 'danger',
        'reminder': 'warning'
    };
    return colors[type] || 'secondary';
}

// Firebase operations for comments
function saveCommentToFirebase(comment) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('comments').doc(comment.id).set(comment)
        .catch(error => {
            console.error("Error saving comment: ", error);
            showToast('Error saving comment', 'error');
        });
}

function loadComments() {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('comments').get()
        .then(querySnapshot => {
            comments = [];
            const commentsList = document.getElementById('comments-list');
            if (commentsList) commentsList.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const comment = doc.data();
                comments.push(comment);
                
                if (commentsList) {
                    addCommentToUI(comment);
                }
            });
        })
        .catch(error => {
            console.error("Error loading comments: ", error);
        });
}

function deleteCommentFromFirebase(commentId) {
    if (!auth.currentUser) return;
    
    db.collection('users').doc(auth.currentUser.uid).collection('comments').doc(commentId).delete()
        .catch(error => {
            console.error("Error deleting comment: ", error);
        });
}

// ============== UTILITY FUNCTIONS ==============
function populateBillDropdowns() {
    const billDropdowns = document.querySelectorAll('#attachment-bill, #comment-bill, #copy-source-bill');
    
    if (billDropdowns.length === 0) return;
    
    // Clear existing options except first
    billDropdowns.forEach(dropdown => {
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }
    });
    
    // Collect all bills
    const allBills = [];
    for (const type in bills) {
        bills[type].forEach(bill => {
            allBills.push({
                id: bill.id,
                text: `${bill.billNo} - ${bill.description} (${type})`,
                type: type
            });
        });
    }
    
    // Sort by bill number
    allBills.sort((a, b) => b.id - a.id);
    
    // Add options to all dropdowns
    allBills.forEach(bill => {
        billDropdowns.forEach(dropdown => {
            const option = document.createElement('option');
            option.value = bill.id;
            option.textContent = bill.text;
            dropdown.appendChild(option);
        });
    });
}

function getBillById(billId) {
    for (const type in bills) {
        const bill = bills[type].find(b => b.id === billId);
        if (bill) return bill;
    }
    return null;
}

// ============== INITIALIZE NEW SYSTEMS ==============
document.addEventListener('DOMContentLoaded', function() {
    // Add to existing initialization
    initTemplatesSystem();
    initQuickCopySystem();
    initBatchOperations();
    initAttachmentsSystem();
    initCommentsSystem();
    
    // Update user data loading to include new data
    const originalLoadUserData = loadUserData;
    loadUserData = function() {
        originalLoadUserData();
        
        // Load new data types
        loadTemplates();
        loadAttachments();
        loadComments();
        
        // Populate dropdowns after loading
        setTimeout(populateBillDropdowns, 1000);
    };
});

// Add to navigation event listeners to populate dropdowns when navigating to new pages
const originalNavLinks = document.querySelectorAll('.sidebar a[data-page]');
originalNavLinks.forEach(link => {
    const originalClick = link.onclick;
    link.addEventListener('click', function(e) {
        if (originalClick) originalClick.call(this, e);
        
        // Populate dropdowns after navigation
        setTimeout(populateBillDropdowns, 500);
    });
});

// Add new pages to the page list
const newPages = ['templates', 'batch-operations', 'attachments', 'comments'];
newPages.forEach(pageId => {
    const page = document.getElementById(pageId);
    if (page) {
        pages = document.querySelectorAll('.page');
    }
});

// Add to the navLinks NodeList
newPages.forEach(pageId => {
    const link = document.querySelector(`.sidebar a[data-page="${pageId}"]`);
    if (link) {
        navLinks = document.querySelectorAll('.sidebar a[data-page]');
    }
});

// Utility function to show quick copy modal
window.showQuickCopyModal = function() {
    populateBillDropdowns();
    const modal = new bootstrap.Modal(document.getElementById('quickCopyModal'));
    modal.show();
};

window.showBulkDeleteModal = function() {
    // Navigate to batch operations page
    document.querySelector('.sidebar a[data-page="batch-operations"]').click();
};

window.showBulkExportModal = function() {
    // Navigate to batch operations page
    document.querySelector('.sidebar a[data-page="batch-operations"]').click();
};

        // ============== MISSING FUNCTIONS ==============

// Add this function to handle CSV export for batch operations
function batchExportAsCSV() {
    const selectedCheckboxes = document.querySelectorAll('#batch-bills-list .bill-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select bills to export', 'error');
        return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    csvContent += "Bill No,Date,Type,Description,Amount (RM)\n";
    
    // Add selected bills data
    selectedCheckboxes.forEach((checkbox, index) => {
        const row = checkbox.closest('tr');
        const cells = row.querySelectorAll('td');
        
        const billData = [
            `"${cells[2].textContent}"`,        // Bill No
            `"${cells[1].textContent}"`,        // Date
            `"${cells[3].textContent}"`,        // Type
            `"${cells[4].textContent}"`,        // Description
            `"${cells[5].textContent}"`         // Amount
        ];
        
        csvContent += billData.join(',') + '\n';
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `batch-export-${new Date().toISOString().slice(0, 10)}.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    document.body.removeChild(link);
    
    showToast(`Exported ${selectedCheckboxes.length} bill(s) as CSV`, 'success');
}

// Update the initBatchOperations function to fix the reference
function initBatchOperations() {
    // Load bills for batch operations
    loadBatchBills();
    
    // Event listeners
    const applyFilterBtn = document.getElementById('apply-batch-filter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', loadBatchBills);
    }
    
    const selectAllBatch = document.getElementById('select-all-batch');
    if (selectAllBatch) {
        selectAllBatch.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#batch-bills-list .bill-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // Batch operations buttons
    const batchCopyBtn = document.getElementById('batch-copy');
    if (batchCopyBtn) {
        batchCopyBtn.addEventListener('click', batchCopyBills);
    }
    
    const batchDeleteBtn = document.getElementById('batch-delete');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', batchDeleteBills);
    }
    
    const batchExportPdfBtn = document.getElementById('batch-export-pdf');
    if (batchExportPdfBtn) {
        batchExportPdfBtn.addEventListener('click', batchExportAsPDF);
    }
    
    const batchExportCsvBtn = document.getElementById('batch-export-csv');
    if (batchExportCsvBtn) {
        // Fixed: Use the defined batchExportAsCSV function
        batchExportCsvBtn.addEventListener('click', batchExportAsCSV);
    }
}

// Make sure these functions are available globally
window.showQuickCopyModal = function() {
    populateBillDropdowns();
    const modal = new bootstrap.Modal(document.getElementById('quickCopyModal'));
    modal.show();
};

window.showBulkDeleteModal = function() {
    // Navigate to batch operations page
    document.querySelector('.sidebar a[data-page="batch-operations"]').click();
};

window.showBulkExportModal = function() {
    // Navigate to batch operations page
    document.querySelector('.sidebar a[data-page="batch-operations"]').click();
};

        // Add this function to handle login errors
function handleLoginError(error) {
    let errorMessage = 'Login failed. Please try again.';
    
    switch (error.code) {
        case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
        case 'auth/wrong-password':
            errorMessage = 'Incorrect password. Please try again.';
            break;
        case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
        case 'auth/user-disabled':
            errorMessage = 'This account has been disabled.';
            break;
        case 'auth/too-many-requests':
            errorMessage = 'Too many failed attempts. Please try again later.';
            break;
    }
    
    loginError.textContent = errorMessage;
    loginError.style.display = 'block';
    
    // Add shake animation to form
    const authContainer = document.getElementById('auth-container');
    authContainer.classList.add('shake');
    setTimeout(() => {
        authContainer.classList.remove('shake');
    }, 500);
}

        // ============== ENHANCED REGISTRATION SYSTEM ==============
function initEnhancedRegistration() {
    // Password toggle functionality
    const toggleRegisterPassword = document.getElementById('toggle-register-password');
    const toggleConfirmPassword = document.getElementById('toggle-confirm-password');
    const registerPassword = document.getElementById('register-password');
    const confirmPassword = document.getElementById('confirm-password');
    
    if (toggleRegisterPassword && registerPassword) {
        toggleRegisterPassword.addEventListener('click', function() {
            const type = registerPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            registerPassword.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    if (toggleConfirmPassword && confirmPassword) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    // Real-time password validation
    if (registerPassword) {
        registerPassword.addEventListener('input', function() {
            validatePassword(this.value);
            checkPasswordMatch();
        });
    }
    
    if (confirmPassword) {
        confirmPassword.addEventListener('input', checkPasswordMatch);
    }
    
    // Email validation
    const emailInput = document.getElementById('register-email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            validateEmailFormat(this.value);
        });
    }
    
    // Form submission - 修复这里
    const registerForm = document.getElementById('enhanced-register-form');
    if (registerForm) {
        // 移除旧的监听器
        registerForm.removeEventListener('submit', handleEnhancedRegistration);
        
        // 添加新的监听器
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log("Register form submitted");
            handleEnhancedRegistration();
        });
        
        // 修复注册按钮的点击事件
        const registerBtn = document.getElementById('register-btn');
        if (registerBtn) {
            registerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("Register button clicked");
                handleEnhancedRegistration();
            });
        }
    }
}

function validatePassword(password) {
    const passwordStrength = document.getElementById('password-strength');
    if (!passwordStrength) return;
    
    let strength = 0;
    const messages = [];
    
    // Length check
    if (password.length >= 8) strength += 1;
    else messages.push('at least 8 characters');
    
    // Uppercase & lowercase
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
    else messages.push('mix of uppercase & lowercase');
    
    // Numbers
    if (/\d/.test(password)) strength += 1;
    else messages.push('include numbers');
    
    // Special characters
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    else messages.push('include special characters');
    
    // Update UI
    const strengthLabels = ['Very Weak', 'Weak', 'Fair', 'Strong', 'Very Strong'];
    const strengthColors = ['danger', 'warning', 'info', 'success', 'success'];
    const strengthPercent = Math.min((strength + 1) * 20, 100);
    
    passwordStrength.innerHTML = `
        <div class="progress" style="height: 8px; margin-bottom: 5px;">
            <div class="progress-bar bg-${strengthColors[strength]}" 
                 role="progressbar" style="width: ${strengthPercent}%"></div>
        </div>
        <small class="d-block">${strengthLabels[strength]} ${messages.length > 0 ? ' - Needs: ' + messages.join(', ') : ''}</small>
    `;
    
    return strength >= 2; // At least "Fair" strength
}

function checkPasswordMatch() {
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('confirm-password').value;
    const feedback = document.getElementById('password-match-feedback');
    
    if (!feedback) return;
    
    if (!confirm) {
        feedback.textContent = '';
        feedback.className = 'form-text';
        return;
    }
    
    if (password === confirm) {
        feedback.textContent = '✓ Passwords match';
        feedback.className = 'form-text text-success';
        return true;
    } else {
        feedback.textContent = '✗ Passwords do not match';
        feedback.className = 'form-text text-danger';
        return false;
    }
}

function validateEmailFormat(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function validateEnhancedRegistration() {
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('confirm-password').value;
    const company = document.getElementById('register-company').value.trim();
    const terms = document.getElementById('register-terms').checked;
    
    // Clear previous errors
    document.getElementById('register-error').style.display = 'none';
    
    // Validate required fields
    if (!email || !password || !confirm || !company) {
        showRegistrationError('Please fill in all required fields (*)');
        return false;
    }
    
    if (!terms) {
        showRegistrationError('You must agree to the Terms & Conditions');
        return false;
    }
    
    // Validate email format
    if (!validateEmailFormat(email)) {
        showRegistrationError('Please enter a valid email address');
        return false;
    }
    
    // Validate password strength
    if (password.length < 8) {
        showRegistrationError('Password must be at least 8 characters long');
        return false;
    }
    
    if (!validatePassword(password)) {
        showRegistrationError('Password is too weak. Please use a stronger password');
        return false;
    }
    
    // Validate password match
    if (!checkPasswordMatch()) {
        showRegistrationError('Passwords do not match');
        return false;
    }
    
    // Validate company name
    if (company.length < 2) {
        showRegistrationError('Company name must be at least 2 characters');
        return false;
    }
    
    return true;
}
        
function showRegistrationError(message) {
    const errorDiv = document.getElementById('register-error');
    const errorText = document.getElementById('register-error-text');
    
    if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.style.display = 'block';
    }
    showToast(message, 'error');
}

function showRegistrationSuccess(message) {
    const successDiv = document.getElementById('register-success');
    const successText = document.getElementById('register-success-text');
    
    if (successDiv && successText) {
        successText.textContent = message;
        successDiv.style.display = 'block';
    }
}

function handleEnhancedRegistration() {
    if (!validateEnhancedRegistration()) {
        return;
    }
    
    const registerBtn = document.getElementById('register-btn');
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    
    // 显示加载状态
    const originalText = registerBtn.innerHTML;
    registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
    registerBtn.disabled = true;
    
    // 清除错误信息
    document.getElementById('register-error').style.display = 'none';
    
    console.log("Starting registration for:", email);
    
    // 创建用户（简化版）
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            console.log("User created:", user.uid);
            
            // 发送验证邮件
            return user.sendEmailVerification();
        })
        .then(() => {
            console.log("Verification email sent");
            
            // 保存用户数据到 Firestore
            return db.collection('users').doc(auth.currentUser.uid).set({
                email: email,
                companyName: document.getElementById('register-company').value.trim(),
                phone: document.getElementById('register-phone').value.trim() || null,
                address: document.getElementById('register-address').value.trim() || null,
                businessType: document.getElementById('register-business-type').value || 'other',
                newsletterSubscription: document.getElementById('register-newsletter').checked,
                emailVerified: false,
                accountType: 'free',
                accountStatus: 'active',
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                settings: {
                    currency: 'RM',
                    language: 'en',
                    dateFormat: 'DD/MM/YYYY',
                    taxRate: 6.0,
                    notifications: true
                }
            }, { merge: true });
        })
        .then(() => {
            // 成功处理
            registerBtn.innerHTML = '<i class="fas fa-check"></i> Account Created!';
            document.getElementById('register-success').style.display = 'block';
            document.getElementById('register-success-text').textContent = 
                'Registration successful! Please check your email to verify your account.';
            
            showToast('Registration successful! Verification email sent.', 'success');
            
            // 3秒后跳转到登录
            setTimeout(() => {
                auth.signOut().then(() => {
                    console.log("Signed out after registration");
                    
                    // 切换到登录页面
                    document.getElementById('register-section').style.display = 'none';
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('email').value = email;
                    
                    // 重置表单和按钮
                    document.getElementById('enhanced-register-form').reset();
                    registerBtn.innerHTML = originalText;
                    registerBtn.disabled = false;
                    document.getElementById('register-success').style.display = 'none';
                    
                    showToast('Please verify your email before logging in', 'info');
                });
            }, 3000);
        })
        .catch((error) => {
            // 恢复按钮状态
            registerBtn.innerHTML = originalText;
            registerBtn.disabled = false;
            
            // 显示具体错误
            let errorMessage = 'Registration failed. ';
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already registered.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address.';
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = 'Email/password accounts are not enabled.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password must be at least 6 characters.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'Network error. Please check your connection.';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'This account has been disabled.';
                    break;
                default:
                    errorMessage = error.message || 'Please try again.';
            }
            
            // 显示错误
            document.getElementById('register-error-text').textContent = errorMessage;
            document.getElementById('register-error').style.display = 'block';
            
            showToast(errorMessage, 'error');
            console.error("Registration error: ", error);
        });
}

        // 在最后添加这个函数，确保 DOM 完全加载
function initializeAfterDOMReady() {
    console.log("Initializing after DOM ready...");
    
    // 检查所有必要的元素
    const requiredElements = [
        'auth-container',
        'main-container',
        'login-section',
        'register-section',
        'login-btn',
        'register-btn'
    ];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Element #${id} not found!`);
        }
    });
    
    // 延迟初始化图表和其他组件
    setTimeout(() => {
        try {
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
                performanceChartInstance = null;
            }
            if (profitLossChartInstance) {
                profitLossChartInstance.destroy();
                profitLossChartInstance = null;
            }
            
            initCharts();
            console.log("Charts re-initialized");
        } catch (error) {
            console.error("Error re-initializing charts:", error);
        }
    }, 1000);
}

// 使用多个事件监听器确保 DOM 就绪
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAfterDOMReady);
} else {
    setTimeout(initializeAfterDOMReady, 500);
}

// 额外的安全措施
window.addEventListener('load', function() {
    console.log("Window fully loaded, final initialization...");
    
    // 重新绑定所有事件监听器
    setTimeout(() => {
        bindEventListeners();
        updateAllUI();
    }, 500);
});

// 修复事件监听器绑定的函数
function bindEventListeners() {
    console.log("Binding event listeners...");
    
    // 重新绑定重要的按钮事件
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    
    if (loginBtn && !loginBtn.hasAttribute('data-bound')) {
        loginBtn.setAttribute('data-bound', 'true');
        loginBtn.addEventListener('click', function(e) {
            console.log("Login button clicked");
            // 原有的登录处理逻辑
        });
    }
    
    if (registerBtn && !registerBtn.hasAttribute('data-bound')) {
        registerBtn.setAttribute('data-bound', 'true');
        registerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log("Register button clicked");
            handleEnhancedRegistration();
        });
    }
    
    // 重新绑定导航链接
    document.querySelectorAll('.sidebar a[data-page]').forEach(link => {
        if (!link.hasAttribute('data-bound')) {
            link.setAttribute('data-bound', 'true');
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetPage = this.getAttribute('data-page');
                console.log("Navigating to:", targetPage);
                // 原有的导航逻辑
            });
        }
    });
}

function updateAllUI() {
    try {
        // 更新所有页面的UI状态
        const activePage = document.querySelector('.page.active');
        if (activePage) {
            const pageId = activePage.id;
            console.log("Updating UI for page:", pageId);
            
            // 根据页面ID更新相应内容
            switch(pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'profit-loss':
                    updateProfitLoss();
                    break;
                case 'progress-tracking':
                    updateProgressView();
                    break;
                case 'inventory-tracking':
                    updateInventoryList();
                    break;
            }
        }
    } catch (error) {
        console.error("Error updating UI:", error);
    }
}
// Social Sign-up Functions
function socialSignUp(provider) {
    let authProvider;
    
    switch(provider) {
        case 'google':
            authProvider = new firebase.auth.GoogleAuthProvider();
            break;
        case 'facebook':
            authProvider = new firebase.auth.FacebookAuthProvider();
            break;
        case 'github':
            authProvider = new firebase.auth.GithubAuthProvider();
            break;
        default:
            return;
    }
    
    // Add additional scopes if needed
    if (provider === 'google') {
        authProvider.addScope('email');
        authProvider.addScope('profile');
    }
    
    auth.signInWithPopup(authProvider)
        .then((result) => {
            const user = result.user;
            const additionalInfo = result.additionalUserInfo;
            
            // Prepare user data
            const userData = {
                email: user.email,
                displayName: user.displayName || additionalInfo?.profile?.name,
                companyName: user.displayName || 'Individual User',
                photoURL: user.photoURL,
                provider: provider,
                emailVerified: user.emailVerified,
                accountType: 'free',
                accountStatus: 'active',
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                settings: {
                    currency: 'RM',
                    language: 'en',
                    dateFormat: 'DD/MM/YYYY',
                    taxRate: 6.0,
                    notifications: true
                }
            };
            
            // Save user data to Firestore
            return db.collection('users').doc(user.uid).set(userData, { merge: true });
        })
        .then(() => {
            showToast(`Successfully signed up with ${provider}!`, 'success');
            // Redirect to main app
            authContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            loadUserData();
        })
        .catch((error) => {
            console.error(`${provider} sign-up error: `, error);
            
            let errorMessage = `${provider} sign-up failed. Please try again.`;
            if (error.code === 'auth/popup-closed-by-user') {
                errorMessage = 'Sign-up was cancelled.';
            } else if (error.code === 'auth/account-exists-with-different-credential') {
                errorMessage = 'An account already exists with this email. Please use email/password login.';
            }
            
            showToast(errorMessage, 'error');
        });
}
        // 在页面中添加重新发送验证邮件的按钮
function addResendVerificationButton(email) {
    const loginForm = document.getElementById('login-section');
    if (!loginForm || document.getElementById('resend-verification-btn')) return;
    
    const resendHTML = `
        <div class="alert alert-info mt-3" id="verification-alert">
            <p class="mb-1"><strong>Email Verification Required</strong></p>
            <p class="mb-2 small">Please verify your email (${email}) to access the system.</p>
            <button class="btn btn-sm btn-outline-primary" id="resend-verification-btn">
                <i class="fas fa-paper-plane"></i> Resend Verification Email
            </button>
        </div>
    `;
    
    loginForm.insertAdjacentHTML('beforeend', resendHTML);
    
    document.getElementById('resend-verification-btn').addEventListener('click', function() {
        auth.fetchSignInMethodsForEmail(email)
            .then((providers) => {
                if (providers.length > 0) {
                    // 重新发送验证邮件
                    return auth.sendPasswordResetEmail(email);
                }
                throw new Error('Email not registered');
            })
            .then(() => {
                showToast('Verification email resent. Please check your inbox.', 'success');
            })
            .catch(error => {
                console.error("Error resending verification:", error);
                showToast('Error resending verification email. Please try again.', 'error');
            });
    });
}

        // 在 handleEnhancedRegistration 函数开始处添加：
console.log("Starting registration process for:", email);
// 在每个步骤后添加：
console.log("User created successfully:", user.uid);
console.log("Verification email sent");
console.log("User data saved to Firestore");

        // 安全的 DOM 操作包装函数
function safeDOMOperation(elementId, operation) {
    const element = document.getElementById(elementId);
    if (!element) {
        console.warn(`Element #${elementId} not found for operation:`, operation);
        return false;
    }
    
    try {
        return operation(element);
    } catch (error) {
        console.error(`Error in DOM operation on #${elementId}:`, error);
        return false;
    }
}

// 安全地切换页面
function navigateToPage(pageId) {
    safeDOMOperation('main-container', (container) => {
        // 隐藏所有页面
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        
        // 显示目标页面
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            return true;
        }
        return false;
    });
}

// 安全地显示/隐藏元素
function toggleElementVisibility(elementId, show) {
    safeDOMOperation(elementId, (element) => {
        element.style.display = show ? 'block' : 'none';
        return true;
    });
}
    </script>
</body>
    <footer style="text-align:center; padding: 10px; margin-top:20px; color:#666; font-size:14px;">
    Developed by Tan Jun Yuan
</footer>

</html>
