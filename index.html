<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Billing Management System</title>
    <!-- Firebase App & Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;
    --bg-color: #f8f9fa;
    --text-color: #333;
    --card-bg: white;
    --sidebar-bg: var(--primary-color);
    --border-color: #ddd;
}

        [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --card-bg: #2d2d2d;
    --primary-color: #1e3a5f;
    --sidebar-bg: #1e3a5f;
    --border-color: #444;
    --light-color: #333;
}

        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
}

        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
/* 确保auth-container正确隐藏 */
.auth-container.hidden {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
}
        
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
            border-radius: 10px;
        }
        
        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
        }
        
        .sidebar a:hover {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .sidebar a.active {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .content {
            margin-left: 220px;
            padding: 20px;
        }
        
        .page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .page.active {
            display: block;
        }
        
        .bill-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .bill-table th, .bill-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .bill-table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .bill-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .bill-table tr:hover {
            background-color: #ddd;
        }
        
        .action-btn {
            margin: 0 5px;
            cursor: pointer;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .profit {
            color: #27ae60;
        }
        
        .loss {
            color: #e74c3c;
        }
        
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .chart-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    position: relative; /* 添加相对定位 */
    height: 400px; /* 固定高度 */
    width: 100%; /* 确保宽度100% */
}
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        .customer-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .customer-actions {
            margin-top: 10px;
        }
        
        /* Inventory specific styles */
        .low-stock {
            background-color: #ffe6e6;
        }
        
        .out-of-stock {
            background-color: #ffcccc;
        }
        
        .in-stock {
            background-color: #e6ffe6;
        }
        
        .stock-alert {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .alert-low {
            background-color: #ffcccc;
            color: #cc0000;
        }
        
        .alert-out {
            background-color: #ff9999;
            color: #990000;
        }
        
        .inventory-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .inventory-actions {
            margin-top: 10px;
        }
        
        /* Editable breakdown styles */
        .breakdown-table td:last-child {
            text-align: center;
            width: 100px;
        }
        
        .breakdown-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .editable-field {
            border: 1px dashed transparent;
            padding: 3px 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .editable-field:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .editable-field:focus {
            outline: none;
            border: 1px solid #3498db;
            background-color: #fff;
        }
        
        /* Progress tracking styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-recorded {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .progress-filter {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .progress-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .progress-card h5 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-update {
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .progress-update p {
            margin: 0;
            font-size: 14px;
        }
        
        .progress-update .date {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                width: 180px;
            }
            
            .content {
                margin-left: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }
            
            .content {
                margin-left: 0;
            }
            
            .dashboard-stats {
                flex-direction: column;
            }
            
            .progress-summary {
                flex-direction: column;
            }
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: rgba(255, 255, 255, 0.95);
            border-left: 4px solid;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .toast-success {
            border-left-color: #28a745;
        }
        
        .toast-error {
            border-left-color: #dc3545;
        }
        
        .toast-info {
            border-left-color: #17a2b8;
        }

        /* Map link styles */
        .map-link {
            color: #3498db;
            text-decoration: none;
        }
        
        .map-link:hover {
            text-decoration: underline;
        }

        /* 在现有样式末尾添加以下内容 */

/* 登录页面增强样式 */
.auth-container {
    max-width: 440px;
    margin: 80px auto;
    padding: 40px 30px;
    background: linear-gradient(145deg, var(--card-bg), color-mix(in srgb, var(--card-bg) 90%, var(--text-color)));
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.auth-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
}

.welcome-message h3 {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 5px;
}

.welcome-message p {
    color: var(--text-color);
    opacity: 0.8;
}

.social-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.divider-with-text {
    display: flex;
    align-items: center;
    text-align: center;
    color: var(--text-color);
    opacity: 0.6;
}

.divider-with-text::before,
.divider-with-text::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.divider-with-text span {
    padding: 0 15px;
    font-size: 14px;
}

.input-group-text {
    background-color: var(--light-color);
    border-color: var(--border-color);
    color: var(--text-color);
}

.form-control:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    transform: translateY(-2px);
}

/* 注册页面样式 */
#register-section {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 加载状态 */
.loading-spinner {
    display: none;
    text-align: center;
    margin: 20px 0;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
    color: var(--secondary-color);
}

/* 成功/错误消息动画 */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.5s ease-in-out;
}

/* 浮动标签效果 */
.floating-label {
    position: relative;
    margin-bottom: 1.5rem;
}

.floating-label input {
    padding-top: 1.5rem;
    padding-bottom: 0.5rem;
}

.floating-label label {
    position: absolute;
    top: 0;
    left: 12px;
    padding: 0.375rem 0;
    font-size: 0.875rem;
    color: var(--text-color);
    opacity: 0.7;
    transition: all 0.2s ease;
    pointer-events: none;
}

.floating-label input:focus + label,
.floating-label input:not(:placeholder-shown) + label {
    top: -10px;
    left: 8px;
    font-size: 0.75rem;
    opacity: 1;
    color: var(--secondary-color);
}

/* 响应式调整 */
@media (max-width: 576px) {
    .auth-container {
        margin: 40px auto;
        padding: 30px 20px;
        border-radius: 10px;
    }
    
    .social-login .d-flex {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .social-btn {
        margin: 3px;
    }
}

        .summary-card, .stat-card, .form-section, .chart-container, .page, 
.progress-filter, .progress-card, .progress-update, .toast {
    background-color: var(--card-bg);
    transition: background-color 0.3s;
}

.sidebar {
    background-color: var(--sidebar-bg);
}

.bill-table th {
    background-color: var(--primary-color);
}

.bill-table th, .bill-table td {
    border-color: var(--border-color);
}

.bill-table tr:nth-child(even) {
    background-color: color-mix(in srgb, var(--card-bg) 90%, var(--text-color));
}

/* 在现有样式之后添加主题切换按钮样式 */
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.theme-toggle i {
    font-size: 20px;
    color: var(--text-color);
}

/* Customer search results */
.customer-search-results {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.customer-result-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.customer-result-item:hover {
    background-color: #f5f5f5;
}

.customer-result-item:last-child {
    border-bottom: none;
}

/* Manual records table */
.manual-record-row.revenue {
    background-color: rgba(39, 174, 96, 0.1);
}

.manual-record-row.expense {
    background-color: rgba(231, 76, 60, 0.1);
}

/* 在响应式调整之前添加 */
@media (max-width: 768px) {
    .theme-toggle {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
    }
    
    .customer-search-results {
        position: relative;
        margin-top: 5px;
    }
}
        /* Template and Batch Operations Styles */
.template-card, .batch-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.template-card:hover, .batch-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.comment-item {
    transition: all 0.3s ease;
}

.comment-item:hover {
    background-color: var(--light-color);
}

.attachment-thumbnail {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
}

.attachment-thumbnail:hover {
    opacity: 0.8;
}

/* Batch operations checkbox */
.batch-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Comment type badges */
.badge-general {
    background-color: #6c757d;
}

.badge-followup {
    background-color: #17a2b8;
}

.badge-issue {
    background-color: #dc3545;
}

.badge-reminder {
    background-color: #ffc107;
    color: #000;
}

/* Attachment preview modal */
#attachmentPreviewModal .modal-xl {
    max-width: 90%;
}

/* Template actions */
.template-actions {
    opacity: 0;
    transition: opacity 0.3s;
}

tr:hover .template-actions {
    opacity: 1;
}

/* Responsive adjustments for new features */
@media (max-width: 768px) {
    .template-actions {
        opacity: 1;
    }
    
    .attachment-thumbnail {
        height: 120px;
    }
}

        /* Enhanced Registration Styles */
.floating-label-group {
    position: relative;
    margin-bottom: 1.5rem;
}

.floating-label-group label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.floating-label-group .form-text {
    font-size: 0.85rem;
    margin-top: 0.25rem;
    color: #6c757d;
}

.password-strength-meter {
    margin-top: 0.5rem;
}

.password-strength-meter .progress {
    border-radius: 4px;
}

.password-strength-meter small {
    font-size: 0.8rem;
    display: block;
    margin-top: 0.25rem;
}

.form-check-label a {
    color: var(--secondary-color);
    text-decoration: none;
}

.form-check-label a:hover {
    text-decoration: underline;
}

.social-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.terms-link {
    color: var(--secondary-color);
    text-decoration: none;
}

.terms-link:hover {
    text-decoration: underline;
    color: var(--primary-color);
}

.system-status {
    font-size: 0.85rem;
}

/* Form validation styles */
.text-success {
    color: #28a745 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.is-valid {
    border-color: #28a745 !important;
}

.is-invalid {
    border-color: #dc3545 !important;
}

/* Modal styles */
.modal-content {
    background-color: var(--card-bg);
    color: var(--text-color);
}

.modal-header {
    border-bottom-color: var(--border-color);
}

.modal-footer {
    border-top-color: var(--border-color);
}

/* Responsive adjustments for registration */
@media (max-width: 576px) {
    .floating-label-group {
        margin-bottom: 1rem;
    }
    
    .social-login .d-flex {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .social-btn {
        margin: 3px;
    }
}

/* 确保auth-container完全隐藏 */
#auth-container.hidden {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* 确保main-container正确显示 */
#main-container.visible {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
<div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
</div>
    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Login Section -->
    <div id="auth-container" class="auth-container">
        <div class="logo">
            <h1>Dealer<span>BILL</span></h1>
            <p>Billing Management System</p>
        </div>
        
        <!-- 在现有的 login-section 内部，修改如下： -->

<div id="login-section">
    <!-- 添加欢迎信息 -->
    <div class="welcome-message text-center mb-4">
        <h3>Welcome Back!</h3>
        <p class="text-muted">Sign in to manage your billing system</p>
    </div>
    
    <!-- 社交登录选项 -->
    <div class="social-login mb-3">
        <p class="text-center mb-2">Or sign in with</p>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-primary social-btn">
                <i class="fab fa-facebook"></i>
            </button>
            <button class="btn btn-outline-danger social-btn">
                <i class="fab fa-google"></i>
            </button>
            <button class="btn btn-outline-dark social-btn">
                <i class="fab fa-github"></i>
            </button>
        </div>
    </div>
    
    <!-- 分隔线 -->
    <div class="divider-with-text my-4">
        <span>or continue with email</span>
    </div>
    
    <div class="mb-3">
        <label for="email" class="form-label">
            <i class="fas fa-envelope me-2"></i>Email Address
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="email" class="form-control" id="email" placeholder="your.email@example.com">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="password" class="form-label">
            <i class="fas fa-lock me-2"></i>Password
        </label>
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-key"></i></span>
            <input type="password" class="form-control" id="password" placeholder="Enter your password">
            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>
    
    <!-- 记住我和忘记密码 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="rememberMe">
            <label class="form-check-label" for="rememberMe">
                Remember me
            </label>
        </div>
        <a href="#" id="forgot-password" class="text-decoration-none">Forgot password?</a>
    </div>
    
    <div id="login-error" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
        Invalid email or password. Please try again.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <button id="login-btn" class="btn btn-primary w-100 mb-3 py-2">
        <i class="fas fa-sign-in-alt me-2"></i>Sign In
    </button>
    
    <button id="google-login-btn" class="btn btn-outline-danger w-100 mb-3 py-2">
        <i class="fab fa-google me-2"></i> Continue with Google
    </button>
    
    <div class="text-center mt-3">
        <p>Don't have an account? 
            <a href="#" id="show-register" class="text-decoration-none fw-bold">Sign up now</a>
        </p>
    </div>
    
    <!-- 系统状态 -->
    <div class="system-status mt-4 pt-3 border-top text-center">
        <small class="text-muted">
            <i class="fas fa-shield-alt me-1"></i>Secure login • 
            <i class="fas fa-bolt ms-2 me-1"></i>24/7 Access
        </small>
    </div>
</div>

<!-- 添加忘记密码模态框 -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <div class="mb-3">
                    <label for="reset-email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="reset-email" placeholder="your.email@example.com">
                </div>
                <div id="reset-message" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="send-reset-link">Send Reset Link</button>
            </div>
        </div>
    </div>
</div>
        
        <!-- Enhanced Registration Section -->
<div id="register-section" style="display: none;">
    <div class="welcome-message text-center mb-4">
        <h3>Create Account</h3>
        <p class="text-muted">Join DealerBILL to streamline your billing management</p>
    </div>
    
    <!-- Social Sign-up Options -->
    <div class="social-login mb-3">
        <p class="text-center mb-2">Or sign up with</p>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-primary social-btn" onclick="socialSignUp('facebook')">
                <i class="fab fa-facebook"></i>
            </button>
            <button class="btn btn-outline-danger social-btn" onclick="socialSignUp('google')">
                <i class="fab fa-google"></i>
            </button>
            <button class="btn btn-outline-dark social-btn" onclick="socialSignUp('github')">
                <i class="fab fa-github"></i>
            </button>
        </div>
    </div>
    
    <!-- Divider -->
    <div class="divider-with-text my-4">
        <span>or register with email</span>
    </div>
    
    <!-- Registration Form -->
    <form id="enhanced-register-form">
        <!-- Email -->
        <div class="mb-3 floating-label-group">
            <label for="register-email" class="form-label">
                <i class="fas fa-envelope me-2"></i>Email Address *
            </label>
            <input type="email" class="form-control" id="register-email" 
                   placeholder="your.email@example.com" required>
            <div id="email-feedback" class="form-text">
                We'll send a verification email to this address
            </div>
        </div>
        
        <!-- Password -->
        <div class="mb-3 floating-label-group">
            <label for="register-password" class="form-label">
                <i class="fas fa-lock me-2"></i>Password *
            </label>
            <div class="input-group">
                <input type="password" class="form-control" id="register-password" 
                       placeholder="Create a strong password" required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-register-password">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="password-strength" class="password-strength-meter mt-2"></div>
            <div id="password-feedback" class="form-text">
                Minimum 8 characters with letters, numbers, and symbols
            </div>
        </div>
        
        <!-- Confirm Password -->
        <div class="mb-3 floating-label-group">
            <label for="confirm-password" class="form-label">
                <i class="fas fa-lock me-2"></i>Confirm Password *
            </label>
            <div class="input-group">
                <input type="password" class="form-control" id="confirm-password" 
                       placeholder="Re-enter your password" required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="password-match-feedback" class="form-text"></div>
        </div>
        
        <!-- Company/Business Name -->
        <div class="mb-3 floating-label-group">
            <label for="register-company" class="form-label">
                <i class="fas fa-building me-2"></i>Company/Business Name *
            </label>
            <input type="text" class="form-control" id="register-company" 
                   placeholder="Your company name" required>
            <div id="company-feedback" class="form-text">
                This will appear on your bills and invoices
            </div>
        </div>
        
        <!-- Phone Number -->
        <div class="mb-3 floating-label-group">
            <label for="register-phone" class="form-label">
                <i class="fas fa-phone me-2"></i>Phone Number
            </label>
            <input type="tel" class="form-control" id="register-phone" 
                   placeholder="+60 12-345 6789">
            <div id="phone-feedback" class="form-text">
                Optional - for important notifications
            </div>
        </div>
        
        <!-- Address -->
        <div class="mb-3 floating-label-group">
            <label for="register-address" class="form-label">
                <i class="fas fa-map-marker-alt me-2"></i>Business Address
            </label>
            <textarea class="form-control" id="register-address" 
                      rows="2" placeholder="Your business address"></textarea>
            <div id="address-feedback" class="form-text">
                Optional - for invoices and shipping
            </div>
        </div>
        
        <!-- Business Type -->
        <div class="mb-3 floating-label-group">
            <label for="register-business-type" class="form-label">
                <i class="fas fa-briefcase me-2"></i>Business Type
            </label>
            <select class="form-select" id="register-business-type">
                <option value="">Select business type</option>
                <option value="retail">Retail</option>
                <option value="wholesale">Wholesale</option>
                <option value="manufacturing">Manufacturing</option>
                <option value="services">Services</option>
                <option value="ecommerce">E-commerce</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <!-- Terms and Conditions -->
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="register-terms" required>
                <label class="form-check-label" for="register-terms">
                    I agree to the 
                    <a href="#" class="terms-link" data-bs-toggle="modal" data-bs-target="#termsModal">Terms & Conditions</a> 
                    and 
                    <a href="#" class="terms-link" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a> *
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="register-newsletter" checked>
                <label class="form-check-label" for="register-newsletter">
                    Subscribe to newsletter for updates and tips
                </label>
            </div>
        </div>
        
        <!-- Error/Success Messages -->
        <div id="register-error" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
            <span id="register-error-text"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div id="register-success" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
            <span id="register-success-text"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Submit Button -->
        <button id="register-btn" type="submit" class="btn btn-primary w-100 mb-3 py-2">
            <i class="fas fa-user-plus me-2"></i>Create Account
        </button>
        
        <div class="text-center mt-3">
            <p>Already have an account? 
                <a href="#" id="show-login" class="text-decoration-none fw-bold">Sign in here</a>
            </p>
        </div>
        
        <!-- Security Note -->
        <div class="system-status mt-4 pt-3 border-top text-center">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>Secure registration • 
                <i class="fas fa-lock ms-2 me-1"></i>Encrypted data
            </small>
        </div>
    </form>
</div>

<!-- Terms & Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms & Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <h6>1. Acceptance of Terms</h6>
                <p>By creating an account on DealerBILL, you agree to these Terms and Conditions...</p>
                <!-- Add full terms content here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <h6>1. Information We Collect</h6>
                <p>We collect information you provide when registering, using our services...</p>
                <!-- Add full privacy policy content here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Main Application -->
    <div id="main-container" class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" style="width: 200px;">
            <div class="logo">
                <h4>Dealer<span>BILL</span></h4>
            </div>
            <a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="#" data-page="periodic-bills"><i class="fas fa-calendar-week"></i> Periodic Bills</a>
            <a href="#" data-page="individual-bills"><i class="fas fa-file-invoice"></i> Individual Bills</a>
            <a href="#" data-page="monthly-bills"><i class="fas fa-calendar-alt"></i> Monthly Bills</a>
            <a href="#" data-page="yearly-bills"><i class="fas fa-calendar"></i> Yearly Bills</a>
            <a href="#" data-page="profit-loss"><i class="fas fa-chart-line"></i> Profit & Loss</a>
            <a href="#" data-page="customer-management"><i class="fas fa-users"></i> Customer Management</a>
            <a href="#" data-page="templates"><i class="fas fa-copy"></i> Bill Templates</a>
            <a href="#" data-page="batch-operations"><i class="fas fa-layer-group"></i> Batch Operations</a>
            <a href="#" data-page="inventory-tracking"><i class="fas fa-box"></i> Inventory Tracking</a>
            <!-- Add progress tracking page -->
            <a href="#" data-page="progress-tracking"><i class="fas fa-clipboard-check"></i> Progress Tracking</a>
            <a href="#" data-page="more"><i class="fas fa-ellipsis-h"></i> More</a>
            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <h2>Dashboard</h2>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <p class="stat-value" id="total-revenue">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Total Expenses</h5>
                        <p class="stat-value" id="total-expenses">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Net Profit</h5>
                        <p class="stat-value profit" id="net-profit">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Inventory Value</h5>
                        <p class="stat-value" id="inventory-value">RM 0.00</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Monthly Performance</h5>
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Recent Bills</h5>
                            <table class="bill-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bill No</th>
                                        <th>Amount (RM)</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-bills">
                                    <!-- Recent bills will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Low Stock Alerts</h5>
                            <div id="low-stock-alerts">
                                <!-- Low stock alerts will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Periodic Bills Page -->
            <div id="periodic-bills" class="page">
                <h2>Periodic Bills</h2>
                <div class="form-section">
                    <h5>Add New Bill</h5>
                    <form id="periodic-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="periodic-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="periodic-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodic-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="periodic-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="periodic-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="periodic-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="periodic-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Bill Items</h5>
                        <button class="btn btn-success" id="generate-periodic-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="periodic-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="periodic-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Individual Bills Page -->
            <div id="individual-bills" class="page">
                <h2>Individual Bills</h2>
                <div class="form-section">
                    <h5>Add New Individual Bill</h5>
                    <form id="individual-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="individual-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="individual-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="individual-description" required>
                                </div>
                            </div>
                        </div>
                        <!-- Enhanced customer selection -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-name" class="form-label">Customer Selection</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="individual-customer-name" 
                                               placeholder="Enter customer name or select from existing customers" 
                                               list="customer-suggestions">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-customer">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <datalist id="customer-suggestions">
                                            <!-- Customer options will be populated dynamically -->
                                        </datalist>
                                    </div>
                                    <div id="customer-search-results" class="customer-search-results" style="display: none;">
                                        <!-- Search results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-address" class="form-label">Customer Address</label>
                                    <input type="text" class="form-control" id="individual-customer-address" 
                                           placeholder="Address will auto-fill or enter manually">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="individual-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="individual-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="individual-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Individual Bill Items</h5>
                        <button class="btn btn-success" id="generate-individual-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Customer</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="individual-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="individual-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Monthly Bills Page -->
            <div id="monthly-bills" class="page">
                <h2>Monthly Bills</h2>
                <div class="form-section">
                    <h5>Add New Monthly Bill</h5>
                    <form id="monthly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="monthly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="monthly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="monthly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="monthly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="monthly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="monthly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="monthly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Monthly Bill Items</h5>
                        <button class="btn btn-success" id="generate-monthly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="monthly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Yearly Bills Page -->
            <div id="yearly-bills" class="page">
                <h2>Yearly Bills</h2>
                <div class="form-section">
                    <h5>Add New Yearly Bill</h5>
                    <form id="yearly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="yearly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="yearly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="yearly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="yearly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="yearly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="yearly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="yearly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Yearly Bill Items</h5>
                        <button class="btn btn-success" id="generate-yearly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="yearly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="yearly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Profit & Loss Page -->
            <div id="profit-loss" class="page">
                <h2>Profit & Loss Analysis</h2>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Revenue</h5>
                            <p class="summary-value profit" id="pl-revenue">RM 0.00</p>
                            <p><small id="revenue-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Expenses</h5>
                            <p class="summary-value loss" id="pl-expenses">RM 0.00</p>
                            <p><small id="expenses-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Revenue vs Expenses (Last 6 Months)</h5>
                    <canvas id="profitLossChart"></canvas>
                </div>
                
                <!-- Manual Revenue/Expense Entry Section -->
                <div class="form-section">
                    <h5>Manual Revenue/Expense Entry</h5>
                    <form id="manual-revenue-expense-form">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-type" class="form-label">Type</label>
                                    <select class="form-select" id="manual-type" required>
                                        <option value="revenue">Revenue</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-category" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="manual-category" 
                                           placeholder="e.g., Product Sales, Rent, Salary" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-amount" class="form-label">Amount (RM)</label>
                                    <input type="number" class="form-control" id="manual-amount" 
                                           step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="manual-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="manual-description" 
                                           placeholder="Detailed description">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="manual-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="manual-date" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Record</button>
                    </form>
                </div>
                
                <!-- Manual Records List -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Manual Revenue & Expenses</h5>
                        <button class="btn btn-success" id="generate-manual-records-pdf">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manual-records-list">
                            <!-- Manual records will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Total Revenue:</td>
                                <td id="manual-revenue-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Total Expenses:</td>
                                <td id="manual-expense-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">Net:</td>
                                <td id="manual-net-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Detailed Breakdown</h5>
                        <button class="btn btn-primary" id="add-breakdown-item">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <table class="bill-table breakdown-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount (RM)</th>
                                <th>Percentage</th>
                                <th>Trend</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pl-breakdown">
                            <!-- Profit/Loss breakdown will be populated here -->
                        </tbody>
                    </table>
                    <div class="breakdown-actions">
                        <button class="btn btn-success" id="save-breakdown">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" id="reset-breakdown">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>Calculate Profit/Loss</h5>
                    <form id="profit-loss-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="revenue" class="form-label">Total Revenue (RM)</label>
                                    <input type="number" class="form-control" id="revenue" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenses" class="form-label">Total Expenses (RM)</label>
                                    <input type="number" class="form-control" id="expenses" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary w-100">Calculate</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert" id="profit-loss-result" style="display: none;">
                                    <h5>Result:</h5>
                                    <p id="result-text"></p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customer Management Page -->
            <div id="customer-management" class="page">
                <h2>Customer Management</h2>
                
                <div class="form-section">
                    <h5>Add New Customer</h5>
                    <form id="customer-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-name" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customer-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customer-email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="customer-phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="customer-address">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Customer</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <h5>Customer List</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Search customers..." id="customer-search">
                        <button class="btn btn-outline-secondary" type="button" id="customer-search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div id="customers-list">
                        <!-- Customers will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Inventory Tracking Page -->
            <div id="inventory-tracking" class="page">
                <h2>Inventory Tracking</h2>
                
                <div class="form-section">
                    <h5>Add New Product</h5>
                    <form id="inventory-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-category" class="form-label">Category</label>
                                    <select class="form-select" id="product-category">
                                        <option value="">Select Category</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Food">Food</option>
                                        <option value="Books">Books</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="product-quantity" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-low-stock" class="form-label">Low Stock Threshold</label>
                                    <input type="number" class="form-control" id="product-low-stock" required min="1" value="10">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-cost" class="form-label">Cost Price (RM)</label>
                                    <input type="number" class="form-control" id="product-cost" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">Selling Price (RM)</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-supplier" class="form-label">Supplier</label>
                                    <input type="text" class="form-control" id="product-supplier">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="product-description" class="form-label">Description</label>
                                    <textarea class="form-control" id="product-description" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Product</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Inventory List</h5>
                        <div>
                            <button class="btn btn-success" id="generate-inventory-pdf">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button class="btn btn-info" id="export-inventory-csv">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn btn-warning" id="add-bill-address">
                                <i class="fas fa-map-marker-alt"></i> Add Bill Address
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search products..." id="inventory-search">
                                <button class="btn btn-outline-secondary" type="button" id="inventory-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-category-filter">
                                <option value="">All Categories</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Food">Food</option>
                                <option value="Books">Books</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-stock-filter">
                                <option value="">All Stock Status</option>
                                <option value="low">Low Stock</option>
                                <option value="out">Out of Stock</option>
                                <option value="in">In Stock</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Cost Price (RM)</th>
                                    <th>Selling Price (RM)</th>
                                    <th>Stock Value (RM)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list">
                                <!-- Inventory items will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" style="text-align: right; font-weight: bold;">Total Inventory Value:</td>
                                    <td id="inventory-total-value" style="font-weight: bold;">RM 0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking Page -->
            <div id="progress-tracking" class="page">
                <h2>Progress Tracking</h2>
                
                <div class="progress-summary">
                    <div class="progress-card">
                        <h5>Total Bills</h5>
                        <p class="value" id="total-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Recorded</h5>
                        <p class="value" id="recorded-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Paid</h5>
                        <p class="value" id="paid-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Overdue</h5>
                        <p class="value" id="overdue-bills-count">0</p>
                    </div>
                </div>
                
                <div class="progress-filter">
                    <h5>Filter Bills</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-status-filter" class="form-label">Status</label>
                                <select class="form-select" id="progress-status-filter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="recorded">Recorded</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-from" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="progress-date-from">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-to" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="progress-date-to">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" id="apply-progress-filter">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Bill Progress</h5>
                        <div>
                            <button class="btn btn-success" id="generate-progress-report">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </button>
                            <button class="btn btn-info" id="add-progress-update">
                                <i class="fas fa-plus"></i> Add Daily Update
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill No</th>
                                    <th>Description</th>
                                    <th>Customer</th>
                                    <th>Amount (RM)</th>
                                    <th>Status</th>
                                    <th>Address Map</th>
                                    <th>Last Updated</th>
                                    <th>Progress Updates</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="progress-bills-list">
                                <!-- Progress bills will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Progress Update Modal -->
                <div class="modal fade" id="progressUpdateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Progress Update</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="progress-update-form">
                                    <input type="hidden" id="progress-bill-id">
                                    <div class="mb-3">
                                        <label for="progress-status" class="form-label">Status</label>
                                        <select class="form-select" id="progress-status" required>
                                            <option value="pending">Pending</option>
                                            <option value="recorded">Recorded</option>
                                            <option value="paid">Paid</option>
                                            <option value="overdue">Overdue</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="progress-notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="progress-notes" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-progress-update">Save Update</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill Address Modal -->
                <div class="modal fade" id="billAddressModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Bill Address</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="bill-address-form">
                                    <input type="hidden" id="address-bill-id">
                                    <div class="mb-3">
                                        <label for="bill-address" class="form-label">Bill Address</label>
                                        <input type="text" class="form-control" id="bill-address" placeholder="Enter full address">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Google Maps Preview</label>
                                        <div id="map-preview" style="height: 200px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                            <p class="text-muted">Enter an address to see a preview</p>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-bill-address">Save Address</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill Templates Page -->
<div id="templates" class="page">
    <h2>Bill Templates</h2>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Save Current Bill as Template</h5>
            <button class="btn btn-primary" id="save-current-template">
                <i class="fas fa-save"></i> Save Current Bill
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="template-name" class="form-label">Template Name</label>
                    <input type="text" class="form-control" id="template-name" placeholder="e.g., Monthly Service Bill">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="template-type" class="form-label">Bill Type</label>
                    <select class="form-select" id="template-type">
                        <option value="individual">Individual Bill</option>
                        <option value="periodic">Periodic Bill</option>
                        <option value="monthly">Monthly Bill</option>
                        <option value="yearly">Yearly Bill</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="template-description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="template-description" rows="2" placeholder="Describe this template..."></textarea>
        </div>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Saved Templates</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" id="refresh-templates">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-danger" id="delete-selected-templates">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="bill-table">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="select-all-templates">
                        </th>
                        <th>Template Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Items Count</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="templates-list">
                    <!-- Templates will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Batch Operations Page -->
<div id="batch-operations" class="page">
    <h2>Batch Operations</h2>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-copy fa-3x mb-3 text-primary"></i>
                    <h5>Quick Copy Bills</h5>
                    <p class="text-muted">Duplicate existing bills with one click</p>
                    <button class="btn btn-primary mt-2" onclick="showQuickCopyModal()">
                        <i class="fas fa-clone"></i> Copy Bills
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-trash-alt fa-3x mb-3 text-primary"></i>
                    <h5>Bulk Delete</h5>
                    <p class="text-muted">Delete multiple bills at once</p>
                    <button class="btn btn-danger mt-2" onclick="showBulkDeleteModal()">
                        <i class="fas fa-trash"></i> Delete Bills
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-file-export fa-3x mb-3 text-primary"></i>
                    <h5>Bulk Export</h5>
                    <p class="text-muted">Export multiple bills to PDF/CSV</p>
                    <button class="btn btn-success mt-2" onclick="showBulkExportModal()">
                        <i class="fas fa-download"></i> Export Bills
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-section">
        <h5>Batch Operations Panel</h5>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="batch-bill-type" class="form-label">Bill Type</label>
                <select class="form-select" id="batch-bill-type">
                    <option value="all">All Types</option>
                    <option value="individual">Individual Bills</option>
                    <option value="periodic">Periodic Bills</option>
                    <option value="monthly">Monthly Bills</option>
                    <option value="yearly">Yearly Bills</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="batch-date-from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="batch-date-from">
            </div>
            <div class="col-md-4">
                <label for="batch-date-to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="batch-date-to">
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all-batch">
                <label class="form-check-label" for="select-all-batch">
                    Select all bills
                </label>
            </div>
            <div>
                <span id="selected-count" class="badge bg-primary me-2">0 selected</span>
                <button class="btn btn-outline-secondary" id="apply-batch-filter">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="bill-table">
                <thead>
                    <tr>
                        <th width="50">Select</th>
                        <th>Date</th>
                        <th>Bill No</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount (RM)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="batch-bills-list">
                    <!-- Bills for batch operations -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-success" id="batch-copy">
                <i class="fas fa-copy"></i> Copy Selected
            </button>
            <button class="btn btn-primary" id="batch-export-pdf">
                <i class="fas fa-file-pdf"></i> Export as PDF
            </button>
            <button class="btn btn-info" id="batch-export-csv">
                <i class="fas fa-file-csv"></i> Export as CSV
            </button>
            <button class="btn btn-danger" id="batch-delete">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>
</div>

<!-- Attachments Page -->
<div id="attachments" class="page">
    <h2>Bill Attachments</h2>
    
    <div class="form-section">
        <h5>Upload Attachment</h5>
        <form id="attachment-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="attachment-bill" class="form-label">Select Bill</label>
                        <select class="form-select" id="attachment-bill" required>
                            <option value="">-- Select a bill --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="attachment-type" class="form-label">Attachment Type</label>
                        <select class="form-select" id="attachment-type">
                            <option value="receipt">Receipt</option>
                            <option value="invoice">Invoice</option>
                            <option value="contract">Contract</option>
                            <option value="photo">Photo</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="attachment-file" class="form-label">File</label>
                <input type="file" class="form-control" id="attachment-file" 
                       accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx" required>
                <div class="form-text">Supported files: Images (JPG, PNG), PDF, Word, Excel</div>
            </div>
            
            <div class="mb-3">
                <label for="attachment-description" class="form-label">Description (Optional)</label>
                <input type="text" class="form-control" id="attachment-description" 
                       placeholder="e.g., Customer signature, Delivery proof">
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload Attachment
            </button>
        </form>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Attachments</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" id="filter-all-attachments">
                    All
                </button>
                <button class="btn btn-outline-secondary" id="filter-images">
                    <i class="fas fa-image"></i> Images
                </button>
                <button class="btn btn-outline-secondary" id="filter-documents">
                    <i class="fas fa-file"></i> Documents
                </button>
            </div>
        </div>
        
        <div class="row" id="attachments-grid">
            <!-- Attachments will be displayed here -->
        </div>
    </div>
</div>

<!-- Comments Page -->
<div id="comments" class="page">
    <h2>Bill Comments</h2>
    
    <div class="form-section">
        <h5>Add Comment</h5>
        <form id="comment-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="comment-bill" class="form-label">Select Bill</label>
                        <select class="form-select" id="comment-bill" required>
                            <option value="">-- Select a bill --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="comment-type" class="form-label">Comment Type</label>
                        <select class="form-select" id="comment-type">
                            <option value="general">General Note</option>
                            <option value="followup">Follow-up</option>
                            <option value="issue">Issue</option>
                            <option value="reminder">Reminder</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="comment-text" class="form-label">Comment</label>
                <textarea class="form-control" id="comment-text" rows="3" 
                          placeholder="Enter your comment here..." required></textarea>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="comment-important">
                    <label class="form-check-label" for="comment-important">
                        Mark as important
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-comment"></i> Add Comment
                </button>
            </div>
        </form>
    </div>
    
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5>Recent Comments</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary active" id="filter-all-comments">
                    All Comments
                </button>
                <button class="btn btn-outline-secondary" id="filter-important-comments">
                    Important Only
                </button>
                <button class="btn btn-outline-secondary" id="filter-my-comments">
                    My Comments
                </button>
            </div>
        </div>
        
        <div id="comments-list">
            <!-- Comments will be loaded here -->
        </div>
    </div>
</div>

<!-- Modals for new features -->
<div class="modal fade" id="quickCopyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Copy Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="copy-source-bill" class="form-label">Select Bill to Copy</label>
                    <select class="form-select" id="copy-source-bill">
                        <option value="">-- Select a bill --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="copy-changes" class="form-label">Make Changes (Optional)</label>
                    <textarea class="form-control" id="copy-changes" rows="3" 
                              placeholder="Enter any changes you want to make to the copied bill..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This will create an exact copy of the selected bill with a new bill number.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-copy-bill">Copy Bill</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachment-preview-title">Attachment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="attachment-preview-content">
                    <!-- Preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="download-attachment" download>
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

            <!-- More Page -->
            <div id="more" class="page">
                <h2>Additional Features</h2>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-3x mb-3 text-primary"></i>
                                <h5>Customer Management</h5>
                                <p>Manage your customer database and track interactions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-box fa-3x mb-3 text-primary"></i>
                                <h5>Inventory Tracking</h5>
                                <p>Monitor stock levels and receive low inventory alerts</p>
                                <button class="btn btn-outline-primary" data-page="inventory-tracking">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3 text-primary"></i>
                                <h5>Advanced Reports</h5>
                                <p>Generate detailed reports and analytics</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cog fa-3x mb-3 text-primary"></i>
                                <h5>Settings</h5>
                                <p>Customize system preferences and user permissions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <!-- 添加到 More 页面中 -->
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-copy fa-3x mb-3 text-primary"></i>
            <h5>Bill Templates</h5>
            <p>Save and manage frequently used bill formats</p>
            <button class="btn btn-outline-primary" data-page="templates">Manage Templates</button>
        </div>
    </div>
</div>
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-file-upload fa-3x mb-3 text-primary"></i>
            <h5>Attachments</h5>
            <p>Upload images and documents to bills</p>
            <button class="btn btn-outline-primary" data-page="attachments">Manage Attachments</button>
        </div>
    </div>
</div>
<div class="col-md-4 mb-4">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-comments fa-3x mb-3 text-primary"></i>
            <h5>Comments</h5>
            <p>Add notes and comments to bills</p>
            <button class="btn btn-outline-primary" data-page="comments">View Comments</button>
        </div>
    </div>
</div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-bell fa-3x mb-3 text-primary"></i>
                                <h5>Notifications</h5>
                                <p>Set up alerts for important events and deadlines</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Data Backup</h5>
                                <p>Automatically backup your data to the cloud</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>System Settings</h5>
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currency" class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option selected>RM (Malaysian Ringgit)</option>
                                        <option>USD (US Dollar)</option>
                                        <option>EUR (Euro)</option>
                                        <option>GBP (British Pound)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language">
                                        <option selected>English</option>
                                        <option>Malay</option>
                                        <option>Chinese</option>
                                        <option>Tamil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date-format" class="form-label">Date Format</label>
                                    <select class="form-select" id="date-format">
                                        <option selected>DD/MM/YYYY</option>
                                        <option>MM/DD/YYYY</option>
                                        <option>YYYY-MM-DD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax-rate" class="form-label">Tax Rate (%)</label>
                                    <input type="number" class="form-control" id="tax-rate" value="6.0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    <label class="form-check-label" for="email-notifications">Enable Email Notifications</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and App Initialization -->
    <script>
        // ============== 主应用程序初始化 ==============
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM 完全加载，初始化应用...");
    
    // 设置默认日期
    setDefaultDates();
    
    // 初始化所有模块
    try {
        initCharts();
        initBreakdown();
        initProgressTracking();
        initThemeToggle();
        initResponsiveDesign();
        initSmartCustomerSelection();
        initManualRevenueExpenseSystem();
        initEnhancedRegistration();
        initTemplatesSystem();
        initQuickCopySystem();
        initBatchOperations();
        initAttachmentsSystem();
        initCommentsSystem();
        console.log("所有模块初始化成功");
    } catch (error) {
        console.error("初始化模块错误:", error);
    }
    
    // 检查当前用户
    const currentUser = auth.currentUser;
    console.log("加载时当前用户:", currentUser ? currentUser.email : "无用户");
});

// ============== Firebase 配置和初始化 ==============
const firebaseConfig = {
    apiKey: "AIzaSyB-q5IfxsoF-Ud7YTw2jwHwrzXQuDmxey8",
    authDomain: "dealer-billing-system.firebaseapp.com",
    projectId: "dealer-billing-system",
    storageBucket: "dealer-billing-system.firebasestorage.app",
    messagingSenderId: "646495235869",
    appId: "1:646495235869:web:8a495e5f34e04b8cc0fbf4"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// 初始化 jsPDF
window.jsPDF = window.jspdf.jsPDF;

// ============== 全局变量 ==============
let performanceChartInstance = null;
let profitLossChartInstance = null;

// 存储数据
let bills = {
    periodic: [],
    individual: [],
    monthly: [],
    yearly: []
};

let customers = [];
let inventory = [];
let breakdownData = [];
let progressUpdates = {};
let billAddresses = {};
let manualRecords = [];
let templates = [];
let attachments = [];
let comments = [];

// ============== 认证和用户管理 ==============
// 渲染应用界面
function renderApp(user) {
    const authContainer = document.getElementById("auth-container");
    const mainContainer = document.getElementById("main-container");

    if (user && user.emailVerified) {
        // 显示主界面
        authContainer.style.display = "none";
        authContainer.classList.add("hidden");
        
        setTimeout(() => {
            mainContainer.style.display = "block";
            mainContainer.classList.remove("hidden");
            mainContainer.classList.add("visible");
            
            // 显示dashboard页面
            document.querySelectorAll(".page").forEach(p => {
                p.style.display = "none";
                p.classList.remove("active");
            });
            
            const dashboard = document.getElementById("dashboard");
            if (dashboard) {
                dashboard.style.display = "block";
                dashboard.classList.add("active");
            }
            
            document.body.offsetHeight; // 强制重绘
        }, 50);
        
    } else {
        // 显示登录页
        mainContainer.style.display = "none";
        mainContainer.classList.remove("visible");
        mainContainer.classList.add("hidden");
        
        setTimeout(() => {
            authContainer.style.display = "block";
            authContainer.classList.remove("hidden");
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('register-section').style.display = 'none';
            
            document.body.offsetHeight; // 强制重绘
        }, 50);
    }
}

// 监听认证状态变化
auth.onAuthStateChanged((user) => {
    console.log("认证状态变化，用户:", user ? user.email : "未登录");
    
    if (user && user.emailVerified) {
        renderApp(user);
        loadUserData();
        
        // 移除验证提醒
        const reminder = document.getElementById('verification-reminder');
        if (reminder) reminder.remove();
    } else {
        renderApp(null);
        
        // 确保登录页面可见
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');
        if (loginSection) loginSection.style.display = 'block';
        if (registerSection) registerSection.style.display = 'none';
    }
});

// ============== 用户数据加载 ==============
function loadUserData() {
    if (!auth.currentUser) return;
    
    // 加载账单
    db.collection('users').doc(auth.currentUser.uid).collection('bills').get()
        .then(querySnapshot => {
            bills = { periodic: [], individual: [], monthly: [], yearly: [] };
            
            querySnapshot.forEach(doc => {
                try {
                    const bill = doc.data();
                    if (bill && bill.type && bill.id) {
                        bills[bill.type].push(bill);
                    }
                } catch (error) {
                    console.warn('处理账单错误:', error);
                }
            });
            
            // 渲染所有账单
            ['periodic', 'individual', 'monthly', 'yearly'].forEach(type => {
                renderBillsByType(type);
            });
            
            // 更新总计
            setTimeout(() => {
                try {
                    if (typeof updatePeriodicTotal === 'function') updatePeriodicTotal();
                    if (typeof updateIndividualTotal === 'function') updateIndividualTotal();
                    if (typeof updateMonthlyTotal === 'function') updateMonthlyTotal();
                    if (typeof updateYearlyTotal === 'function') updateYearlyTotal();
                } catch (error) {
                    console.warn('更新总计错误:', error);
                }
            }, 100);
            
            // 更新仪表板
            updateDashboard();
            updateProgressView();
        })
        .catch(error => {
            console.error("加载账单错误: ", error);
            showToast('加载账单数据错误。', 'error');
        });
        
    // 加载客户
    db.collection('users').doc(auth.currentUser.uid).collection('customers').get()
        .then(querySnapshot => {
            customers = [];
            if (customersList) customersList.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const customer = doc.data();
                customers.push(customer);
                
                addCustomerToUI(customer);
            });
            
            updateCustomerDatalist();
        })
        .catch(error => {
            console.error("加载客户错误: ", error);
            showToast('加载客户数据错误。', 'error');
        });
        
    // 加载库存
    db.collection('users').doc(auth.currentUser.uid).collection('inventory').get()
        .then(querySnapshot => {
            inventory = [];
            if (inventoryList) inventoryList.innerHTML = '';
            
            querySnapshot.forEach(doc => {
                const product = doc.data();
                inventory.push(product);
                
                addProductToUI(product);
            });
            
            updateInventoryTotalValue();
            updateDashboard();
        })
        .catch(error => {
            console.error("加载库存错误: ", error);
            showToast('加载库存数据错误。', 'error');
        });
        
    // 加载其他数据
    loadBreakdownData();
    loadProgressData();
    loadManualRecords();
    loadTemplates();
    loadAttachments();
    loadComments();
    
    // 填充下拉菜单
    setTimeout(populateBillDropdowns, 1000);
}

// ============== 账单管理 ==============
// 设置账单表单
function setupBillForm(form, quantityId, priceId, totalId, listId, grandTotalId, billType) {
    const quantityInput = document.getElementById(quantityId);
    const priceInput = document.getElementById(priceId);
    const totalInput = document.getElementById(totalId);
    const billList = document.getElementById(listId);
    const grandTotal = document.getElementById(grandTotalId);
    
    // 计算总计
    if (quantityInput && priceInput && totalInput) {
        quantityInput.addEventListener('input', calculateTotal);
        priceInput.addEventListener('input', calculateTotal);
        
        function calculateTotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            totalInput.value = total.toFixed(2);
        }
    }
    
    // 表单提交处理
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const dateInput = document.getElementById(`${billType}-date`);
        const billNoInput = document.getElementById(`${billType}-billno`);
        const descriptionInput = document.getElementById(`${billType}-description`);
        
        const date = dateInput.value;
        const billNo = billNoInput.value;
        const description = descriptionInput.value;
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = quantity * price;
        
        // 对于个人账单，获取客户信息
        let customerName = '';
        let customerAddress = '';
        
        if (billType === 'individual') {
            customerName = document.getElementById('individual-customer-name').value;
            customerAddress = document.getElementById('individual-customer-address').value;
        }
        
        const bill = {
            id: Date.now().toString(),
            date,
            billNo,
            description,
            quantity,
            price,
            total,
            type: billType,
            customerName,
            customerAddress
        };
        
        // 添加到账单数组
        bills[billType].push(bill);
        
        // 重新渲染
        renderBillsByType(billType);
        
        // 更新总计
        updateGrandTotal();
        
        // 保存到 Firebase
        saveBillToFirebase(bill);
        
        // 显示成功消息
        showToast('账单项目添加成功', 'success');
        
        // 重置表单
        form.reset();
        totalInput.value = '0.00';
        
        // 设置今天日期
        setTodayDate(dateInput);
        
        // 更新进度视图
        updateProgressView();
    });
           
    function updateGrandTotal() {
        let total = 0;
        const rows = billList.querySelectorAll('tr');
        
        rows.forEach(row => {
            if (row.cells && row.cells.length > (billType === 'individual' ? 6 : 5)) {
                const totalCell = billType === 'individual' ? row.cells[6] : row.cells[5];
                if (totalCell && totalCell.textContent) {
                    total += parseFloat(totalCell.textContent) || 0;
                }
            }
        });
        
        if (grandTotal) {
            grandTotal.textContent = `RM ${total.toFixed(2)}`;
        }
    }
    
    return updateGrandTotal;
}

// 统一渲染函数
function renderBillsByType(type) {
    const billList = document.getElementById(`${type}-bills-list`);
    if (!billList) return;
    
    // 清空表格
    billList.innerHTML = '';
    
    // 检查是否有数据
    if (!bills[type] || bills[type].length === 0) {
        const colSpan = type === 'individual' ? 8 : 7;
        billList.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center text-muted">
                    暂无账单。请在上方添加第一个账单。
                </td>
            </tr>
        `;
        return;
    }
    
    // 重新渲染所有账单
    bills[type].forEach(bill => {
        let newRow;
        if (type === 'individual') {
            newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${bill.date || ''}</td>
                <td>${bill.billNo || ''}</td>
                <td>${bill.description || ''}</td>
                <td>${bill.customerName || 'N/A'}</td>
                <td>${bill.quantity || 0}</td>
                <td>${(bill.price || 0).toFixed(2)}</td>
                <td>${(bill.total || 0).toFixed(2)}</td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                </td>
            `;
        } else {
            newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${bill.date || ''}</td>
                <td>${bill.billNo || ''}</td>
                <td>${bill.description || ''}</td>
                <td>${bill.quantity || 0}</td>
                <td>${(bill.price || 0).toFixed(2)}</td>
                <td>${(bill.total || 0).toFixed(2)}</td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                </td>
            `;
        }
        
        billList.appendChild(newRow);
    });
}

// 编辑账单
window.editBill = function(billType, billId) {
    const billIndex = bills[billType].findIndex(bill => bill.id === billId);
    if (billIndex === -1) return;
    
    const bill = bills[billType][billIndex];
    
    // 填充表单数据
    document.getElementById(`${billType}-date`).value = bill.date;
    document.getElementById(`${billType}-billno`).value = bill.billNo;
    document.getElementById(`${billType}-description`).value = bill.description;
    document.getElementById(`${billType}-quantity`).value = bill.quantity;
    document.getElementById(`${billType}-price`).value = bill.price;
    
    // 对于个人账单，填充客户信息
    if (billType === 'individual') {
        document.getElementById('individual-customer-name').value = bill.customerName || '';
        document.getElementById('individual-customer-address').value = bill.customerAddress || '';
    }
    
    // 从数组中移除
    bills[billType].splice(billIndex, 1);
    
    // 重新渲染
    renderBillsByType(billType);
    
    // 更新总计
    if (billType === 'periodic') updatePeriodicTotal();
    if (billType === 'individual') updateIndividualTotal();
    if (billType === 'monthly') updateMonthlyTotal();
    if (billType === 'yearly') updateYearlyTotal();
    
    // 从 Firebase 删除
    deleteBillFromFirebase(billId);
    
    showToast('账单已加载用于编辑', 'info');
};

// 删除账单
window.deleteBill = function(billType, billId) {
    const billIndex = bills[billType].findIndex(bill => bill.id === billId);
    if (billIndex === -1) return;
    
    if (!confirm('确定要删除此账单吗？')) return;
    
    // 从数组中移除
    bills[billType].splice(billIndex, 1);
    
    // 重新渲染
    renderBillsByType(billType);
    
    // 更新总计
    try {
        if (billType === 'periodic') updatePeriodicTotal();
        if (billType === 'individual') updateIndividualTotal();
        if (billType === 'monthly') updateMonthlyTotal();
        if (billType === 'yearly') updateYearlyTotal();
    } catch (error) {
        console.warn('更新总计错误:', error);
        updateGrandTotalFromArray(billType);
    }
    
    // 从 Firebase 删除
    deleteBillFromFirebase(billId);
    
    showToast('账单删除成功', 'success');
};

// ============== 客户管理 ==============
// 智能客户选择
function initSmartCustomerSelection() {
    const customerNameInput = document.getElementById('individual-customer-name');
    if (!customerNameInput) return;
    
    // 监听客户名称输入
    customerNameInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        if (searchTerm.length < 2) {
            const results = document.getElementById('customer-search-results');
            if (results) results.style.display = 'none';
            return;
        }
        
        // 搜索客户
        searchCustomers(searchTerm);
    });
    
    // 清除客户按钮
    const clearCustomerBtn = document.getElementById('clear-customer');
    if (clearCustomerBtn) {
        clearCustomerBtn.addEventListener('click', function() {
            customerNameInput.value = '';
            document.getElementById('individual-customer-address').value = '';
            const results = document.getElementById('customer-search-results');
            if (results) results.style.display = 'none';
        });
    }
    
    // 更新数据列表
    updateCustomerDatalist();
}

// 搜索客户
function searchCustomers(searchTerm) {
    const customerSearchResults = document.getElementById('customer-search-results');
    if (!customerSearchResults) return;
    
    const results = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (customer.phone && customer.phone.includes(searchTerm))
    );
    
    displayCustomerSearchResults(results);
}

// 显示客户搜索结果
function displayCustomerSearchResults(results) {
    const customerSearchResults = document.getElementById('customer-search-results');
    if (!customerSearchResults) return;
    
    customerSearchResults.innerHTML = '';
    
    if (results.length === 0) {
        customerSearchResults.innerHTML = `
            <div class="customer-result-item">
                <p class="mb-0 text-muted">未找到客户。您可以输入新客户。</p>
            </div>
        `;
        customerSearchResults.style.display = 'block';
        return;
    }
    
    results.forEach(customer => {
        const resultItem = document.createElement('div');
        resultItem.className = 'customer-result-item';
        resultItem.innerHTML = `
            <h6 class="mb-1">${customer.name}</h6>
            <p class="mb-1 text-muted small">
                ${customer.phone ? '电话: ' + customer.phone + ' • ' : ''}
                ${customer.email ? '邮箱: ' + customer.email : ''}
            </p>
            <p class="mb-1 text-muted small">${customer.address || '未提供地址'}</p>
        `;
        
        resultItem.addEventListener('click', function() {
            document.getElementById('individual-customer-name').value = customer.name;
            document.getElementById('individual-customer-address').value = customer.address || '';
            customerSearchResults.style.display = 'none';
            
            showToast(`客户 "${customer.name}" 已选择`, 'success');
        });
        
        customerSearchResults.appendChild(resultItem);
    });
    
    customerSearchResults.style.display = 'block';
}

// ============== 库存管理 ==============
// 添加产品到UI
function addProductToUI(product) {
    const status = getStockStatus(product.quantity, product.lowStockThreshold);
    const statusClass = status === '缺货' ? 'out-of-stock' : 
                       status === '库存不足' ? 'low-stock' : 'in-stock';
    
    const newRow = document.createElement('tr');
    newRow.className = statusClass;
    newRow.innerHTML = `
        <td>${product.name}</td>
        <td>${product.sku}</td>
        <td>${product.category}</td>
        <td>${product.quantity}</td>
        <td>${product.costPrice.toFixed(2)}</td>
        <td>${product.sellingPrice.toFixed(2)}</td>
        <td>${product.stockValue.toFixed(2)}</td>
        <td><span class="stock-alert ${status === '缺货' ? 'alert-out' : status === '库存不足' ? 'alert-low' : ''}">${status}</span></td>
        <td>
            <i class="fas fa-edit action-btn text-primary" onclick="editProduct('${product.id}')"></i>
            <i class="fas fa-trash action-btn text-danger" onclick="deleteProduct('${product.id}')"></i>
        </td>
    `;
    
    const inventoryList = document.getElementById('inventory-list');
    if (inventoryList) inventoryList.appendChild(newRow);
}

// 获取库存状态
function getStockStatus(quantity, threshold) {
    if (quantity === 0) {
        return '缺货';
    } else if (quantity <= threshold) {
        return '库存不足';
    } else {
        return '有库存';
    }
}

// ============== 损益分析 ==============
// 初始化损益分析
function initProfitLoss() {
    if (profitLossForm) {
        profitLossForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const revenue = parseFloat(document.getElementById('revenue').value);
            const expenses = parseFloat(document.getElementById('expenses').value);
            
            if (isNaN(revenue) || isNaN(expenses)) {
                resultText.textContent = '请输入有效的收入和支出数字。';
                profitLossResult.className = 'alert alert-danger';
                profitLossResult.style.display = 'block';
                return;
            }
            
            const profitLoss = revenue - expenses;
            
            if (profitLoss > 0) {
                resultText.textContent = `净利润: RM ${profitLoss.toFixed(2)}`;
                profitLossResult.className = 'alert alert-success';
            } else if (profitLoss < 0) {
                resultText.textContent = `净亏损: RM ${Math.abs(profitLoss).toFixed(2)}`;
                profitLossResult.className = 'alert alert-danger';
            } else {
                resultText.textContent = '收支平衡：无盈利或亏损';
                profitLossResult.className = 'alert alert-info';
            }
            
            profitLossResult.style.display = 'block';
        });
    }
}

// ============== 进度跟踪 ==============
// 初始化进度跟踪
function initProgressTracking() {
    setDefaultProgressDates();
    
    // 添加事件监听器
    if (applyProgressFilter) applyProgressFilter.addEventListener('click', filterProgressBills);
    if (generateProgressReport) generateProgressReport.addEventListener('click', generateProgressPdf);
    if (addProgressUpdate) addProgressUpdate.addEventListener('click', showProgressUpdateModal);
    if (saveProgressUpdate) saveProgressUpdate.addEventListener('click', saveProgressUpdateHandler);
    
    // 加载进度数据
    loadProgressData();
}

// 更新进度视图
function updateProgressView() {
    const progressBillsList = document.getElementById('progress-bills-list');
    if (!progressBillsList) return;

    // 清空表格
    progressBillsList.innerHTML = '';

    // 合并所有账单
    const allBills = [];
    for (const type in bills) {
        if (Array.isArray(bills[type])) {
            bills[type].forEach(bill => {
                if (bill && bill.id) {
                    allBills.push(bill);
                }
            });
        }
    }

    // 如果没有账单显示消息
    if (allBills.length === 0) {
        progressBillsList.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    暂无账单
                </td>
            </tr>
        `;

        if (totalBillsCount) totalBillsCount.textContent = 0;
        if (recordedBillsCount) recordedBillsCount.textContent = 0;
        if (paidBillsCount) paidBillsCount.textContent = 0;
        if (overdueBillsCount) overdueBillsCount.textContent = 0;
        return;
    }

    // 计数器
    let total = 0;
    let recorded = 0;
    let paid = 0;
    let overdue = 0;

    // 渲染表格
    allBills.forEach(bill => {
        const billProgress = progressUpdates[bill.id] || [];
        const latestUpdate = billProgress.length
            ? billProgress[billProgress.length - 1]
            : { status: 'pending' };

        total++;
        if (latestUpdate.status === 'recorded') recorded++;
        if (latestUpdate.status === 'paid') paid++;
        if (latestUpdate.status === 'overdue') overdue++;

        const customerName = bill.customerName || 'N/A';

        // 地图链接
        let mapLink = '无地址';
        const address = billAddresses[bill.id] || bill.customerAddress;
        if (address) {
            const encoded = encodeURIComponent(address);
            mapLink = `
                <a href="https://www.google.com/maps/search/?api=1&query=${encoded}" 
                   target="_blank" class="map-link">
                    <i class="fas fa-map-marker-alt"></i> 查看
                </a>
            `;
        }

        const totalAmount = Number(bill.total) || 0;
        const lastUpdateDate = billProgress.length
            ? new Date(billProgress[billProgress.length - 1].date).toLocaleDateString()
            : '从未';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${bill.date || '-'}</td>
            <td>${bill.billNo || '-'}</td>
            <td>${bill.description || '-'}</td>
            <td>${customerName}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
                <span class="status-badge status-${latestUpdate.status}">
                    ${latestUpdate.status.charAt(0).toUpperCase() + latestUpdate.status.slice(1)}
                </span>
            </td>
            <td>${mapLink}</td>
            <td>${lastUpdateDate}</td>
            <td>
                ${billProgress.length
                    ? `<button class="btn btn-sm btn-info" onclick="viewProgressUpdates('${bill.id}')">
                        <i class="fas fa-eye"></i> 查看 (${billProgress.length})
                       </button>`
                    : '无更新'}
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="updateBillProgress('${bill.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="addBillAddress('${bill.id}')">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </td>
        `;

        progressBillsList.appendChild(row);
    });

    // 更新统计
    if (totalBillsCount) totalBillsCount.textContent = total;
    if (recordedBillsCount) recordedBillsCount.textContent = recorded;
    if (paidBillsCount) paidBillsCount.textContent = paid;
    if (overdueBillsCount) overdueBillsCount.textContent = overdue;
}

// ============== 手动收入/支出系统 ==============
// 初始化手动收入/支出系统
function initManualRevenueExpenseSystem() {
    const manualRevenueExpenseForm = document.getElementById('manual-revenue-expense-form');
    if (!manualRevenueExpenseForm) return;
    
    // 设置默认日期
    setTodayDate(document.getElementById('manual-date'));
    
    // 表单提交处理
    manualRevenueExpenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const type = document.getElementById('manual-type').value;
        const category = document.getElementById('manual-category').value.trim();
        const amount = parseFloat(document.getElementById('manual-amount').value);
        const description = document.getElementById('manual-description').value.trim();
        const date = document.getElementById('manual-date').value;
        
        if (!category || isNaN(amount) || amount <= 0) {
            showToast('请输入有效的类别和金额', 'error');
            return;
        }
        
        const record = {
            id: Date.now().toString(),
            type: type,
            category: category,
            amount: amount,
            description: description,
            date: date,
            createdAt: new Date().toISOString()
        };
        
        // 添加到手动记录
        manualRecords.push(record);
        
        // 添加到UI
        addManualRecordToUI(record);
        
        // 保存到 Firebase
        saveManualRecordToFirebase(record);
        
        // 更新总计
        updateManualRecordsTotals();
        
        // 更新图表
        updateChartsWithManualData();
        
        // 显示成功消息
        showToast(`${type === 'revenue' ? '收入' : '支出'}记录添加成功`, 'success');
        
        // 重置表单
        document.getElementById('manual-category').value = '';
        document.getElementById('manual-amount').value = '';
        document.getElementById('manual-description').value = '';
    });
    
    // 初始化PDF生成
    const generateManualRecordsPdf = document.getElementById('generate-manual-records-pdf');
    if (generateManualRecordsPdf) {
        generateManualRecordsPdf.addEventListener('click', generateManualRecordsPdfReport);
    }
    
    // 加载现有手动记录
    loadManualRecords();
}

// ============== 图表系统 ==============
// 初始化图表
function initCharts() {
    // 销毁旧图表实例
    if (performanceChartInstance) {
        performanceChartInstance.destroy();
        performanceChartInstance = null;
    }
    
    if (profitLossChartInstance) {
        profitLossChartInstance.destroy();
        profitLossChartInstance = null;
    }
    
    // 性能图表
    const perfCtx = document.getElementById('performanceChart');
    if (perfCtx) {
        perfCtx.style.width = '100%';
        perfCtx.style.height = '100%';
        
        const chartData = getEnhancedChartData();
        
        performanceChartInstance = new Chart(perfCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: '收入',
                    data: chartData.revenue,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            font: { size: 12 }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                            display: true
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                            display: true
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            callback: function(value) {
                                return 'RM ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 损益图表
    const plCtx = document.getElementById('profitLossChart');
    if (plCtx) {
        plCtx.style.width = '100%';
        plCtx.style.height = '100%';
        
        const chartData = getEnhancedChartData();
        
        profitLossChartInstance = new Chart(plCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '收入',
                        data: chartData.revenue,
                        backgroundColor: '#27ae60',
                        borderColor: '#27ae60',
                        borderWidth: 1
                    },
                    {
                        label: '支出',
                        data: chartData.expenses,
                        backgroundColor: '#e74c3c',
                        borderColor: '#e74c3c',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            font: { size: 12 }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                            display: true
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                            display: true
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            callback: function(value) {
                                return 'RM ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
}

// ============== 仪表板功能 ==============
// 更新仪表板
function updateDashboard() {
    // 计算所有账单总计
    let billRevenue = 0;
    for (const type in bills) {
        bills[type].forEach(bill => {
            billRevenue += bill.total;
        });
    }
    
    // 计算手动记录总计
    let manualRevenueTotal = 0;
    let manualExpenseTotal = 0;
    
    manualRecords.forEach(record => {
        if (record.type === 'revenue') {
            manualRevenueTotal += record.amount;
        } else if (record.type === 'expense') {
            manualExpenseTotal += record.amount;
        }
    });
    
    // 计算合并总计
    const totalCombinedRevenue = billRevenue + manualRevenueTotal;
    const totalCombinedExpenses = manualExpenseTotal;
    const profit = totalCombinedRevenue - totalCombinedExpenses;
    
    // 更新UI
    if (totalRevenue) totalRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
    if (totalExpenses) totalExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
    if (netProfit) {
        netProfit.textContent = `RM ${profit.toFixed(2)}`;
        if (profit > 0) {
            netProfit.className = 'stat-value profit';
        } else if (profit < 0) {
            netProfit.className = 'stat-value loss';
        } else {
            netProfit.className = 'stat-value';
        }
    }
    
    // 更新库存价值
    updateInventoryTotalValue();
    
    // 更新最近账单
    updateRecentBills();
    
    // 更新库存不足警报
    updateLowStockAlerts();
    
    // 更新损益页面
    if (plRevenue && plExpenses) {
        plRevenue.textContent = `RM ${totalCombinedRevenue.toFixed(2)}`;
        plExpenses.textContent = `RM ${totalCombinedExpenses.toFixed(2)}`;
    }
}

// ============== 主题切换 ==============
// 初始化主题切换
function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');
    
    // 检查本地存储的主题偏好
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
        
        showToast(`切换到${newTheme === 'dark' ? '深色' : '浅色'}模式`, 'success');
        
        // 更新图表主题
        setTimeout(updateChartsTheme, 300);
    });
    
    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-sun';
        } else {
            themeIcon.className = 'fas fa-moon';
        }
    }
}

// ============== 响应式设计 ==============
// 初始化响应式设计
function initResponsiveDesign() {
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth <= 992;
    
    if (isMobile) {
        optimizeForMobile();
    } else if (isTablet) {
        optimizeForTablet();
    } else {
        optimizeForDesktop();
    }
    
    // 监听窗口调整大小
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(initResponsiveDesign, 250);
    });
}

// ============== 增强注册系统 ==============
// 初始化增强注册系统
function initEnhancedRegistration() {
    // 密码切换功能
    const toggleRegisterPassword = document.getElementById('toggle-register-password');
    const toggleConfirmPassword = document.getElementById('toggle-confirm-password');
    const registerPassword = document.getElementById('register-password');
    const confirmPassword = document.getElementById('confirm-password');
    
    if (toggleRegisterPassword && registerPassword) {
        toggleRegisterPassword.addEventListener('click', function() {
            const type = registerPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            registerPassword.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    if (toggleConfirmPassword && confirmPassword) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    // 实时密码验证
    if (registerPassword) {
        registerPassword.addEventListener('input', function() {
            validatePassword(this.value);
            checkPasswordMatch();
        });
    }
    
    if (confirmPassword) {
        confirmPassword.addEventListener('input', checkPasswordMatch);
    }
    
    // 邮箱验证
    const emailInput = document.getElementById('register-email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            validateEmailFormat(this.value);
        });
    }
    
    // 表单提交
    const registerForm = document.getElementById('enhanced-register-form');
    if (registerForm) {
        registerForm.removeEventListener('submit', handleEnhancedRegistration);
        
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log("注册表单提交");
            handleEnhancedRegistration();
        });
        
        const registerBtn = document.getElementById('register-btn');
        if (registerBtn) {
            registerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("注册按钮点击");
                handleEnhancedRegistration();
            });
        }
    }
}

// ============== 账单模板系统 ==============
// 初始化模板系统
function initTemplatesSystem() {
    if (!auth.currentUser) return;
    
    // 加载模板
    loadTemplates();
    
    // 保存当前账单为模板
    const saveTemplateBtn = document.getElementById('save-current-template');
    if (saveTemplateBtn) {
        saveTemplateBtn.addEventListener('click', saveCurrentBillAsTemplate);
    }
    
    // 模板复选框处理
    const selectAllCheckbox = document.getElementById('select-all-templates');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#templates-list input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // 删除选定模板
    const deleteSelectedBtn = document.getElementById('delete-selected-templates');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', deleteSelectedTemplates);
    }
    
    // 刷新模板
    const refreshBtn = document.getElementById('refresh-templates');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadTemplates);
    }
}

// ============== 批量操作系统 ==============
// 初始化批量操作
function initBatchOperations() {
    // 加载批量操作的账单
    loadBatchBills();
    
    // 事件监听器
    const applyFilterBtn = document.getElementById('apply-batch-filter');
    if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', loadBatchBills);
    }
    
    const selectAllBatch = document.getElementById('select-all-batch');
    if (selectAllBatch) {
        selectAllBatch.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#batch-bills-list .bill-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // 批量操作按钮
    const batchCopyBtn = document.getElementById('batch-copy');
    if (batchCopyBtn) {
        batchCopyBtn.addEventListener('click', batchCopyBills);
    }
    
    const batchDeleteBtn = document.getElementById('batch-delete');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', batchDeleteBills);
    }
    
    const batchExportPdfBtn = document.getElementById('batch-export-pdf');
    if (batchExportPdfBtn) {
        batchExportPdfBtn.addEventListener('click', batchExportAsPDF);
    }
    
    const batchExportCsvBtn = document.getElementById('batch-export-csv');
    if (batchExportCsvBtn) {
        batchExportCsvBtn.addEventListener('click', batchExportAsCSV);
    }
}

// ============== 附件系统 ==============
// 初始化附件系统
function initAttachmentsSystem() {
    // 加载附件
    loadAttachments();
    
    // 设置文件上传
    const attachmentForm = document.getElementById('attachment-form');
    if (attachmentForm) {
        attachmentForm.addEventListener('submit', handleAttachmentUpload);
    }
    
    // 填充账单下拉菜单
    populateBillDropdowns();
    
    // 筛选按钮
    const filterImagesBtn = document.getElementById('filter-images');
    const filterDocumentsBtn = document.getElementById('filter-documents');
    const filterAllBtn = document.getElementById('filter-all-attachments');
    
    if (filterImagesBtn) {
        filterImagesBtn.addEventListener('click', () => filterAttachments('image'));
    }
    
    if (filterDocumentsBtn) {
        filterDocumentsBtn.addEventListener('click', () => filterAttachments('document'));
    }
    
    if (filterAllBtn) {
        filterAllBtn.addEventListener('click', () => filterAttachments('all'));
    }
}

// ============== 评论系统 ==============
// 初始化评论系统
function initCommentsSystem() {
    // 加载评论
    loadComments();
    
    // 设置评论表单
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', handleCommentSubmit);
    }
    
    // 填充账单下拉菜单
    populateBillDropdowns();
    
    // 筛选按钮
    const filterAllBtn = document.getElementById('filter-all-comments');
    const filterImportantBtn = document.getElementById('filter-important-comments');
    const filterMyBtn = document.getElementById('filter-my-comments');
    
    if (filterAllBtn) {
        filterAllBtn.addEventListener('click', () => filterComments('all'));
    }
    
    if (filterImportantBtn) {
        filterImportantBtn.addEventListener('click', () => filterComments('important'));
    }
    
    if (filterMyBtn) {
        filterMyBtn.addEventListener('click', () => filterComments('mine'));
    }
}

// ============== 实用工具函数 ==============
// 显示通知
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} show`;
    toast.innerHTML = `
        <div class="toast-body">
            <button type="button" class="btn-close float-end" data-bs-dismiss="toast"></button>
            ${message}
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // 5秒后自动移除
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// 设置默认日期
function setDefaultDates() {
    document.querySelectorAll('input[type="date"]').forEach(input => {
        setTodayDate(input);
    });
}

// 设置今天日期
function setTodayDate(input) {
    const today = new Date();
    const yyyy = today.getFullYear();
    let mm = today.getMonth() + 1;
    let dd = today.getDate();
    
    if (dd < 10) dd = '0' + dd;
    if (mm < 10) mm = '0' + mm;
    
    const formattedToday = `${yyyy}-${mm}-${dd}`;
    if (input) input.value = formattedToday;
}

// 安全DOM操作
function safeDOMOperation(elementId, operation) {
    const element = document.getElementById(elementId);
    if (!element) {
        console.warn(`元素 #${elementId} 未找到，操作:`, operation);
        return false;
    }
    
    try {
        return operation(element);
    } catch (error) {
        console.error(`在 #${elementId} 上的DOM操作错误:`, error);
        return false;
    }
}

// 页面加载后初始化
function initializeAfterDOMReady() {
    console.log("DOM就绪后初始化...");
    
    // 检查所有必要元素
    const requiredElements = [
        'auth-container',
        'main-container',
        'login-section',
        'register-section',
        'login-btn',
        'register-btn'
    ];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`元素 #${id} 未找到!`);
        }
    });
    
    // 延迟初始化图表
    setTimeout(() => {
        try {
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
                performanceChartInstance = null;
            }
            if (profitLossChartInstance) {
                profitLossChartInstance.destroy();
                profitLossChartInstance = null;
            }
            
            initCharts();
            console.log("图表重新初始化");
        } catch (error) {
            console.error("重新初始化图表错误:", error);
        }
    }, 1000);
}

// 绑定事件监听器
function bindEventListeners() {
    console.log("绑定事件监听器...");
    
    // 重新绑定重要按钮事件
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    
    if (loginBtn && !loginBtn.hasAttribute('data-bound')) {
        loginBtn.setAttribute('data-bound', 'true');
        loginBtn.addEventListener('click', function(e) {
            console.log("登录按钮点击");
            // 原有的登录处理逻辑
        });
    }
    
    if (registerBtn && !registerBtn.hasAttribute('data-bound')) {
        registerBtn.setAttribute('data-bound', 'true');
        registerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log("注册按钮点击");
            handleEnhancedRegistration();
        });
    }
    
    // 重新绑定导航链接
    document.querySelectorAll('.sidebar a[data-page]').forEach(link => {
        if (!link.hasAttribute('data-bound')) {
            link.setAttribute('data-bound', 'true');
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetPage = this.getAttribute('data-page');
                console.log("导航到:", targetPage);
                // 原有的导航逻辑
            });
        }
    });
}

// ============== 全局函数导出 ==============
// 导出到window对象以便HTML调用
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.editBill = editBill;
window.deleteBill = deleteBill;
window.editCustomer = editCustomer;
window.deleteCustomer = deleteCustomer;
window.editManualRecord = editManualRecord;
window.deleteManualRecord = deleteManualRecord;
window.deleteBreakdownItem = deleteBreakdownItem;
window.updateBillProgress = updateBillProgress;
window.addBillAddress = addBillAddress;
window.viewProgressUpdates = viewProgressUpdates;
window.useTemplate = useTemplate;
window.duplicateTemplate = duplicateTemplate;
window.deleteTemplate = deleteTemplate;
window.showQuickCopyModal = showQuickCopyModal;
window.showBulkDeleteModal = showBulkDeleteModal;
window.showBulkExportModal = showBulkExportModal;
window.socialSignUp = socialSignUp;

// 页面加载检查
window.addEventListener('load', function() {
    console.log("页面加载完成，检查认证状态...");

    setTimeout(() => {
        document.body.style.display = 'none';
        document.body.offsetHeight;
        document.body.style.display = '';
    }, 100);
    
    // 检查Firebase认证状态
    auth.onAuthStateChanged(function(user) {
        console.log("认证状态变化，用户:", user ? user.email : "未登录");
        
        if (user && user.emailVerified) {
            console.log("用户已登录且已验证，显示主界面");
            
            const authContainer = document.getElementById('auth-container');
            const mainContainer = document.getElementById('main-container');
            
            if (authContainer && mainContainer) {
                authContainer.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important;';
                mainContainer.style.cssText = 'display: block !important; opacity: 1 !important; visibility: visible !important;';
                
                setTimeout(() => {
                    loadUserData();
                    console.log("用户数据加载完成");
                }, 500);
            }
        } else {
            console.log("用户未登录或未验证，显示登录界面");
        }
    });
});

// 使用多个事件监听器确保DOM就绪
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAfterDOMReady);
} else {
    setTimeout(initializeAfterDOMReady, 500);
}
    </script>
</body>
    <footer style="text-align:center; padding: 10px; margin-top:20px; color:#666; font-size:14px;">
    Developed by Tan Jun Yuan
</footer>

</html>
