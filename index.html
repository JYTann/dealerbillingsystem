<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Billing Management System</title>
    <!-- Firebase App & Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #ecf0f1;
    --dark-color: #2c3e50;
    --bg-color: #f8f9fa;
    --text-color: #333;
    --card-bg: white;
    --sidebar-bg: var(--primary-color);
    --border-color: #ddd;
}

        [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --card-bg: #2d2d2d;
    --primary-color: #1e3a5f;
    --sidebar-bg: #1e3a5f;
    --border-color: #444;
    --light-color: #333;
}
        
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
}

        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
            border-radius: 10px;
        }
        
        .sidebar a {
            color: white;
            padding: 15px;
            text-decoration: none;
            display: block;
            transition: 0.3s;
        }
        
        .sidebar a:hover {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .sidebar a.active {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        
        .content {
            margin-left: 220px;
            padding: 20px;
        }
        
        .page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .page.active {
            display: block;
        }
        
        .bill-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .bill-table th, .bill-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .bill-table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .bill-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .bill-table tr:hover {
            background-color: #ddd;
        }
        
        .action-btn {
            margin: 0 5px;
            cursor: pointer;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .profit {
            color: #27ae60;
        }
        
        .loss {
            color: #e74c3c;
        }
        
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        .customer-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .customer-actions {
            margin-top: 10px;
        }
        
        /* Inventory specific styles */
        .low-stock {
            background-color: #ffe6e6;
        }
        
        .out-of-stock {
            background-color: #ffcccc;
        }
        
        .in-stock {
            background-color: #e6ffe6;
        }
        
        .stock-alert {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .alert-low {
            background-color: #ffcccc;
            color: #cc0000;
        }
        
        .alert-out {
            background-color: #ff9999;
            color: #990000;
        }
        
        .inventory-card {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .inventory-actions {
            margin-top: 10px;
        }
        
        /* Editable breakdown styles */
        .breakdown-table td:last-child {
            text-align: center;
            width: 100px;
        }
        
        .breakdown-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .editable-field {
            border: 1px dashed transparent;
            padding: 3px 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .editable-field:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .editable-field:focus {
            outline: none;
            border: 1px solid #3498db;
            background-color: #fff;
        }
        
        /* Progress tracking styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-recorded {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .progress-filter {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .progress-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .progress-card h5 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-update {
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .progress-update p {
            margin: 0;
            font-size: 14px;
        }
        
        .progress-update .date {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                width: 180px;
            }
            
            .content {
                margin-left: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }
            
            .content {
                margin-left: 0;
            }
            
            .dashboard-stats {
                flex-direction: column;
            }
            
            .progress-summary {
                flex-direction: column;
            }
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: rgba(255, 255, 255, 0.95);
            border-left: 4px solid;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .toast-success {
            border-left-color: #28a745;
        }
        
        .toast-error {
            border-left-color: #dc3545;
        }
        
        .toast-info {
            border-left-color: #17a2b8;
        }

        /* Map link styles */
        .map-link {
            color: #3498db;
            text-decoration: none;
        }
        
        .map-link:hover {
            text-decoration: underline;
        }

        .summary-card, .stat-card, .form-section, .chart-container, .page, 
.progress-filter, .progress-card, .progress-update, .toast {
    background-color: var(--card-bg);
    transition: background-color 0.3s;
}

.sidebar {
    background-color: var(--sidebar-bg);
}

.bill-table th {
    background-color: var(--primary-color);
}

.bill-table th, .bill-table td {
    border-color: var(--border-color);
}

.bill-table tr:nth-child(even) {
    background-color: color-mix(in srgb, var(--card-bg) 90%, var(--text-color));
}

/* 在现有样式之后添加主题切换按钮样式 */
.theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.theme-toggle i {
    font-size: 20px;
    color: var(--text-color);
}

/* 在响应式调整之前添加 */
@media (max-width: 768px) {
    .theme-toggle {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
    }
}
    </style>
</head>
<body>
    <!-- 主题切换按钮 -->
<div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
</div>
    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Login Section -->
    <div id="auth-container" class="auth-container">
        <div class="logo">
            <h1>Dealer<span>BILL</span></h1>
            <p>Billing Management System</p>
        </div>
        
        <div id="login-section">
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter your password">
            </div>
            <div id="login-error" class="login-error">
                Invalid email or password. Please try again.
            </div>
            <button id="login-btn" class="btn btn-primary w-100 mb-3">Login</button>
            <button id="google-login-btn" class="btn btn-outline-danger w-100">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <div class="text-center mt-3">
                <a href="#" id="show-register">Don't have an account? Register</a>
            </div>
        </div>
        
        <div id="register-section" style="display: none;">
            <hr>
            <div class="mb-3">
                <label for="register-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="register-email" placeholder="Enter your email">
            </div>
            <div class="mb-3">
                <label for="register-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="register-password" placeholder="Create a password">
            </div>
            <div class="mb-3">
                <label for="confirm-password" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirm-password" placeholder="Confirm your password">
            </div>
            <div id="register-error" class="login-error">
                Passwords do not match or email is invalid.
            </div>
            <button id="register-btn" class="btn btn-success w-100 mb-3">Register</button>
            <div class="text-center">
                <a href="#" id="show-login">Back to Login</a>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-container" class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" style="width: 200px;">
            <div class="logo">
                <h4>Dealer<span>BILL</span></h4>
            </div>
            <a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="#" data-page="periodic-bills"><i class="fas fa-calendar-week"></i> Periodic Bills</a>
            <a href="#" data-page="individual-bills"><i class="fas fa-file-invoice"></i> Individual Bills</a>
            <a href="#" data-page="monthly-bills"><i class="fas fa-calendar-alt"></i> Monthly Bills</a>
            <a href="#" data-page="yearly-bills"><i class="fas fa-calendar"></i> Yearly Bills</a>
            <a href="#" data-page="profit-loss"><i class="fas fa-chart-line"></i> Profit & Loss</a>
            <a href="#" data-page="customer-management"><i class="fas fa-users"></i> Customer Management</a>
            <a href="#" data-page="inventory-tracking"><i class="fas fa-box"></i> Inventory Tracking</a>
            <!-- 添加进度跟进页面 -->
            <a href="#" data-page="progress-tracking"><i class="fas fa-clipboard-check"></i> Progress Tracking</a>
            <a href="#" data-page="more"><i class="fas fa-ellipsis-h"></i> More</a>
            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <h2>Dashboard</h2>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <p class="stat-value" id="total-revenue">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Total Expenses</h5>
                        <p class="stat-value" id="total-expenses">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Net Profit</h5>
                        <p class="stat-value profit" id="net-profit">RM 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h5>Inventory Value</h5>
                        <p class="stat-value" id="inventory-value">RM 0.00</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Monthly Performance</h5>
                    <canvas id="performanceChart" height="100"></canvas>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Recent Bills</h5>
                            <table class="bill-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bill No</th>
                                        <th>Amount (RM)</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-bills">
                                    <!-- Recent bills will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Low Stock Alerts</h5>
                            <div id="low-stock-alerts">
                                <!-- Low stock alerts will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Periodic Bills Page -->
            <div id="periodic-bills" class="page">
                <h2>Periodic Bills</h2>
                <div class="form-section">
                    <h5>Add New Bill</h5>
                    <form id="periodic-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="periodic-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="periodic-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodic-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="periodic-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="periodic-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="periodic-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="periodic-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="periodic-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Bill Items</h5>
                        <button class="btn btn-success" id="generate-periodic-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="periodic-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="periodic-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Individual Bills Page -->
            <div id="individual-bills" class="page">
                <h2>Individual Bills</h2>
                <div class="form-section">
                    <h5>Add New Individual Bill</h5>
                    <form id="individual-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="individual-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="individual-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="individual-description" required>
                                </div>
                            </div>
                        </div>
                        <!-- 添加客户信息填写栏 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-name" class="form-label">Customer Name (Optional)</label>
                                    <input type="text" class="form-control" id="individual-customer-name" placeholder="Enter customer name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="individual-customer-address" class="form-label">Customer Address (Optional)</label>
                                    <input type="text" class="form-control" id="individual-customer-address" placeholder="Enter customer address">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="individual-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="individual-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="individual-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="individual-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Individual Bill Items</h5>
                        <button class="btn btn-success" id="generate-individual-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Customer</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="individual-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="individual-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Monthly Bills Page -->
            <div id="monthly-bills" class="page">
                <h2>Monthly Bills</h2>
                <div class="form-section">
                    <h5>Add New Monthly Bill</h5>
                    <form id="monthly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="monthly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="monthly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="monthly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="monthly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="monthly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="monthly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="monthly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="monthly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Monthly Bill Items</h5>
                        <button class="btn btn-success" id="generate-monthly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="monthly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Yearly Bills Page -->
            <div id="yearly-bills" class="page">
                <h2>Yearly Bills</h2>
                <div class="form-section">
                    <h5>Add New Yearly Bill</h5>
                    <form id="yearly-bill-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="yearly-date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-billno" class="form-label">Bill Number</label>
                                    <input type="text" class="form-control" id="yearly-billno" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="yearly-description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="yearly-description" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="yearly-quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-price" class="form-label">Unit Price (RM)</label>
                                    <input type="number" class="form-control" id="yearly-price" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="yearly-total" class="form-label">Total (RM)</label>
                                    <input type="text" class="form-control" id="yearly-total" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 d-flex align-items-end" style="height: 42px;">
                                    <button type="submit" class="btn btn-primary w-100">Add Item</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Yearly Bill Items</h5>
                        <button class="btn btn-success" id="generate-yearly-pdf">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bill No</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (RM)</th>
                                <th>Total (RM)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="yearly-bills-list">
                            <!-- Bills will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Grand Total:</td>
                                <td id="yearly-grand-total" style="font-weight: bold;">RM 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Profit & Loss Page -->
            <div id="profit-loss" class="page">
                <h2>Profit & Loss Analysis</h2>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Revenue</h5>
                            <p class="summary-value profit" id="pl-revenue">RM 0.00</p>
                            <p><small id="revenue-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="summary-card">
                            <h5>Expenses</h5>
                            <p class="summary-value loss" id="pl-expenses">RM 0.00</p>
                            <p><small id="expenses-comparison">Last month: RM 0.00</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h5>Revenue vs Expenses (Last 6 Months)</h5>
                    <canvas id="profitLossChart" height="100"></canvas>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Detailed Breakdown</h5>
                        <button class="btn btn-primary" id="add-breakdown-item">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <table class="bill-table breakdown-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount (RM)</th>
                                <th>Percentage</th>
                                <th>Trend</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pl-breakdown">
                            <!-- Profit/Loss breakdown will be populated here -->
                        </tbody>
                    </table>
                    <div class="breakdown-actions">
                        <button class="btn btn-success" id="save-breakdown">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" id="reset-breakdown">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>Calculate Profit/Loss</h5>
                    <form id="profit-loss-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="revenue" class="form-label">Total Revenue (RM)</label>
                                    <input type="number" class="form-control" id="revenue" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenses" class="form-label">Total Expenses (RM)</label>
                                    <input type="number" class="form-control" id="expenses" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary w-100">Calculate</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert" id="profit-loss-result" style="display: none;">
                                    <h5>Result:</h5>
                                    <p id="result-text"></p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customer Management Page -->
            <div id="customer-management" class="page">
                <h2>Customer Management</h2>
                
                <div class="form-section">
                    <h5>Add New Customer</h5>
                    <form id="customer-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-name" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customer-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customer-email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="customer-phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="customer-address">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Customer</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <h5>Customer List</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Search customers..." id="customer-search">
                        <button class="btn btn-outline-secondary" type="button" id="customer-search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div id="customers-list">
                        <!-- Customers will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Inventory Tracking Page -->
            <div id="inventory-tracking" class="page">
                <h2>Inventory Tracking</h2>
                
                <div class="form-section">
                    <h5>Add New Product</h5>
                    <form id="inventory-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-category" class="form-label">Category</label>
                                    <select class="form-select" id="product-category">
                                        <option value="">Select Category</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Food">Food</option>
                                        <option value="Books">Books</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="product-quantity" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-low-stock" class="form-label">Low Stock Threshold</label>
                                    <input type="number" class="form-control" id="product-low-stock" required min="1" value="10">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-cost" class="form-label">Cost Price (RM)</label>
                                    <input type="number" class="form-control" id="product-cost" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">Selling Price (RM)</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01" required min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="product-supplier" class="form-label">Supplier</label>
                                    <input type="text" class="form-control" id="product-supplier">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="product-description" class="form-label">Description</label>
                                    <textarea class="form-control" id="product-description" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Add Product</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Inventory List</h5>
                        <div>
                            <button class="btn btn-success" id="generate-inventory-pdf">
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                            <button class="btn btn-info" id="export-inventory-csv">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn btn-warning" id="add-bill-address">
                                <i class="fas fa-map-marker-alt"></i> Add Bill Address
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search products..." id="inventory-search">
                                <button class="btn btn-outline-secondary" type="button" id="inventory-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-category-filter">
                                <option value="">All Categories</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Food">Food</option>
                                <option value="Books">Books</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="inventory-stock-filter">
                                <option value="">All Stock Status</option>
                                <option value="low">Low Stock</option>
                                <option value="out">Out of Stock</option>
                                <option value="in">In Stock</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Cost Price (RM)</th>
                                    <th>Selling Price (RM)</th>
                                    <th>Stock Value (RM)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list">
                                <!-- Inventory items will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" style="text-align: right; font-weight: bold;">Total Inventory Value:</td>
                                    <td id="inventory-total-value" style="font-weight: bold;">RM 0.00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking Page -->
            <div id="progress-tracking" class="page">
                <h2>Progress Tracking</h2>
                
                <div class="progress-summary">
                    <div class="progress-card">
                        <h5>Total Bills</h5>
                        <p class="value" id="total-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Recorded</h5>
                        <p class="value" id="recorded-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Paid</h5>
                        <p class="value" id="paid-bills-count">0</p>
                    </div>
                    <div class="progress-card">
                        <h5>Overdue</h5>
                        <p class="value" id="overdue-bills-count">0</p>
                    </div>
                </div>
                
                <div class="progress-filter">
                    <h5>Filter Bills</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-status-filter" class="form-label">Status</label>
                                <select class="form-select" id="progress-status-filter">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="recorded">Recorded</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-from" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="progress-date-from">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="progress-date-to" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="progress-date-to">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" id="apply-progress-filter">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Bill Progress</h5>
                        <div>
                            <button class="btn btn-success" id="generate-progress-report">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </button>
                            <button class="btn btn-info" id="add-progress-update">
                                <i class="fas fa-plus"></i> Add Daily Update
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill No</th>
                                    <th>Description</th>
                                    <th>Customer</th>
                                    <th>Amount (RM)</th>
                                    <th>Status</th>
                                    <th>Address Map</th>
                                    <th>Last Updated</th>
                                    <th>Progress Updates</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="progress-bills-list">
                                <!-- Progress bills will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Progress Update Modal -->
                <div class="modal fade" id="progressUpdateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Progress Update</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="progress-update-form">
                                    <input type="hidden" id="progress-bill-id">
                                    <div class="mb-3">
                                        <label for="progress-status" class="form-label">Status</label>
                                        <select class="form-select" id="progress-status" required>
                                            <option value="pending">Pending</option>
                                            <option value="recorded">Recorded</option>
                                            <option value="paid">Paid</option>
                                            <option value="overdue">Overdue</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="progress-notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="progress-notes" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-progress-update">Save Update</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill Address Modal -->
                <div class="modal fade" id="billAddressModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Bill Address</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="bill-address-form">
                                    <input type="hidden" id="address-bill-id">
                                    <div class="mb-3">
                                        <label for="bill-address" class="form-label">Bill Address</label>
                                        <input type="text" class="form-control" id="bill-address" placeholder="Enter full address">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Google Maps Preview</label>
                                        <div id="map-preview" style="height: 200px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                            <p class="text-muted">Enter an address to see a preview</p>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-bill-address">Save Address</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- More Page -->
            <div id="more" class="page">
                <h2>Additional Features</h2>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-3x mb-3 text-primary"></i>
                                <h5>Customer Management</h5>
                                <p>Manage your customer database and track interactions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-box fa-3x mb-3 text-primary"></i>
                                <h5>Inventory Tracking</h5>
                                <p>Monitor stock levels and receive low inventory alerts</p>
                                <button class="btn btn-outline-primary" data-page="inventory-tracking">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3 text-primary"></i>
                                <h5>Advanced Reports</h5>
                                <p>Generate detailed reports and analytics</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cog fa-3x mb-3 text-primary"></i>
                                <h5>Settings</h5>
                                <p>Customize system preferences and user permissions</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-bell fa-3x mb-3 text-primary"></i>
                                <h5>Notifications</h5>
                                <p>Set up alerts for important events and deadlines</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Data Backup</h5>
                                <p>Automatically backup your data to the cloud</p>
                                <button class="btn btn-outline-primary">Explore</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h5>System Settings</h5>
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currency" class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option selected>RM (Malaysian Ringgit)</option>
                                        <option>USD (US Dollar)</option>
                                        <option>EUR (Euro)</option>
                                        <option>GBP (British Pound)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language">
                                        <option selected>English</option>
                                        <option>Malay</option>
                                        <option>Chinese</option>
                                        <option>Tamil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date-format" class="form-label">Date Format</label>
                                    <select class="form-select" id="date-format">
                                        <option selected>DD/MM/YYYY</option>
                                        <option>MM/DD/YYYY</option>
                                        <option>YYYY-MM-DD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax-rate" class="form-label">Tax Rate (%)</label>
                                    <input type="number" class="form-control" id="tax-rate" value="6.0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    <label class="form-check-label" for="email-notifications">Enable Email Notifications</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and App Initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-q5IfxsoF-Ud7YTw2jwHwrzXQuDmxey8",
            authDomain: "dealer-billing-system.firebaseapp.com",
            projectId: "dealer-billing-system",
            storageBucket: "dealer-billing-system.firebasestorage.app",
            messagingSenderId: "646495235869",
            appId: "1:646495235869:web:8a495e5f34e04b8cc0fbf4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        let performanceChartInstance = null;
        let profitLossChartInstance = null;
        
        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const mainContainer = document.getElementById('main-container');
        const loginBtn = document.getElementById('login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const registerSection = document.getElementById('register-section');
        const loginSection = document.getElementById('login-section');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        
        // Navigation
        const navLinks = document.querySelectorAll('.sidebar a[data-page]');
        const pages = document.querySelectorAll('.page');
        
        // Bill Forms
        const periodicForm = document.getElementById('periodic-bill-form');
        const individualForm = document.getElementById('individual-bill-form');
        const monthlyForm = document.getElementById('monthly-bill-form');
        const yearlyForm = document.getElementById('yearly-bill-form');
        const profitLossForm = document.getElementById('profit-loss-form');
        const customerForm = document.getElementById('customer-form');
        const inventoryForm = document.getElementById('inventory-form');
        
        // Bill Lists
        const periodicBillsList = document.getElementById('periodic-bills-list');
        const individualBillsList = document.getElementById('individual-bills-list');
        const monthlyBillsList = document.getElementById('monthly-bills-list');
        const yearlyBillsList = document.getElementById('yearly-bills-list');
        const customersList = document.getElementById('customers-list');
        const inventoryList = document.getElementById('inventory-list');
        const progressBillsList = document.getElementById('progress-bills-list');
        
        // Grand Totals
        const periodicGrandTotal = document.getElementById('periodic-grand-total');
        const individualGrandTotal = document.getElementById('individual-grand-total');
        const monthlyGrandTotal = document.getElementById('monthly-grand-total');
        const yearlyGrandTotal = document.getElementById('yearly-grand-total');
        const inventoryTotalValue = document.getElementById('inventory-total-value');
        
        // PDF Generation Buttons
        const generatePeriodicPdf = document.getElementById('generate-periodic-pdf');
        const generateIndividualPdf = document.getElementById('generate-individual-pdf');
        const generateMonthlyPdf = document.getElementById('generate-monthly-pdf');
        const generateYearlyPdf = document.getElementById('generate-yearly-pdf');
        const generateInventoryPdf = document.getElementById('generate-inventory-pdf');
        const exportInventoryCsv = document.getElementById('export-inventory-csv');
        const generateProgressReport = document.getElementById('generate-progress-report');
        
        // Progress Tracking Elements
        const totalBillsCount = document.getElementById('total-bills-count');
        const recordedBillsCount = document.getElementById('recorded-bills-count');
        const paidBillsCount = document.getElementById('paid-bills-count');
        const overdueBillsCount = document.getElementById('overdue-bills-count');
        const applyProgressFilter = document.getElementById('apply-progress-filter');
        const addProgressUpdate = document.getElementById('add-progress-update');
        const saveProgressUpdate = document.getElementById('save-progress-update');
        const progressStatusFilter = document.getElementById('progress-status-filter');
        const progressDateFrom = document.getElementById('progress-date-from');
        const progressDateTo = document.getElementById('progress-date-to');
        
        // Profit/Loss Calculation
        const profitLossResult = document.getElementById('profit-loss-result');
        const resultText = document.getElementById('result-text');
        
        // Dashboard elements
        const totalRevenue = document.getElementById('total-revenue');
        const totalExpenses = document.getElementById('total-expenses');
        const netProfit = document.getElementById('net-profit');
        const inventoryValue = document.getElementById('inventory-value');
        const recentBills = document.getElementById('recent-bills');
        const lowStockAlerts = document.getElementById('low-stock-alerts');
        const plRevenue = document.getElementById('pl-revenue');
        const plExpenses = document.getElementById('pl-expenses');
        const revenueComparison = document.getElementById('revenue-comparison');
        const expensesComparison = document.getElementById('expenses-comparison');
        const plBreakdown = document.getElementById('pl-breakdown');
        
        // Inventory elements
        const inventorySearch = document.getElementById('inventory-search');
        const inventorySearchBtn = document.getElementById('inventory-search-btn');
        const inventoryCategoryFilter = document.getElementById('inventory-category-filter');
        const inventoryStockFilter = document.getElementById('inventory-stock-filter');
        
        // Breakdown elements
        const addBreakdownItemBtn = document.getElementById('add-breakdown-item');
        const saveBreakdownBtn = document.getElementById('save-breakdown');
        const resetBreakdownBtn = document.getElementById('reset-breakdown');
        
        // Sample data for charts
        const monthlyData = {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            revenue: [12000, 19000, 15000, 21000, 22000, 24500],
            expenses: [9000, 12000, 11000, 15000, 16700, 18300]
        };
        
        // Store bills data
        let bills = {
            periodic: [],
            individual: [],
            monthly: [],
            yearly: []
        };
        
        // Store customers data
        let customers = [];
        
        // Store inventory data
        let inventory = [];
        
        // Store breakdown data
        let breakdownData = [];
        
        // Store progress data
        let progressUpdates = {};
        
        // Store bill addresses
        let billAddresses = {};
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.innerHTML = `
                <div class="toast-body">
                    <button type="button" class="btn-close float-end" data-bs-dismiss="toast"></button>
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // Initialize progress tracking
        function initProgressTracking() {
            setDefaultProgressDates();
            
            // Add event listeners
            applyProgressFilter.addEventListener('click', filterProgressBills);
            generateProgressReport.addEventListener('click', generateProgressPdf);
            addProgressUpdate.addEventListener('click', showProgressUpdateModal);
            saveProgressUpdate.addEventListener('click', saveProgressUpdateHandler);
            
            // Load progress data
            loadProgressData();
        }
        
        // Set default dates for progress filter
        function setDefaultProgressDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();
            
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            
            const yyyy2 = firstDay.getFullYear();
            let mm2 = firstDay.getMonth() + 1;
            let dd2 = firstDay.getDate();
            
            if (dd2 < 10) dd2 = '0' + dd2;
            if (mm2 < 10) mm2 = '0' + mm2;
            
            const formattedFirstDay = `${yyyy2}-${mm2}-${dd2}`;
            
            progressDateFrom.value = formattedFirstDay;
            progressDateTo.value = formattedToday;
        }
        
        // Load progress data from Firebase
        function loadProgressData() {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('progress').get()
                .then(querySnapshot => {
                    progressUpdates = {};
                    
                    querySnapshot.forEach(doc => {
                        const progress = doc.data();
                        if (!progressUpdates[progress.billId]) {
                            progressUpdates[progress.billId] = [];
                        }
                        progressUpdates[progress.billId].push(progress);
                    });
                    
                    // Load bill addresses
                    db.collection('users').doc(auth.currentUser.uid).collection('billAddresses').get()
                        .then(querySnapshot => {
                            billAddresses = {};
                            querySnapshot.forEach(doc => {
                                const addressData = doc.data();
                                billAddresses[addressData.billId] = addressData.address;
                            });
                            
                            // Update progress view
                            updateProgressView();
                        })
                        .catch(error => {
                            console.error("Error loading bill addresses: ", error);
                        });
                })
                .catch(error => {
                    console.error("Error loading progress: ", error);
                });
        }
        
        function updateProgressView() {
    // 安全检查
    if (!progressBillsList) return;

    // 清空表格
    progressBillsList.innerHTML = '';

    // 合并所有 bills
    const allBills = [];
    for (const type in bills) {
        if (Array.isArray(bills[type])) {
            bills[type].forEach(bill => {
                if (bill && bill.id) {
                    allBills.push(bill);
                }
            });
        }
    }

    // === ⭐ 没有任何数据时，直接显示提示并 return ===
    if (allBills.length === 0) {
        progressBillsList.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    No bills yet
                </td>
            </tr>
        `;

        totalBillsCount.textContent = 0;
        recordedBillsCount.textContent = 0;
        paidBillsCount.textContent = 0;
        overdueBillsCount.textContent = 0;
        return;
    }

    // 计数器
    let total = 0;
    let recorded = 0;
    let paid = 0;
    let overdue = 0;

    // 渲染表格
    allBills.forEach(bill => {
        const billProgress = progressUpdates[bill.id] || [];
        const latestUpdate = billProgress.length
            ? billProgress[billProgress.length - 1]
            : { status: 'pending' };

        total++;
        if (latestUpdate.status === 'recorded') recorded++;
        if (latestUpdate.status === 'paid') paid++;
        if (latestUpdate.status === 'overdue') overdue++;

        const customerName = bill.customerName || 'N/A';

        // 地图链接
        let mapLink = 'No address';
        const address = billAddresses[bill.id] || bill.customerAddress;
        if (address) {
            const encoded = encodeURIComponent(address);
            mapLink = `
                <a href="https://www.google.com/maps/search/?api=1&query=${encoded}" 
                   target="_blank" class="map-link">
                    <i class="fas fa-map-marker-alt"></i> View
                </a>
            `;
        }

        const totalAmount = Number(bill.total) || 0;
        const lastUpdateDate = billProgress.length
            ? new Date(billProgress[billProgress.length - 1].date).toLocaleDateString()
            : 'Never';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${bill.date || '-'}</td>
            <td>${bill.billNo || '-'}</td>
            <td>${bill.description || '-'}</td>
            <td>${customerName}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
                <span class="status-badge status-${latestUpdate.status}">
                    ${latestUpdate.status.charAt(0).toUpperCase() + latestUpdate.status.slice(1)}
                </span>
            </td>
            <td>${mapLink}</td>
            <td>${lastUpdateDate}</td>
            <td>
                ${
                    billProgress.length
                        ? `<button class="btn btn-sm btn-info" onclick="viewProgressUpdates('${bill.id}')">
                            <i class="fas fa-eye"></i> View (${billProgress.length})
                           </button>`
                        : 'No updates'
                }
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="updateBillProgress('${bill.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="addBillAddress('${bill.id}')">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </td>
        `;

        progressBillsList.appendChild(row);
    });

    // 更新统计
    totalBillsCount.textContent = total;
    recordedBillsCount.textContent = recorded;
    paidBillsCount.textContent = paid;
    overdueBillsCount.textContent = overdue;
}

        
       function filterProgressBills() {
    if (!progressBillsList) return;

    const statusFilter = progressStatusFilter.value;
    const dateFrom = progressDateFrom.value ? new Date(progressDateFrom.value) : null;
    const dateTo = progressDateTo.value ? new Date(progressDateTo.value) : null;

    if (dateTo) dateTo.setDate(dateTo.getDate() + 1);

    // 清空表格
    progressBillsList.innerHTML = '';

    // 合并 bills（安全）
    const allBills = [];
    for (const type in bills) {
        if (Array.isArray(bills[type])) {
            bills[type].forEach(bill => {
                if (bill && bill.id) allBills.push(bill);
            });
        }
    }

    // 计数器
    let total = 0;
    let recorded = 0;
    let paid = 0;
    let overdue = 0;

    let hasResult = false;

    allBills.forEach(bill => {
        // 日期过滤（安全）
        if (dateFrom || dateTo) {
            if (!bill.date) return;
            const billDate = new Date(bill.date);
            if (isNaN(billDate)) return;
            if (dateFrom && billDate < dateFrom) return;
            if (dateTo && billDate >= dateTo) return;
        }

        const billProgress = progressUpdates[bill.id] || [];
        const latestUpdate = billProgress.length
            ? billProgress[billProgress.length - 1]
            : { status: 'pending' };

        if (statusFilter !== 'all' && latestUpdate.status !== statusFilter) return;

        hasResult = true;
        total++;

        if (latestUpdate.status === 'recorded') recorded++;
        if (latestUpdate.status === 'paid') paid++;
        if (latestUpdate.status === 'overdue') overdue++;

        const customerName = bill.customerName || 'N/A';

        // 地址
        let mapLink = 'No address';
        const address = billAddresses[bill.id] || bill.customerAddress;
        if (address) {
            const encoded = encodeURIComponent(address);
            mapLink = `
                <a href="https://www.google.com/maps/search/?api=1&query=${encoded}" 
                   target="_blank" class="map-link">
                    <i class="fas fa-map-marker-alt"></i> View
                </a>
            `;
        }

        const totalAmount = Number(bill.total) || 0;
        const lastUpdateDate = billProgress.length
            ? new Date(billProgress[billProgress.length - 1].date).toLocaleDateString()
            : 'Never';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${bill.date || '-'}</td>
            <td>${bill.billNo || '-'}</td>
            <td>${bill.description || '-'}</td>
            <td>${customerName}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
                <span class="status-badge status-${latestUpdate.status}">
                    ${latestUpdate.status.charAt(0).toUpperCase() + latestUpdate.status.slice(1)}
                </span>
            </td>
            <td>${mapLink}</td>
            <td>${lastUpdateDate}</td>
            <td>
                ${
                    billProgress.length
                        ? `<button class="btn btn-sm btn-info" onclick="viewProgressUpdates('${bill.id}')">
                            <i class="fas fa-eye"></i> View (${billProgress.length})
                           </button>`
                        : 'No updates'
                }
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="updateBillProgress('${bill.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="addBillAddress('${bill.id}')">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </td>
        `;

        progressBillsList.appendChild(row);
    });

    // ⭐ 无结果提示（非常关键）
    if (!hasResult) {
        progressBillsList.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    No bills match the selected filter
                </td>
            </tr>
        `;
    }

    // 更新统计
    totalBillsCount.textContent = total;
    recordedBillsCount.textContent = recorded;
    paidBillsCount.textContent = paid;
    overdueBillsCount.textContent = overdue;
}

        
        // Show progress update modal
        function showProgressUpdateModal() {
            // This function would show a modal to add a general progress update
            // For simplicity, we'll just show a toast notification
            showToast('Use the Update button next to each bill to add progress updates', 'info');
        }
        
        // Update bill progress
        window.updateBillProgress = function(billId) {
            // Find the bill
            let bill = null;
            for (const type in bills) {
                bill = bills[type].find(b => b.id === billId);
                if (bill) break;
            }
            
            if (!bill) return;
            
            // Set bill ID in modal
            document.getElementById('progress-bill-id').value = billId;
            
            // Set current status if exists
            const billProgress = progressUpdates[billId] || [];
            if (billProgress.length > 0) {
                document.getElementById('progress-status').value = billProgress[billProgress.length - 1].status;
            } else {
                document.getElementById('progress-status').value = 'pending';
            }
            
            // Clear notes
            document.getElementById('progress-notes').value = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('progressUpdateModal'));
            modal.show();
        };
        
        // Add bill address
        window.addBillAddress = function(billId) {
            // Find the bill
            let bill = null;
            for (const type in bills) {
                bill = bills[type].find(b => b.id === billId);
                if (bill) break;
            }
            
            if (!bill) return;
            
            // Set bill ID in modal
            document.getElementById('address-bill-id').value = billId;
            
            // Set current address if exists
            const address = billAddresses[billId] || bill.customerAddress || '';
            document.getElementById('bill-address').value = address;
            
            // Update map preview
            updateMapPreview(address);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('billAddressModal'));
            modal.show();
        };
        
        // Update map preview
        function updateMapPreview(address) {
            const mapPreview = document.getElementById('map-preview');
            
            if (address) {
                const encodedAddress = encodeURIComponent(address);
                mapPreview.innerHTML = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        style="border:0; border-radius: 5px;" 
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyB-q5IfxsoF-Ud7YTw2jwHwrzXQuDmxey8&q=${encodedAddress}" 
                        allowfullscreen>
                    </iframe>
                `;
            } else {
                mapPreview.innerHTML = '<p class="text-muted">Enter an address to see a preview</p>';
            }
        }
        
        // Save progress update
        function saveProgressUpdateHandler() {
            const billId = document.getElementById('progress-bill-id').value;
            const status = document.getElementById('progress-status').value;
            const notes = document.getElementById('progress-notes').value;
            
            if (!billId) return;
            
            // Create progress update
            const progressUpdate = {
                id: Date.now().toString(),
                billId: billId,
                status: status,
                notes: notes,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            // Add to progress updates
            if (!progressUpdates[billId]) {
                progressUpdates[billId] = [];
            }
            progressUpdates[billId].push(progressUpdate);
            
            // Save to Firebase
            saveProgressUpdateToFirebase(progressUpdate);
            
            // Update view
            updateProgressView();
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressUpdateModal'));
            modal.hide();
            
            // Show success message
            showToast('Progress update saved successfully', 'success');
        }
        
        // Save bill address
        document.getElementById('save-bill-address').addEventListener('click', function() {
            const billId = document.getElementById('address-bill-id').value;
            const address = document.getElementById('bill-address').value;
            
            if (!billId) return;
            
            // Save address
            billAddresses[billId] = address;
            
            // Save to Firebase
            saveBillAddressToFirebase(billId, address);
            
            // Update view
            updateProgressView();
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('billAddressModal'));
            modal.hide();
            
            // Show success message
            showToast('Bill address saved successfully', 'success');
        });
        
        // Update map preview when address changes
        document.getElementById('bill-address').addEventListener('input', function() {
            updateMapPreview(this.value);
        });
        
        // View progress updates
window.viewProgressUpdates = function(billId) {
    const billProgress = progressUpdates[billId] || [];
    
    if (billProgress.length === 0) {
        showToast('No progress updates for this bill', 'info');
        return;
    }
    
    // 移除已存在的模态框
    const existingModal = document.querySelector('.progress-updates-modal');
    if (existingModal) existingModal.remove();
    
    // 创建模态框内容
    let content = '<div class="progress-updates" style="max-height: 400px; overflow-y: auto;">';
    billProgress.forEach(update => {
        content += `
            <div class="progress-update mb-3 p-3 rounded" style="background-color: var(--card-bg); border-left: 4px solid ${getStatusColor(update.status)}">
                <p class="mb-1"><strong>${update.status.charAt(0).toUpperCase() + update.status.slice(1)}</strong> - ${new Date(update.date).toLocaleDateString()}</p>
                <p class="mb-1">${update.notes || 'No notes'}</p>
                <small class="text-muted">Updated: ${new Date(update.createdAt).toLocaleString()}</small>
            </div>
        `;
    });
    content += '</div>';
    
    // 创建模态框
    const modalHTML = `
        <div class="modal fade progress-updates-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Progress Updates</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 添加到 DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 显示模态框
    const modalElement = document.querySelector('.progress-updates-modal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // 清理
    modalElement.addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
};

// 添加状态颜色辅助函数
function getStatusColor(status) {
    const colors = {
        'pending': '#ffc107',
        'recorded': '#17a2b8',
        'paid': '#28a745',
        'overdue': '#dc3545'
    };
    return colors[status] || '#6c757d';
}
        
        // Generate progress PDF report
        function generateProgressPdf() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Progress Tracking Report', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add filter info
            doc.text(`Status: ${progressStatusFilter.value === 'all' ? 'All' : progressStatusFilter.options[progressStatusFilter.selectedIndex].text}`, 14, 40);
            doc.text(`Date Range: ${progressDateFrom.value} to ${progressDateTo.value}`, 14, 48);
            
            // Add summary
            doc.setFontSize(14);
            doc.text('Summary', 14, 60);
            doc.setFontSize(12);
            doc.text(`Total Bills: ${totalBillsCount.textContent}`, 14, 70);
            doc.text(`Recorded: ${recordedBillsCount.textContent}`, 14, 78);
            doc.text(`Paid: ${paidBillsCount.textContent}`, 14, 86);
            doc.text(`Overdue: ${overdueBillsCount.textContent}`, 14, 94);
            
            // Add table
            const tableColumn = ["Date", "Bill No", "Description", "Customer", "Amount", "Status"];
            const tableRows = [];
            
            const rows = progressBillsList.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent
                ];
                tableRows.push(rowData);
            });
            
            doc.autoTable({
                startY: 110,
                head: [tableColumn],
                body: tableRows,
                theme: 'grid'
            });
            
            // Save the PDF
            doc.save('progress-report.pdf');
            
            showToast('Progress report generated successfully', 'success');
        }
        
        // Save progress update to Firebase
        function saveProgressUpdateToFirebase(progressUpdate) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('progress').doc(progressUpdate.id).set(progressUpdate)
                .catch(error => {
                    console.error("Error saving progress update: ", error);
                    showToast('Error saving progress update. Please try again.', 'error');
                });
        }
        
        // Save bill address to Firebase
        function saveBillAddressToFirebase(billId, address) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('billAddresses').doc(billId).set({
                billId: billId,
                address: address,
                updatedAt: new Date().toISOString()
            })
            .catch(error => {
                console.error("Error saving bill address: ", error);
                showToast('Error saving bill address. Please try again.', 'error');
            });
        }
        
        // Initialize breakdown functionality
        function initBreakdown() {
            // Load breakdown data from Firebase
            loadBreakdownData();
            
            // Add event listeners
            addBreakdownItemBtn.addEventListener('click', addBreakdownItem);
            saveBreakdownBtn.addEventListener('click', saveBreakdownData);
            resetBreakdownBtn.addEventListener('click', resetBreakdownData);
        }
        
        // Add new breakdown item
        function addBreakdownItem() {
            const newItem = {
                id: Date.now().toString(),
                category: 'New Category',
                amount: 0,
                percentage: 0,
                trend: 'up'
            };
            
            breakdownData.push(newItem);
            renderBreakdownItem(newItem);
            showToast('New breakdown item added', 'success');
        }
        
        function renderBreakdownItem(item) {
    if (!item || !item.id) return;

    // ⭐ 如果已存在同 ID 行，直接更新而不是新增
    let row = plBreakdown.querySelector(`tr[data-id="${item.id}"]`);

    if (!row) {
        row = document.createElement('tr');
        row.setAttribute('data-id', item.id);
        plBreakdown.appendChild(row);
    }

    const amount = Number(item.amount) || 0;
    const percentage = Number(item.percentage) || 0;

    row.innerHTML = `
        <td>
            <span class="editable-field" contenteditable="true" data-field="category">
                ${item.category || ''}
            </span>
        </td>
        <td>
            <span class="editable-field" contenteditable="true" data-field="amount">
                ${amount}
            </span>
        </td>
        <td>
            <span class="editable-field" contenteditable="true" data-field="percentage">
                ${percentage}
            </span>%
        </td>
        <td>
            <select class="form-select form-select-sm trend-select" data-field="trend">
                <option value="up" ${item.trend === 'up' ? 'selected' : ''}>↑ Increase</option>
                <option value="down" ${item.trend === 'down' ? 'selected' : ''}>↓ Decrease</option>
                <option value="stable" ${item.trend === 'stable' ? 'selected' : ''}>→ Stable</option>
            </select>
        </td>
        <td>
            <i class="fas fa-trash action-btn text-danger"
               onclick="deleteBreakdownItem('${item.id}')"></i>
        </td>
    `;

    // ⭐ 重新绑定事件（避免重复）
    row.querySelectorAll('.editable-field').forEach(field => {
        field.onblur = function () {
            const fieldName = this.dataset.field;
            let value = this.textContent.trim();

            if (fieldName !== 'category') {
                value = Number(value) || 0;
            }

            updateBreakdownItem(item.id, fieldName, value);
        };
    });

    row.querySelector('.trend-select').onchange = function () {
        updateBreakdownItem(item.id, 'trend', this.value);
    };
}

        
        // Update breakdown item
        function updateBreakdownItem(id, field, value) {
            const itemIndex = breakdownData.findIndex(item => item.id === id);
            if (itemIndex === -1) return;
            
            if (field === 'amount' || field === 'percentage') {
                value = parseFloat(value) || 0;
            }
            
            breakdownData[itemIndex][field] = value;
        }
        
        // Delete breakdown item
        window.deleteBreakdownItem = function(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            // Remove from data array
            breakdownData = breakdownData.filter(item => item.id !== id);
            
            // Remove from UI
            const row = document.querySelector(`#pl-breakdown tr[data-id="${id}"]`);
            if (row) row.remove();
            
            // Delete from Firebase
            deleteBreakdownFromFirebase(id);
            
            showToast('Breakdown item deleted', 'success');
        };
        
        // Save breakdown data
        function saveBreakdownData() {
            if (!auth.currentUser) return;
            
            // Update all editable fields in case any are still focused
            document.querySelectorAll('.editable-field').forEach(field => {
                field.dispatchEvent(new Event('blur'));
            });
            
            // Save to Firebase
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            
            userRef.set({
                breakdown: breakdownData
            }, { merge: true })
            .then(() => {
                showToast('Breakdown data saved successfully!', 'success');
            })
            .catch(error => {
                console.error("Error saving breakdown: ", error);
                showToast('Error saving data. Please try again.', 'error');
            });
        }
        
        // Reset breakdown data
        function resetBreakdownData() {
            if (!confirm('Are you sure you want to reset all breakdown data? This cannot be undone.')) return;
            
            breakdownData = [];
            plBreakdown.innerHTML = '';
            
            // Reset in Firebase
            if (auth.currentUser) {
                const userRef = db.collection('users').doc(auth.currentUser.uid);
                
                userRef.update({
                    breakdown: []
                })
                .then(() => {
                    showToast('Breakdown data reset successfully!', 'success');
                })
                .catch(error => {
                    console.error("Error resetting breakdown: ", error);
                    showToast('Error resetting data. Please try again.', 'error');
                });
            }
        }
        
        // Load breakdown data from Firebase
        function loadBreakdownData() {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().breakdown) {
                        breakdownData = doc.data().breakdown;
                        
                        // Render all items
                        plBreakdown.innerHTML = '';
                        breakdownData.forEach(item => {
                            renderBreakdownItem(item);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading breakdown: ", error);
                });
        }
        
        // Delete breakdown from Firebase
        function deleteBreakdownFromFirebase(id) {
            if (!auth.currentUser) return;
            
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            
            userRef.get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.breakdown) {
                            const updatedBreakdown = data.breakdown.filter(item => item.id !== id);
                            
                            return userRef.update({
                                breakdown: updatedBreakdown
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error("Error deleting breakdown item: ", error);
                });
        }
        
        // Event Listeners
        showRegister.addEventListener('click', function(e) {
            e.preventDefault();
            registerSection.style.display = 'block';
            loginSection.style.display = 'none';
        });
        
        showLogin.addEventListener('click', function(e) {
            e.preventDefault();
            registerSection.style.display = 'none';
            loginSection.style.display = 'block';
        });
        
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetPage = this.getAttribute('data-page');
                
                // Update active navigation link
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                this.classList.add('active');
                
                // Show target page
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(targetPage).classList.add('active');
                
                // If navigating to dashboard, update it
                if (targetPage === 'dashboard') {
                    updateDashboard();
                }
                
                // If navigating to profit-loss, update it
                if (targetPage === 'profit-loss') {
                    updateProfitLoss();
                }
                
                // If navigating to inventory-tracking, update it
                if (targetPage === 'inventory-tracking') {
                    updateInventoryList();
                }
                
                // If navigating to progress-tracking, update it
                if (targetPage === 'progress-tracking') {
                    updateProgressView();
                }
            });
        });
        
        // Setup bill form handlers
        function setupBillForm(form, quantityId, priceId, totalId, listId, grandTotalId, billType) {
            const quantityInput = document.getElementById(quantityId);
            const priceInput = document.getElementById(priceId);
            const totalInput = document.getElementById(totalId);
            const billList = document.getElementById(listId);
            const grandTotal = document.getElementById(grandTotalId);
            
            // Calculate total
            quantityInput.addEventListener('input', calculateTotal);
            priceInput.addEventListener('input', calculateTotal);
            
            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                totalInput.value = total.toFixed(2);
            }
            
            // 在 setupBillForm 函数中，修改 form submit 事件处理函数
form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const dateInput = document.getElementById(`${billType}-date`);
    const billNoInput = document.getElementById(`${billType}-billno`);
    const descriptionInput = document.getElementById(`${billType}-description`);
    
    const date = dateInput.value;
    const billNo = billNoInput.value;
    const description = descriptionInput.value;
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    // For individual bills, get customer info
    let customerName = '';
    let customerAddress = '';
    
    if (billType === 'individual') {
        customerName = document.getElementById('individual-customer-name').value;
        customerAddress = document.getElementById('individual-customer-address').value;
    }
    
    const bill = {
        id: Date.now().toString(),
        date,
        billNo,
        description,
        quantity,
        price,
        total,
        type: billType,
        customerName,
        customerAddress
    };
    
    // Add to bills array ✅ 只操作数组
    bills[billType].push(bill);
    
    // ✅ 不在这里 append DOM
    // 重新渲染整个表格
    renderBillsByType(billType);
    
    // Update grand total
    updateGrandTotal();
    
    // Save to Firebase
    saveBillToFirebase(bill);
    
    // Show success message
    showToast('Bill item added successfully', 'success');
    
    // Reset form
    form.reset();
    totalInput.value = '0.00';
    
    // Set today's date
    const today = new Date();
    const yyyy = today.getFullYear();
    let mm = today.getMonth() + 1;
    let dd = today.getDate();
    
    if (dd < 10) dd = '0' + dd;
    if (mm < 10) mm = '0' + mm;
    
    const formattedToday = `${yyyy}-${mm}-${dd}`;
    dateInput.value = formattedToday;
    
    // Update progress view if on progress page
    updateProgressView();
});
           
            function updateGrandTotal() {
    let total = 0;
    const rows = billList.querySelectorAll('tr');
    
    rows.forEach(row => {
        // 安全检查：确保行有足够的单元格
        if (row.cells && row.cells.length > (billType === 'individual' ? 6 : 5)) {
            const totalCell = billType === 'individual' ? row.cells[6] : row.cells[5];
            if (totalCell && totalCell.textContent) {
                total += parseFloat(totalCell.textContent) || 0;
            }
        }
    });
    
    grandTotal.textContent = `RM ${total.toFixed(2)}`;
}
        
        // Setup all bill forms
        const updatePeriodicTotal = setupBillForm(
            periodicForm, 
            'periodic-quantity', 
            'periodic-price', 
            'periodic-total', 
            'periodic-bills-list', 
            'periodic-grand-total',
            'periodic'
        );
        
        const updateIndividualTotal = setupBillForm(
            individualForm, 
            'individual-quantity', 
            'individual-price', 
            'individual-total', 
            'individual-bills-list', 
            'individual-grand-total',
            'individual'
        );
        
        const updateMonthlyTotal = setupBillForm(
            monthlyForm, 
            'monthly-quantity', 
            'monthly-price', 
            'monthly-total', 
            'monthly-bills-list', 
            'monthly-grand-total',
            'monthly'
        );
        
        const updateYearlyTotal = setupBillForm(
            yearlyForm, 
            'yearly-quantity', 
            'yearly-price', 
            'yearly-total', 
            'yearly-bills-list', 
            'yearly-grand-total',
            'yearly'
        );
        
        // Inventory Form Handling
        inventoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const sku = document.getElementById('product-sku').value;
            const category = document.getElementById('product-category').value;
            const quantity = parseInt(document.getElementById('product-quantity').value);
            const lowStockThreshold = parseInt(document.getElementById('product-low-stock').value);
            const costPrice = parseFloat(document.getElementById('product-cost').value);
            const sellingPrice = parseFloat(document.getElementById('product-price').value);
            const supplier = document.getElementById('product-supplier').value;
            const description = document.getElementById('product-description').value;
            
            const product = {
                id: Date.now().toString(),
                name,
                sku,
                category,
                quantity,
                lowStockThreshold,
                costPrice,
                sellingPrice,
                supplier,
                description,
                stockValue: costPrice * quantity,
                createdAt: new Date().toISOString()
            };
            
            // Add to inventory array
            inventory.push(product);
            
            // Add to UI
            addProductToUI(product);
            
            // Save to Firebase
            saveProductToFirebase(product);
            
            // Show success message
            showToast('Product added successfully', 'success');
            
            // Reset form
            inventoryForm.reset();
            document.getElementById('product-low-stock').value = '10';
            
            // Update inventory total value
            updateInventoryTotalValue();
            
            // Update dashboard
            updateDashboard();
        });
        
        function addProductToUI(product) {
            const status = getStockStatus(product.quantity, product.lowStockThreshold);
            const statusClass = status === 'Out of Stock' ? 'out-of-stock' : 
                               status === 'Low Stock' ? 'low-stock' : 'in-stock';
            
            const newRow = document.createElement('tr');
            newRow.className = statusClass;
            newRow.innerHTML = `
                <td>${product.name}</td>
                <td>${product.sku}</td>
                <td>${product.category}</td>
                <td>${product.quantity}</td>
                <td>${product.costPrice.toFixed(2)}</td>
                <td>${product.sellingPrice.toFixed(2)}</td>
                <td>${product.stockValue.toFixed(2)}</td>
                <td><span class="stock-alert ${status === 'Out of Stock' ? 'alert-out' : status === 'Low Stock' ? 'alert-low' : ''}">${status}</span></td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editProduct('${product.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteProduct('${product.id}')"></i>
                </td>
            `;
            inventoryList.appendChild(newRow);
        }
        
        function getStockStatus(quantity, threshold) {
            if (quantity === 0) {
                return 'Out of Stock';
            } else if (quantity <= threshold) {
                return 'Low Stock';
            } else {
                return 'In Stock';
            }
        }
        
        function updateInventoryTotalValue() {
            let totalValue = 0;
            const rows = inventoryList.querySelectorAll('tr');
            
            rows.forEach(row => {
                const valueCell = row.cells[6];
                totalValue += parseFloat(valueCell.textContent);
            });
            
            inventoryTotalValue.textContent = `RM ${totalValue.toFixed(2)}`;
            document.getElementById('inventory-value').textContent = `RM ${totalValue.toFixed(2)}`;
        }
        
        function updateInventoryList() {
            inventoryList.innerHTML = '';
            inventory.forEach(product => {
                addProductToUI(product);
            });
            updateInventoryTotalValue();
        }
        
        // Inventory search and filter
        inventorySearchBtn.addEventListener('click', filterInventory);
        inventorySearch.addEventListener('keyup', filterInventory);
        inventoryCategoryFilter.addEventListener('change', filterInventory);
        inventoryStockFilter.addEventListener('change', filterInventory);
        
        function filterInventory() {
            const searchTerm = inventorySearch.value.toLowerCase();
            const categoryFilter = inventoryCategoryFilter.value;
            const stockFilter = inventoryStockFilter.value;
            
            inventoryList.innerHTML = '';
            
            inventory.forEach(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                     product.sku.toLowerCase().includes(searchTerm) ||
                                     (product.description && product.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                let matchesStock = true;
                if (stockFilter) {
                    if (stockFilter === 'low') {
                        matchesStock = product.quantity > 0 && product.quantity <= product.lowStockThreshold;
                    } else if (stockFilter === 'out') {
                        matchesStock = product.quantity === 0;
                    } else if (stockFilter === 'in') {
                        matchesStock = product.quantity > product.lowStockThreshold;
                    }
                }
                
                if (matchesSearch && matchesCategory && matchesStock) {
                    addProductToUI(product);
                }
            });
            
            updateInventoryTotalValue();
        }
        
        // Product editing and deletion
        window.editProduct = function(productId) {
            const productIndex = inventory.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            const product = inventory[productIndex];
            
            // Populate form with product data
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-sku').value = product.sku;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-quantity').value = product.quantity;
            document.getElementById('product-low-stock').value = product.lowStockThreshold;
            document.getElementById('product-cost').value = product.costPrice;
            document.getElementById('product-price').value = product.sellingPrice;
            document.getElementById('product-supplier').value = product.supplier || '';
            document.getElementById('product-description').value = product.description || '';
            
            // Remove the product from array
            inventory.splice(productIndex, 1);
            
            // Remove from UI
            const productRows = inventoryList.querySelectorAll('tr');
            
            for (let row of productRows) {
                const editBtn = row.querySelector('.fa-edit');
                if (editBtn && editBtn.onclick.toString().includes(productId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update inventory total value
            updateInventoryTotalValue();
            
            // Delete from Firebase
            deleteProductFromFirebase(productId);
            
            showToast('Product loaded for editing', 'info');
        };
        
        window.deleteProduct = function(productId) {
            const productIndex = inventory.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            // Remove the product from array
            inventory.splice(productIndex, 1);
            
            // Remove from UI
            const productRows = inventoryList.querySelectorAll('tr');
            
            for (let row of productRows) {
                const deleteBtn = row.querySelector('.fa-trash');
                if (deleteBtn && deleteBtn.onclick.toString().includes(productId)) {
                    row.remove();
                    break;
                }
            }
            
            // Update inventory total value
            updateInventoryTotalValue();
            
            // Delete from Firebase
            deleteProductFromFirebase(productId);
            
            showToast('Product deleted successfully', 'success');
        };
        
        // PDF Generation
        function setupPdfGeneration(button, listId, title) {
            button.addEventListener('click', function() {
        // ✅ 正确初始化 jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // 检查 autoTable 是否可用
        if (!doc.autoTable) {
            showToast('PDF library not properly loaded. Please refresh the page.', 'error');
            console.error('autoTable is not available:', doc);
            return;
        }
        
        // Add title
        doc.setFontSize(18);
        doc.text(`${title} Report`, 14, 22);
        
        // Add date
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
        
        // Add table
        doc.autoTable({
            startY: 40,
            head: [['Date', 'Bill No', 'Description', 'Quantity', 'Unit Price (RM)', 'Total (RM)']],
            body: getTableData(listId)
        });
                
                // Add grand total
                const rows = document.querySelectorAll(`#${listId} tr`);
                let grandTotal = 0;
                
                rows.forEach(row => {
                    const totalCell = row.cells[5];
                    grandTotal += parseFloat(totalCell.textContent);
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.text(`Grand Total: RM ${grandTotal.toFixed(2)}`, 14, finalY);
                
                // Save the PDF
                doc.save(`${title.toLowerCase()}-report.pdf`);
                
                showToast('PDF generated successfully', 'success');
            });
        }
        
        // Individual PDF Generation (with customer info)
        generateIndividualPdf.addEventListener('click', function() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Individual Bills Report', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add table
            doc.autoTable({
                startY: 40,
                head: [['Date', 'Bill No', 'Description', 'Customer', 'Quantity', 'Unit Price (RM)', 'Total (RM)']],
                body: getIndividualTableData()
            });
            
            // Add grand total
            const rows = document.querySelectorAll('#individual-bills-list tr');
            let grandTotal = 0;
            
            rows.forEach(row => {
                const totalCell = row.cells[6];
                grandTotal += parseFloat(totalCell.textContent);
            });
            
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(`Grand Total: RM ${grandTotal.toFixed(2)}`, 14, finalY);
            
            // Save the PDF
            doc.save('individual-bills-report.pdf');
            
            showToast('PDF generated successfully', 'success');
        });
        
        function getIndividualTableData() {
    const data = [];
    const rows = document.querySelectorAll('#individual-bills-list tr');
    
    rows.forEach(row => {
        // 安全检查：确保行有足够的单元格
        if (row.cells && row.cells.length >= 7) {
            const rowData = [];
            for (let i = 0; i < 7; i++) {
                rowData.push(row.cells[i].textContent || '');
            }
            data.push(rowData);
        }
    });
    
    return data;
}
        
        // Inventory PDF Generation
        generateInventoryPdf.addEventListener('click', function() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Inventory Report', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add table
            doc.autoTable({
                startY: 40,
                head: [['Product Name', 'SKU', 'Category', 'Quantity', 'Cost Price (RM)', 'Selling Price (RM)', 'Stock Value (RM)', 'Status']],
                body: getInventoryTableData()
            });
            
            // Add total value
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(`Total Inventory Value: RM ${inventoryTotalValue.textContent.replace('RM ', '')}`, 14, finalY);
            
            // Save the PDF
            doc.save('inventory-report.pdf');
            
            showToast('Inventory PDF generated successfully', 'success');
        });
        
        function getInventoryTableData() {
            const data = [];
            const rows = inventoryList.querySelectorAll('tr');
            
            rows.forEach(row => {
                const rowData = [];
                for (let i = 0; i < 8; i++) {
                    if (i === 7) {
                        // Get status from span text
                        const statusSpan = row.cells[i].querySelector('.stock-alert');
                        rowData.push(statusSpan ? statusSpan.textContent : '');
                    } else {
                        rowData.push(row.cells[i].textContent);
                    }
                }
                data.push(rowData);
            });
            
            return data;
        }
            
        function getTableData(listId) {
    const data = [];
    const rows = document.querySelectorAll(`#${listId} tr`);
    
    rows.forEach(row => {
        // 安全检查：确保行有足够的单元格
        if (row.cells && row.cells.length >= 6) {
            const rowData = [];
            for (let i = 0; i < 6; i++) {
                rowData.push(row.cells[i].textContent || '');
            }
            data.push(rowData);
        }
    });
    
    return data;
}
        
        // Setup PDF generation for all bill types
        setupPdfGeneration(generatePeriodicPdf, 'periodic-bills-list', 'Periodic Bills');
        setupPdfGeneration(generateMonthlyPdf, 'monthly-bills-list', 'Monthly Bills');
        setupPdfGeneration(generateYearlyPdf, 'yearly-bills-list', 'Yearly Bills');
        
        // CSV Export for Inventory
        exportInventoryCsv.addEventListener('click', function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "Product Name,SKU,Category,Quantity,Cost Price (RM),Selling Price (RM),Stock Value (RM),Status\n";
            
            // Add data
            const rows = inventoryList.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [];
                for (let i = 0; i < 8; i++) {
                    if (i === 7) {
                        // Get status from span text
                        const statusSpan = row.cells[i].querySelector('.stock-alert');
                        rowData.push(statusSpan ? `"${statusSpan.textContent}"` : '');
                    } else {
                        rowData.push(`"${row.cells[i].textContent}"`);
                    }
                }
                csvContent += rowData.join(',') + '\n';
            });
            
            // Add total value
            csvContent += `\nTotal Inventory Value,${inventoryTotalValue.textContent.replace('RM ', '')}`;
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventory_report.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV exported successfully', 'success');
        });
        
        // Profit/Loss Calculation
        profitLossForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const revenue = parseFloat(document.getElementById('revenue').value);
            const expenses = parseFloat(document.getElementById('expenses').value);
            
            if (isNaN(revenue) || isNaN(expenses)) {
                resultText.textContent = 'Please enter valid numbers for revenue and expenses.';
                profitLossResult.className = 'alert alert-danger';
                profitLossResult.style.display = 'block';
                return;
            }
            
            const profitLoss = revenue - expenses;
            
            if (profitLoss > 0) {
                resultText.textContent = `Net Profit: RM ${profitLoss.toFixed(2)}`;
                profitLossResult.className = 'alert alert-success';
            } else if (profitLoss < 0) {
                resultText.textContent = `Net Loss: RM ${Math.abs(profitLoss).toFixed(2)}`;
                profitLossResult.className = 'alert alert-danger';
            } else {
                resultText.textContent = 'Break Even: No profit or loss';
                profitLossResult.className = 'alert alert-info';
            }
            
            profitLossResult.style.display = 'block';
        });
        
        // Customer Form Handling
        customerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('customer-name').value;
            const email = document.getElementById('customer-email').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            
            const customer = {
                id: Date.now().toString(),
                name,
                email,
                phone,
                address,
                createdAt: new Date().toISOString()
            };
            
            // Add to customers array
            customers.push(customer);
            
            // Add to UI
            addCustomerToUI(customer);
            
            // Save to Firebase
            saveCustomerToFirebase(customer);
            
            // Show success message
            showToast('Customer added successfully', 'success');
            
            // Reset form
            customerForm.reset();
        });
        
        function addCustomerToUI(customer) {
            const customerCard = document.createElement('div');
            customerCard.className = 'customer-card';
            customerCard.innerHTML = `
                <h5>${customer.name}</h5>
                <p>Email: ${customer.email || 'N/A'}</p>
                <p>Phone: ${customer.phone || 'N/A'}</p>
                <p>Address: ${customer.address || 'N/A'}</p>
                <div class="customer-actions">
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${customer.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')">Delete</button>
                </div>
            `;
            
            customersList.appendChild(customerCard);
        }
        
        // Bill editing and deletion
        window.editBill = function(billType, billId) {
    const billIndex = bills[billType].findIndex(bill => bill.id === billId);
    if (billIndex === -1) return;
    
    const bill = bills[billType][billIndex];
    
    // Populate form with bill data
    document.getElementById(`${billType}-date`).value = bill.date;
    document.getElementById(`${billType}-billno`).value = bill.billNo;
    document.getElementById(`${billType}-description`).value = bill.description;
    document.getElementById(`${billType}-quantity`).value = bill.quantity;
    document.getElementById(`${billType}-price`).value = bill.price;
    
    // For individual bills, populate customer info
    if (billType === 'individual') {
        document.getElementById('individual-customer-name').value = bill.customerName || '';
        document.getElementById('individual-customer-address').value = bill.customerAddress || '';
    }
    
    // Remove the bill from array
    bills[billType].splice(billIndex, 1);
    
    // ✅ 使用统一渲染函数重新渲染
    renderBillsByType(billType);
    
    // Update grand total
    if (billType === 'periodic') updatePeriodicTotal();
    if (billType === 'individual') updateIndividualTotal();
    if (billType === 'monthly') updateMonthlyTotal();
    if (billType === 'yearly') updateYearlyTotal();
    
    // Delete from Firebase
    deleteBillFromFirebase(billId);
    
    showToast('Bill loaded for editing', 'info');
};

window.deleteBill = function(billType, billId) {
    const billIndex = bills[billType].findIndex(bill => bill.id === billId);
    if (billIndex === -1) return;
    
    if (!confirm('Are you sure you want to delete this bill?')) return;
    
    // Remove the bill from array
    bills[billType].splice(billIndex, 1);
    
    // ✅ 使用统一渲染函数重新渲染
    renderBillsByType(billType);
    
    // ⭐ 安全地更新总计
    try {
        if (billType === 'periodic') updatePeriodicTotal();
        if (billType === 'individual') updateIndividualTotal();
        if (billType === 'monthly') updateMonthlyTotal();
        if (billType === 'yearly') updateYearlyTotal();
    } catch (error) {
        console.warn('Error updating total:', error);
        updateGrandTotalFromArray(billType);
    }
    
    // Delete from Firebase
    deleteBillFromFirebase(billId);
    
    showToast('Bill deleted successfully', 'success');
};
        
        // Customer management functions
        window.editCustomer = function(customerId) {
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            const customer = customers[customerIndex];
            
            // Populate form with customer data
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-email').value = customer.email || '';
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-address').value = customer.address || '';
            
            // Remove the customer from array
            customers.splice(customerIndex, 1);
            
            // Remove from UI
            const customerCards = customersList.querySelectorAll('.customer-card');
            
            for (let card of customerCards) {
                const editBtn = card.querySelector('button.btn-primary');
                if (editBtn && editBtn.onclick.toString().includes(customerId)) {
                    card.remove();
                    break;
                }
            }
            
            // Delete from Firebase
            deleteCustomerFromFirebase(customerId);
            
            showToast('Customer loaded for editing', 'info');
        };
        
        window.deleteCustomer = function(customerId) {
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            // Remove the customer from array
            customers.splice(customerIndex, 1);
            
            // Remove from UI
            const customerCards = customersList.querySelectorAll('.customer-card');
            
            for (let card of customerCards) {
                const deleteBtn = card.querySelector('button.btn-danger');
                if (deleteBtn && deleteBtn.onclick.toString().includes(customerId)) {
                    card.remove();
                    break;
                }
            }
            
            // Delete from Firebase
            deleteCustomerFromFirebase(customerId);
            
            showToast('Customer deleted successfully', 'success');
        };
        
        // Firebase functions
        function saveBillToFirebase(bill) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('bills').doc(bill.id).set(bill)
                .catch(error => {
                    console.error("Error saving bill: ", error);
                    showToast('Error saving bill. Please try again.', 'error');
                });
        }
        
        function deleteBillFromFirebase(billId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('bills').doc(billId).delete()
                .catch(error => {
                    console.error("Error deleting bill: ", error);
                    showToast('Error deleting bill. Please try again.', 'error');
                });
        }
        
        function saveCustomerToFirebase(customer) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('customers').doc(customer.id).set(customer)
                .catch(error => {
                    console.error("Error saving customer: ", error);
                    showToast('Error saving customer. Please try again.', 'error');
                });
        }
        
        function deleteCustomerFromFirebase(customerId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('customers').doc(customerId).delete()
                .catch(error => {
                    console.error("Error deleting customer: ", error);
                    showToast('Error deleting customer. Please try again.', 'error');
                });
        }
        
        function saveProductToFirebase(product) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('inventory').doc(product.id).set(product)
                .catch(error => {
                    console.error("Error saving product: ", error);
                    showToast('Error saving product. Please try again.', 'error');
                });
        }
        
        function deleteProductFromFirebase(productId) {
            if (!auth.currentUser) return;
            
            db.collection('users').doc(auth.currentUser.uid).collection('inventory').doc(productId).delete()
                .catch(error => {
                    console.error("Error deleting product: ", error);
                    showToast('Error deleting product. Please try again.', 'error');
                });
        }
        // 统一渲染函数
function renderBillsByType(type) {
    const billList = document.getElementById(`${type}-bills-list`);
    if (!billList) return;
    
    // 清空表格
    billList.innerHTML = '';
    
    // 检查是否有数据
    if (!bills[type] || bills[type].length === 0) {
        const colSpan = type === 'individual' ? 8 : 7;
        billList.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center text-muted">
                    No bills yet. Add your first bill above.
                </td>
            </tr>
        `;
        return;
    }
    
    // 重新渲染所有账单
    bills[type].forEach(bill => {
        let newRow;
        if (type === 'individual') {
            newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${bill.date || ''}</td>
                <td>${bill.billNo || ''}</td>
                <td>${bill.description || ''}</td>
                <td>${bill.customerName || 'N/A'}</td>
                <td>${bill.quantity || 0}</td>
                <td>${(bill.price || 0).toFixed(2)}</td>
                <td>${(bill.total || 0).toFixed(2)}</td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                </td>
            `;
        } else {
            newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${bill.date || ''}</td>
                <td>${bill.billNo || ''}</td>
                <td>${bill.description || ''}</td>
                <td>${bill.quantity || 0}</td>
                <td>${(bill.price || 0).toFixed(2)}</td>
                <td>${(bill.total || 0).toFixed(2)}</td>
                <td>
                    <i class="fas fa-edit action-btn text-primary" onclick="editBill('${type}', '${bill.id}')"></i>
                    <i class="fas fa-trash action-btn text-danger" onclick="deleteBill('${type}', '${bill.id}')"></i>
                </td>
            `;
        }
        
        billList.appendChild(newRow);
    });
}
            
        function loadUserData() {
    if (!auth.currentUser) return;
    
    // Load bills
    db.collection('users').doc(auth.currentUser.uid).collection('bills').get()
        .then(querySnapshot => {
            bills = {
                periodic: [],
                individual: [],
                monthly: [],
                yearly: []
            };
            
            querySnapshot.forEach(doc => {
                try {
                    const bill = doc.data();
                    if (bill && bill.type && bill.id) {
                        bills[bill.type].push(bill);
                    }
                } catch (error) {
                    console.warn('Error processing bill:', error);
                }
            });
            
            // 使用统一渲染函数
            ['periodic', 'individual', 'monthly', 'yearly'].forEach(type => {
                renderBillsByType(type);
            });
            
            // 安全地更新总计
            setTimeout(() => {
                try {
                    if (typeof updatePeriodicTotal === 'function') updatePeriodicTotal();
                    if (typeof updateIndividualTotal === 'function') updateIndividualTotal();
                    if (typeof updateMonthlyTotal === 'function') updateMonthlyTotal();
                    if (typeof updateYearlyTotal === 'function') updateYearlyTotal();
                } catch (error) {
                    console.warn('Error updating totals:', error);
                }
            }, 100);
            
            // 更新仪表板
            updateDashboard();
            updateProgressView();
        })
        .catch(error => {
            console.error("Error loading bills: ", error);
            showToast('Error loading bills data.', 'error');
        });
            
            // Load customers
            db.collection('users').doc(auth.currentUser.uid).collection('customers').get()
                .then(querySnapshot => {
                    customers = [];
                    customersList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const customer = doc.data();
                        customers.push(customer);
                        
                        // Add to UI
                        addCustomerToUI(customer);
                    });
                })
                .catch(error => {
                    console.error("Error loading customers: ", error);
                    showToast('Error loading customers data.', 'error');
                });
                
            // Load inventory
            db.collection('users').doc(auth.currentUser.uid).collection('inventory').get()
                .then(querySnapshot => {
                    inventory = [];
                    inventoryList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const product = doc.data();
                        inventory.push(product);
                        
                        // Add to UI
                        addProductToUI(product);
                    });
                    
                    // Update inventory total value
                    updateInventoryTotalValue();
                    
                    // Update dashboard
                    updateDashboard();
                })
                .catch(error => {
                    console.error("Error loading inventory: ", error);
                    showToast('Error loading inventory data.', 'error');
                });
                
            // Load breakdown data
            loadBreakdownData();
            
            // Load progress data
            loadProgressData();
        }

            function updateGrandTotalFromArray(type) {
    let total = 0;
    
    if (bills[type] && bills[type].length > 0) {
        bills[type].forEach(bill => {
            total += bill.total || 0;
        });
    }
    
    const grandTotalElement = document.getElementById(`${type}-grand-total`);
    if (grandTotalElement) {
        grandTotalElement.textContent = `RM ${total.toFixed(2)}`;
    }
}
        // Dashboard functions
        function updateDashboard() {
            // Calculate totals from all bills
            let revenue = 0;
            let expenses = 0;
            
            for (const type in bills) {
                bills[type].forEach(bill => {
                    revenue += bill.total;
                });
            }
            
            // For demo purposes, let's assume expenses are 70% of revenue
            expenses = revenue * 0.7;
            const profit = revenue - expenses;
            
            // Update UI
            totalRevenue.textContent = `RM ${revenue.toFixed(2)}`;
            totalExpenses.textContent = `RM ${expenses.toFixed(2)}`;
            netProfit.textContent = `RM ${profit.toFixed(2)}`;
            
            // Update inventory value
            updateInventoryTotalValue();
            
            // Update recent bills
            updateRecentBills();
            
            // Update low stock alerts
            updateLowStockAlerts();
        }
        
        function updateRecentBills() {
            recentBills.innerHTML = '';
            
            // Get all bills and sort by date (newest first)
            const allBills = [];
            for (const type in bills) {
                allBills.push(...bills[type]);
            }
            
            allBills.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only the 5 most recent bills
            const recent = allBills.slice(0, 5);
            
            recent.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.date}</td>
                    <td>${bill.billNo}</td>
                    <td>${bill.total.toFixed(2)}</td>
                `;
                recentBills.appendChild(row);
            });
        }
        
        function updateLowStockAlerts() {
            lowStockAlerts.innerHTML = '';
            
            // Get low stock and out of stock items
            const lowStockItems = inventory.filter(product => 
                product.quantity > 0 && product.quantity <= product.lowStockThreshold
            );
            
            const outOfStockItems = inventory.filter(product => 
                product.quantity === 0
            );
            
            // Show alerts
            if (outOfStockItems.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.innerHTML = `<strong>${outOfStockItems.length} products are out of stock!</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            if (lowStockItems.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning';
                alert.innerHTML = `<strong>${lowStockItems.length} products are low on stock!</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            if (lowStockItems.length === 0 && outOfStockItems.length === 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `<strong>All products are in stock.</strong>`;
                lowStockAlerts.appendChild(alert);
            }
            
            // Show detailed list
            const detailList = document.createElement('ul');
            detailList.className = 'list-group mt-3';
            
            outOfStockItems.forEach(product => {
                const item = document.createElement('li');
                item.className = 'list-group-item list-group-item-danger';
                item.textContent = `${product.name} - Out of Stock`;
                detailList.appendChild(item);
            });
            
            lowStockItems.forEach(product => {
                const item = document.createElement('li');
                item.className = 'list-group-item list-group-item-warning';
                item.textContent = `${product.name} - Low Stock (${product.quantity} left)`;
                detailList.appendChild(item);
            });
            
            if (outOfStockItems.length > 0 || lowStockItems.length > 0) {
                lowStockAlerts.appendChild(detailList);
            }
        }
        
        function updateProfitLoss() {
            // Calculate totals from all bills
            let revenue = 0;
            
            for (const type in bills) {
                bills[type].forEach(bill => {
                    revenue += bill.total;
                });
            }
            
            // For demo purposes, let's assume expenses are 70% of revenue
            const expenses = revenue * 0.7;
            const profit = revenue - expenses;
            
            // Update UI
            plRevenue.textContent = `RM ${revenue.toFixed(2)}`;
            plExpenses.textContent = `RM ${expenses.toFixed(2)}`;
            revenueComparison.textContent = `Last month: RM ${(revenue * 0.9).toFixed(2)}`;
            expensesComparison.textContent = `Last month: RM ${(expenses * 0.9).toFixed(2)}`;
            
            // Update breakdown
            updatePLBreakdown(revenue, expenses);
        }
        
        function updatePLBreakdown(revenue, expenses) {
            // This function is now handled by the editable breakdown system
        }
        
        // Authentication functions
        loginBtn.addEventListener('click', function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (email && password) {
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in
                        authContainer.style.display = 'none';
                        mainContainer.style.display = 'block';
                        loadUserData();
                        showToast('Login successful!', 'success');
                    })
                    .catch((error) => {
                        loginError.style.display = 'block';
                        console.error("Login error: ", error);
                        showToast('Login failed. Please check your credentials.', 'error');
                    });
            } else {
                loginError.style.display = 'block';
                showToast('Please enter both email and password.', 'error');
            }
        });
        
        googleLoginBtn.addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Signed in
                    authContainer.style.display = 'none';
                    mainContainer.style.display = 'block';
                    loadUserData();
                    showToast('Google login successful!', 'success');
                })
                .catch((error) => {
                    console.error("Google sign-in error: ", error);
                    showToast('Google sign-in failed. Please try again.', 'error');
                });
        });
        
        // Register functionality
        registerBtn.addEventListener('click', function() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                registerError.style.display = 'block';
                showToast('Passwords do not match.', 'error');
                return;
            }
            
            if (email && password) {
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential)=> {
                        // Signed up
                        registerError.style.display = 'none';
                        showToast('Registration successful! You can now login.', 'success');
                        showLogin.click();
                    })
                    .catch((error) => {
                        registerError.style.display = 'block';
                        console.error("Registration error: ", error);
                        showToast('Registration failed. Please try again.', 'error');
                    });
            } else {
                registerError.style.display = 'block';
                showToast('Please fill all required fields.', 'error');
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                
                // Clear all data from UI
                document.getElementById('periodic-bills-list').innerHTML = '';
                document.getElementById('individual-bills-list').innerHTML = '';
                document.getElementById('monthly-bills-list').innerHTML = '';
                document.getElementById('yearly-bills-list').innerHTML = '';
                document.getElementById('customers-list').innerHTML = '';
                document.getElementById('inventory-list').innerHTML = '';
                document.getElementById('pl-breakdown').innerHTML = '';
                document.getElementById('progress-bills-list').innerHTML = '';
                
                // Reset data
                bills = {
                    periodic: [],
                    individual: [],
                    monthly: [],
                    yearly: []
                };
                
                // Reset customers data
                customers = [];
                
                // Reset inventory data
                inventory = [];
                
                // Reset breakdown data
                breakdownData = [];
                
                // Reset progress data
                progressUpdates = {};
                
                // Reset bill addresses
                billAddresses = {};
                
                showToast('Logged out successfully', 'info');
            });
        });
        
       function initCharts() {
    // 销毁旧图表实例
    if (performanceChartInstance) {
        performanceChartInstance.destroy();
        performanceChartInstance = null;
    }
    
    if (profitLossChartInstance) {
        profitLossChartInstance.destroy();
        profitLossChartInstance = null;
    }
    
    // 性能图表
    const perfCtx = document.getElementById('performanceChart');
    if (perfCtx) {
        performanceChartInstance = new Chart(perfCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Revenue',
                    data: monthlyData.revenue,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            callback: function(value) {
                                return 'RM ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 利润/损失图表
    const plCtx = document.getElementById('profitLossChart');
    if (plCtx) {
        profitLossChartInstance = new Chart(plCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: monthlyData.revenue,
                        backgroundColor: '#27ae60',
                        borderColor: '#27ae60',
                        borderWidth: 1
                    },
                    {
                        label: 'Expenses',
                        data: monthlyData.expenses,
                        backgroundColor: '#e74c3c',
                        borderColor: '#e74c3c',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                            callback: function(value) {
                                return 'RM ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
}

// 添加图表主题更新功能
function updateChartsTheme() {
    // 重新初始化图表以应用新主题
    if (window.myPerformanceChart) window.myPerformanceChart.destroy();
    if (window.myProfitLossChart) window.myProfitLossChart.destroy();
    initCharts();
}

// 在主题切换时调用
document.getElementById('theme-toggle').addEventListener('click', function() {
    setTimeout(updateChartsTheme, 300);
});
        
        // Set today's date as default for all date inputs
        function setDefaultDates() {
            document.querySelectorAll('input[type="date"]').forEach(input => {
                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();
                
                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;
                
                const formattedToday = `${yyyy}-${mm}-${dd}`;
                input.value = formattedToday;
            });
        }
        
        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                authContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                loadUserData();
            }
        });
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            initCharts();
            initBreakdown();
            initProgressTracking();
            initThemeToggle();
            initResponsiveDesign();
        });

        // 响应式设计功能
function initResponsiveDesign() {
    // 检测设备类型并调整布局
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth <= 992;
    
    if (isMobile) {
        // 移动设备优化
        optimizeForMobile();
    } else if (isTablet) {
        // 平板设备优化
        optimizeForTablet();
    } else {
        // 桌面设备优化
        optimizeForDesktop();
    }
    
    // 监听窗口大小变化
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(initResponsiveDesign, 250);
    });
}

function optimizeForMobile() {
    // 调整表格为滚动视图
    document.querySelectorAll('.bill-table').forEach(table => {
        table.parentElement.classList.add('table-responsive');
    });
    
    // 调整表单布局
    document.querySelectorAll('.row .col-md-3, .row .col-md-4, .row .col-md-6').forEach(col => {
        col.classList.add('col-12');
        col.classList.remove('col-md-3', 'col-md-4', 'col-md-6');
    });
    
    // 调整按钮大小
    document.querySelectorAll('button, .btn').forEach(btn => {
        if (!btn.classList.contains('btn-sm')) {
            btn.classList.add('btn-sm');
        }
    });
    
    // 调整字体大小
    document.querySelectorAll('h1, h2, h3, h4, h5').forEach(heading => {
        const currentSize = parseInt(window.getComputedStyle(heading).fontSize);
        heading.style.fontSize = (currentSize * 0.9) + 'px';
    });
}

function optimizeForTablet() {
    // 平板设备调整
    document.querySelectorAll('.row .col-md-3').forEach(col => {
        col.classList.add('col-6');
    });
    
    document.querySelectorAll('.row .col-md-4').forEach(col => {
        col.classList.add('col-6');
    });
    
    document.querySelectorAll('.row .col-md-6').forEach(col => {
        col.classList.add('col-12');
    });
}

function optimizeForDesktop() {
    // 桌面设备恢复原始布局
    document.querySelectorAll('.table-responsive').forEach(table => {
        table.parentElement.classList.remove('table-responsive');
    });
}

        // 主题切换功能
function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');
    
    // 检查本地存储的主题偏好
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
        
        showToast(`切换至${newTheme === 'dark' ? '深色' : '浅色'}模式`, 'success');
    });
    
    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            themeIcon.className = 'fas fa-sun';
        } else {
            themeIcon.className = 'fas fa-moon';
        }
    }
}
    
</script>
</body>
    <footer style="text-align:center; padding: 10px; margin-top:20px; color:#666; font-size:14px;">
    Developed by Tan Jun Yuan
</footer>

</html>
